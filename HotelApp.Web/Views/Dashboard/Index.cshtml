@using HotelApp.Web.Models
@{
    ViewData["Title"] = "Dashboard";
    var displayName = User.Claims.FirstOrDefault(c => c.Type == "displayName")?.Value ?? User.Identity?.Name ?? "User";
    var statistics = ViewBag.Statistics as DashboardStatistics;
    var revenueData = ViewBag.RevenueData as IEnumerable<RevenueData>;
    var roomTypeDistribution = ViewBag.RoomTypeDistribution as IEnumerable<RoomTypeDistribution>;
    var recentBookings = ViewBag.RecentBookings as IEnumerable<RecentBooking>;
}

<div class="main-content">
    <div class="top-bar">
        <div class="page-title">
            <h1>Dashboard Overview</h1>
            <p>Welcome back, @displayName! Here's what's happening today.</p>
        </div>
        <div class="user-info">
            <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User Profile">
            <div class="user-details">
                <div class="user-name">@displayName</div>
                <div class="user-role">Hotel Manager</div>
            </div>
        </div>
    </div>

    <div class="dashboard-cards">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Total Guests</div>
                <div class="card-icon" style="background-color: var(--primary);">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="card-value">@(statistics?.TotalGuests.ToString("N0") ?? "0")</div>
            <div class="card-change @(statistics?.GuestsChangePercent >= 0 ? "positive" : "negative")">
                <i class="fas fa-arrow-@(statistics?.GuestsChangePercent >= 0 ? "up" : "down")"></i> 
                @Math.Abs(statistics?.GuestsChangePercent ?? 0)% from last month
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Occupancy Rate</div>
                <div class="card-icon" style="background-color: var(--secondary);">
                    <i class="fas fa-bed"></i>
                </div>
            </div>
            <div class="card-value">@(statistics?.OccupancyRate.ToString("N0") ?? "0")%</div>
            <div class="card-change @(statistics?.OccupancyChangePercent >= 0 ? "positive" : "negative")">
                <i class="fas fa-arrow-@(statistics?.OccupancyChangePercent >= 0 ? "up" : "down")"></i> 
                @Math.Abs(statistics?.OccupancyChangePercent ?? 0)% from last week
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Revenue</div>
                <div class="card-icon" style="background-color: var(--accent);">
                    <i class="fas fa-rupee-sign"></i>
                </div>
            </div>
            <div class="card-value">₹@(statistics?.Revenue.ToString("N0") ?? "0")</div>
            <div class="card-change @(statistics?.RevenueChangePercent >= 0 ? "positive" : "negative")">
                <i class="fas fa-arrow-@(statistics?.RevenueChangePercent >= 0 ? "up" : "down")"></i> 
                @Math.Abs(statistics?.RevenueChangePercent ?? 0)% from last month
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Check-ins Today</div>
                <div class="card-icon" style="background-color: var(--success);">
                    <i class="fas fa-door-open"></i>
                </div>
            </div>
            <div class="card-value">@(statistics?.CheckInsToday ?? 0)</div>
            <div class="card-change @(statistics?.CheckInsChange >= 0 ? "positive" : "negative")">
                <i class="fas fa-arrow-@(statistics?.CheckInsChange >= 0 ? "up" : "down")"></i> 
                @Math.Abs(statistics?.CheckInsChange ?? 0) from yesterday
            </div>
        </div>
    </div>

    <div class="charts-section">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Revenue Overview</div>
                <div>
                    <select class="chart-filter" id="revenuePeriodFilter" onchange="updateRevenueChart(this.value)">
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Room Types</div>
            </div>
            <div class="chart-container">
                <canvas id="roomTypeChart"></canvas>
            </div>
        </div>
    </div>

    <div class="recent-bookings">
        <div class="section-header">
            <div class="section-title">Today's Checkouts</div>
            <a href="@Url.Action("Index", "Booking")" class="view-all">View All</a>
        </div>

        <table class="bookings-table">
            <thead>
                <tr>
                    <th>Booking #</th>
                    <th>Guest Name</th>
                    <th>Room Type</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>Rooms</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @if (recentBookings != null && recentBookings.Any())
                {
                    foreach (var booking in recentBookings)
                    {
                        <tr>
                            <td>@booking.BookingNumber</td>
                            <td>@booking.GuestName</td>
                            <td>@booking.RoomType</td>
                            <td>@booking.CheckInDate.ToString("MMM dd, yyyy")</td>
                            <td>@booking.CheckOutDate.ToString("MMM dd, yyyy")</td>
                            <td>@booking.RequiredRooms</td>
                            <td>₹@booking.TotalAmount.ToString("N2")</td>
                            <td>
                                <span class="status @booking.Status.ToLower()">@booking.Status</span>
                            </td>
                            <td>
                                <a href="@Url.Action("Details", "Booking", new { bookingNumber = booking.BookingNumber })" class="action-btn">Details</a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 20px;">No recent bookings found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let revenueChart;
        let roomTypeChart;
        
        const revenueData = @Html.Raw(Json.Serialize(revenueData));
        const roomTypeData = @Html.Raw(Json.Serialize(roomTypeDistribution));

        document.addEventListener('DOMContentLoaded', function () {
            initializeRevenueChart(revenueData);
            initializeRoomTypeChart(roomTypeData);
        });

        function initializeRevenueChart(data) {
            const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
            if (!revenueCtx) return;

            const labels = data.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const values = data.map(d => d.revenue);

            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: values,
                        borderColor: '#1a2a6c',
                        backgroundColor: 'rgba(26, 42, 108, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '₹' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { drawBorder: false },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function initializeRoomTypeChart(data) {
            const roomTypeCtx = document.getElementById('roomTypeChart')?.getContext('2d');
            if (!roomTypeCtx) return;

            const labels = data.map(d => d.typeName);
            const values = data.map(d => d.bookingCount);
            const colors = ['#1a2a6c', '#b21f1f', '#fdbb2d', '#28a745', '#17a2b8', '#6c757d'];

            if (roomTypeChart) {
                roomTypeChart.destroy();
            }

            roomTypeChart = new Chart(roomTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function updateRevenueChart(days) {
            try {
                const response = await fetch(`@Url.Action("GetRevenueData", "Dashboard")?days=${days}`);
                const data = await response.json();
                initializeRevenueChart(data);
            } catch (error) {
                console.error('Error updating revenue chart:', error);
            }
        }
    </script>
}
