@model HotelApp.Web.ViewModels.UserCreateViewModel

@{
    ViewData["Title"] = "Create User";
}

@section Styles {
<style>

    .uc-container { background:white; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); padding:30px 44px; max-width:97%; margin:0 auto; }
    .uc-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:28px; padding-bottom:18px; border-bottom:2px solid #f0f0f0; }
    .uc-header h3 { margin:0; color:var(--primary); font-size:22px; font-weight:600; }
    .uc-section { margin-bottom:28px; }
    .uc-section-title { font-size:15px; font-weight:600; color:#333; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
    .uc-section-title i { color:var(--primary); }
    .uc-grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:18px 22px; }
    .uc-grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:18px 22px; }
    @@media (max-width:1100px) { .uc-grid-4 { grid-template-columns:repeat(2,1fr); } .uc-grid-3 { grid-template-columns:repeat(2,1fr); } }
    @@media (max-width:700px)  { .uc-grid-4,.uc-grid-3 { grid-template-columns:1fr; } .uc-container { padding:18px; } }
    .uc-field { display:flex; flex-direction:column; }
    .uc-field label { font-weight:500; margin-bottom:7px; color:#333; font-size:13.5px; }
    .uc-field input[type="text"],.uc-field input[type="email"],.uc-field input[type="password"],.uc-field input[type="tel"] { padding:11px 14px; border:1px solid #ddd; border-radius:8px; font-size:14px; transition:border-color .2s,box-shadow .2s; }
    .uc-field input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(26,42,108,.1); }
    .input-icon-wrap { position:relative; }
    .input-icon-wrap i { position:absolute; left:13px; top:50%; transform:translateY(-50%); color:#999; font-size:14px; }
    .input-icon-wrap input { padding-left:36px !important; width:100%; box-sizing:border-box; }
    /* Multi-select dropdown */
    .bwr-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @@media (max-width:700px) { .bwr-grid { grid-template-columns:1fr; } }
    .msd-wrap { position:relative; }
    .msd-trigger { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 14px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; user-select:none; font-size:14px; color:#333; min-height:44px; transition:border-color .2s,box-shadow .2s; }
    .msd-trigger:hover { border-color:var(--primary); }
    .msd-trigger.open { border-color:var(--primary); box-shadow:0 0 0 3px rgba(26,42,108,.1); }
    .msd-trigger .msd-arrow { font-size:11px; color:#777; transition:transform .2s; flex-shrink:0; }
    .msd-trigger.open .msd-arrow { transform:rotate(180deg); }
    .msd-trigger .msd-text { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#888; }
    .msd-trigger .msd-text.has-val { color:#222; }
    .msd-panel { display:none; position:absolute; top:calc(100% + 4px); left:0; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 18px rgba(0,0,0,.13); z-index:300; min-width:220px; max-height:280px; overflow-y:auto; }
    .msd-panel.open { display:block; }
    .msd-item { display:flex; align-items:center; gap:10px; padding:9px 14px; cursor:pointer; transition:background .12s; font-size:13.5px; }
    .msd-item:hover { background:#f4f6ff; }
    .msd-item input[type="checkbox"] { width:15px; height:15px; accent-color:var(--primary); cursor:pointer; flex-shrink:0; }
    .msd-item label { cursor:pointer; flex:1; margin:0; font-weight:400; color:#333; }
    .msd-group-hdr { display:flex; align-items:center; justify-content:space-between; padding:9px 14px 7px; font-size:11.5px; font-weight:700; color:var(--primary); text-transform:uppercase; letter-spacing:.6px; background:#f8f9ff; border-top:1px solid #eef0f8; position:sticky; top:0; cursor:pointer; user-select:none; }
    .msd-group-hdr:first-child { border-top:none; }
    .msd-group-hdr .msd-grp-arrow { font-size:11px; color:var(--primary); transition:transform .2s; }
    .msd-group-hdr.collapsed .msd-grp-arrow { transform:rotate(-90deg); }
    .msd-roles-body { overflow:hidden; }
    .msd-roles-body.collapsed { display:none; }
    .msd-empty { padding:16px 14px; color:#aaa; font-size:13px; text-align:center; }
    .bwr-error { color:#dc3545; font-size:12px; margin-top:6px; display:none; }
    .uc-actions { display:flex; gap:14px; justify-content:flex-end; padding-top:24px; border-top:2px solid #f0f0f0; }
    .uc-actions .btn-save,.uc-actions .btn-cancel { padding:11px 28px; font-size:14px; font-weight:600; border-radius:8px; }
    .field-error { color:#dc3545; font-size:12px; margin-top:4px; }
</style>
}

<div class="page-header">
    <h2><i class="fas fa-users-cog"></i> User Management</h2>
</div>

<div class="uc-container">
    <div class="uc-header">
        <h3><i class="fas fa-user-plus"></i> Add New User</h3>
    </div>

    <form asp-action="Create" method="post" id="createUserForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="field-error" style="margin-bottom:12px;"></div>
        <input type="hidden" name="BranchRolesJson" id="BranchRolesJson" value="{}" />

        <!-- Basic Information -->
        <div class="uc-section">
            <div class="uc-section-title"><i class="fas fa-info-circle"></i> Basic Information</div>
            <div class="uc-grid-4">
                <div class="uc-field">
                    <label asp-for="Username">Username <span class="text-danger">*</span></label>
                    <input asp-for="Username" type="text" placeholder="Enter username" required />
                    <span asp-validation-for="Username" class="field-error"></span>
                </div>
                <div class="uc-field">
                    <label asp-for="Email">Email <span class="text-danger">*</span></label>
                    <input asp-for="Email" type="email" placeholder="user@example.com" required />
                    <span asp-validation-for="Email" class="field-error"></span>
                </div>
                <div class="uc-field">
                    <label asp-for="FirstName">First Name <span class="text-danger">*</span></label>
                    <input asp-for="FirstName" type="text" placeholder="First name" required />
                    <span asp-validation-for="FirstName" class="field-error"></span>
                </div>
                <div class="uc-field">
                    <label asp-for="LastName">Last Name <span class="text-danger">*</span></label>
                    <input asp-for="LastName" type="text" placeholder="Last name" required />
                    <span asp-validation-for="LastName" class="field-error"></span>
                </div>
            </div>
        </div>

        <!-- Password & Security -->
        <div class="uc-section">
            <div class="uc-section-title"><i class="fas fa-lock"></i> Password &amp; Security</div>
            <div class="uc-grid-3">
                <div class="uc-field">
                    <label asp-for="Password">Password <span class="text-danger">*</span></label>
                    <input asp-for="Password" type="password" placeholder="Enter password" required />
                    <span asp-validation-for="Password" class="field-error"></span>
                </div>
                <div class="uc-field">
                    <label asp-for="ConfirmPassword">Confirm Password <span class="text-danger">*</span></label>
                    <input asp-for="ConfirmPassword" type="password" placeholder="Re-enter password" required />
                    <span asp-validation-for="ConfirmPassword" class="field-error"></span>
                </div>
                <div class="uc-field">
                    <label asp-for="PhoneNumber">Phone Number</label>
                    <div class="input-icon-wrap">
                        <i class="fas fa-phone"></i>
                        <input asp-for="PhoneNumber" type="tel" placeholder="Enter phone number" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch Access & Roles -->
        <div class="uc-section">
            <div class="uc-section-title"><i class="fas fa-building"></i> Branch Access &amp; Roles <span class="text-danger">*</span></div>
            <div class="bwr-grid">
                <div class="uc-field">
                    <label>Branch Access <span class="text-danger">*</span></label>
                    <div class="msd-wrap">
                        <div class="msd-trigger" id="branchTrigger">
                            <span class="msd-text">Select branches&hellip;</span>
                            <span class="msd-arrow"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="msd-panel" id="branchPanel"></div>
                    </div>
                </div>
                <div class="uc-field">
                    <label>Branch-wise Roles <span class="text-danger">*</span></label>
                    <div class="msd-wrap">
                        <div class="msd-trigger" id="rolesTrigger">
                            <span class="msd-text">Select branch-wise roles&hellip;</span>
                            <span class="msd-arrow"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="msd-panel" id="rolesPanel">
                            <div class="msd-empty">Select branches first.</div>
                        </div>
                    </div>
                    <span id="braError" class="bwr-error">Please select at least one branch and assign at least one role per selected branch.</span>
                </div>
            </div>
        </div>

        <div class="uc-actions">
            <a asp-action="Index" class="btn-cancel"><i class="fas fa-times"></i> Cancel</a>
            <button type="submit" class="btn-save"><i class="fas fa-save"></i> Save User</button>
        </div>
    </form>
</div>

@section Scripts {
@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script>
var braAllBranches = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    Model.AvailableBranches.Select(b => new { id = b.BranchID, name = b.BranchName, code = b.BranchCode })
));
var braAllRoles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    Model.AvailableRoles.Select(r => new { id = r.Id, name = r.Name })
));
var braSelectedBranches = new Set();
var braState = {};

function buildBranchDropdown() {
    var panel = document.getElementById('branchPanel');
    panel.innerHTML = '';
    if (!braAllBranches.length) { panel.innerHTML = '<div class="msd-empty">No branches available.</div>'; return; }
    braAllBranches.forEach(function(b) {
        var item = document.createElement('div'); item.className = 'msd-item';
        var chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = 'bchk-' + b.id; chk.checked = braSelectedBranches.has(b.id);
        chk.addEventListener('change', function() {
            if (this.checked) { braSelectedBranches.add(b.id); }
            else { braSelectedBranches.delete(b.id); delete braState[String(b.id)]; }
            updateBranchTrigger(); buildRolesDropdown(); braSyncJson();
        });
        var lbl = document.createElement('label'); lbl.htmlFor = 'bchk-' + b.id;
        lbl.textContent = b.code + ' – ' + b.name;
        item.appendChild(chk); item.appendChild(lbl); panel.appendChild(item);
    });
}

function updateBranchTrigger() {
    var txt = document.querySelector('#branchTrigger .msd-text');
    var arr = braAllBranches.filter(function(b){ return braSelectedBranches.has(b.id); });
    if (arr.length) { txt.textContent = arr.map(function(b){ return b.code + ' – ' + b.name; }).join(', '); txt.classList.add('has-val'); }
    else { txt.textContent = 'Select branches…'; txt.classList.remove('has-val'); }
}

function buildRolesDropdown() {
    var panel = document.getElementById('rolesPanel'); panel.innerHTML = '';
    var active = braAllBranches.filter(function(b){ return braSelectedBranches.has(b.id); });
    if (!active.length) { panel.innerHTML = '<div class="msd-empty">Select branches first.</div>'; updateRolesTrigger(); return; }
    active.forEach(function(branch) {
        var bid = String(branch.id);
        if (!braState[bid]) braState[bid] = new Set();
        var grp = document.createElement('div'); grp.className = 'msd-group-hdr';
        var grpTxt = document.createElement('span'); grpTxt.textContent = branch.code + ' – ' + branch.name;
        var grpArrow = document.createElement('span'); grpArrow.className = 'msd-grp-arrow'; grpArrow.innerHTML = '<i class="fas fa-chevron-down"></i>';
        grp.appendChild(grpTxt); grp.appendChild(grpArrow); panel.appendChild(grp);
        var body = document.createElement('div'); body.className = 'msd-roles-body'; body.id = 'msd-body-' + bid;
        grp.addEventListener('click', function(e) {
            e.stopPropagation();
            var isCollapsed = body.classList.toggle('collapsed');
            grp.classList.toggle('collapsed', isCollapsed);
        });
        braAllRoles.forEach(function(role) {
            var item = document.createElement('div'); item.className = 'msd-item';
            var chk = document.createElement('input'); chk.type = 'checkbox';
            chk.id = 'rchk-' + bid + '-' + role.id; chk.checked = braState[bid].has(role.id);
            chk.addEventListener('change', function() {
                if (this.checked) braState[bid].add(role.id);
                else braState[bid].delete(role.id);
                updateRolesTrigger(); braSyncJson();
            });
            var lbl = document.createElement('label'); lbl.htmlFor = 'rchk-' + bid + '-' + role.id; lbl.textContent = role.name;
            item.appendChild(chk); item.appendChild(lbl); body.appendChild(item);
        });
        panel.appendChild(body);
    });
    updateRolesTrigger();
}

function updateRolesTrigger() {
    var txt = document.querySelector('#rolesTrigger .msd-text');
    var total = 0;
    Object.keys(braState).forEach(function(bid){ if (braSelectedBranches.has(Number(bid))) total += braState[bid].size; });
    if (total > 0) { txt.textContent = total + ' role' + (total !== 1 ? 's' : '') + ' assigned'; txt.classList.add('has-val'); }
    else { txt.textContent = 'Select branch-wise roles…'; txt.classList.remove('has-val'); }
}

function braSyncJson() {
    var j = {};
    Object.keys(braState).forEach(function(bid){
        if (braSelectedBranches.has(Number(bid)) && braState[bid] && braState[bid].size > 0) j[bid] = Array.from(braState[bid]);
    });
    document.getElementById('BranchRolesJson').value = JSON.stringify(j);
}

function setupDropdown(triggerId, panelId) {
    var trg = document.getElementById(triggerId); var pnl = document.getElementById(panelId);
    trg.addEventListener('click', function(e) {
        e.stopPropagation();
        var isOpen = pnl.classList.contains('open');
        document.querySelectorAll('.msd-panel.open').forEach(function(p){ p.classList.remove('open'); });
        document.querySelectorAll('.msd-trigger.open').forEach(function(t){ t.classList.remove('open'); });
        if (!isOpen) { pnl.classList.add('open'); trg.classList.add('open'); }
    });
    pnl.addEventListener('click', function(e){ e.stopPropagation(); });
}
document.addEventListener('click', function() {
    document.querySelectorAll('.msd-panel.open').forEach(function(p){ p.classList.remove('open'); });
    document.querySelectorAll('.msd-trigger.open').forEach(function(t){ t.classList.remove('open'); });
});

buildBranchDropdown();
buildRolesDropdown();
setupDropdown('branchTrigger', 'branchPanel');
setupDropdown('rolesTrigger', 'rolesPanel');

document.getElementById('createUserForm').addEventListener('submit', function(e) {
    var hasBranchNoRole = Array.from(braSelectedBranches).some(function(id){ return !braState[String(id)] || braState[String(id)].size === 0; });
    var err = document.getElementById('braError');
    if (!braSelectedBranches.size || hasBranchNoRole) { err.style.display = ''; e.preventDefault(); }
    else { err.style.display = 'none'; }
});
</script>
}
