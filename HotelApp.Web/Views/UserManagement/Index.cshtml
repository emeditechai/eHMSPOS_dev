@model IEnumerable<HotelApp.Web.Models.User>
@{
    ViewData["Title"] = "User Management";
    var usersWithData   = ViewBag.UsersWithBranchesAndRoles as List<(HotelApp.Web.Models.User user, List<HotelApp.Web.Models.Branch> branches, List<HotelApp.Web.Models.Role> roles)> ?? new();
    var isHOAdmin       = (bool)(ViewBag.IsHOBranchAdmin ?? false);
    var allBranches     = ViewBag.AllBranches as List<HotelApp.Web.Models.Branch> ?? new();
    var filterBranchId  = (int)(ViewBag.FilterBranchId ?? 0);
}

<div class="page-header">
    <h2><i class="fas fa-users-cog"></i> User Management</h2>
    <a asp-action="Create" class="btn-create">
        <i class="fas fa-plus"></i> Add New User
    </a>
</div>

@if (isHOAdmin && allBranches.Any())
{
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;background:#fff;padding:14px 20px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.07);">
        <label style="font-weight:600;font-size:14px;color:#333;white-space:nowrap;"><i class="fas fa-building" style="color:var(--primary);margin-right:6px;"></i>Filter by Branch:</label>
        <select id="branchFilterSelect" style="padding:8px 14px;border:1px solid #ddd;border-radius:8px;font-size:14px;min-width:200px;cursor:pointer;">
            <option value="0" selected="@(filterBranchId == 0)">All Branches</option>
            @foreach (var b in allBranches)
            {
                <option value="@b.BranchID" selected="@(b.BranchID == filterBranchId)">@b.BranchCode â€“ @b.BranchName</option>
            }
        </select>
        <span id="filterSpinner" style="display:none;color:var(--primary);"><i class="fas fa-spinner fa-spin"></i></span>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i>
        @TempData["ErrorMessage"]
    </div>
}

<div id="usersTableWrapper">
@if (usersWithData.Any())
{
    <div class="table-container">
        <table class="data-table" id="usersTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Roles</th>
                    <th>Assigned Branches</th>
                    <th>Last Login</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                @foreach (var userData in usersWithData)
                {
                    var user = userData.user;
                    var branches = userData.branches;
                    var roles = userData.roles;
                    var statusBadgeClass = user.IsActive ? "badge-available" : "badge-maintenance";
                    <tr>
                        <td><strong>@user.Username</strong></td>
                        <td>@(user.FullName ?? $"{user.FirstName} {user.LastName}")</td>
                        <td>@user.Email</td>
                        <td>
                            @if (roles.Any())
                            {
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    @foreach (var role in roles.Take(2))
                                    {
                                        <span class="badge badge-active" style="font-size: 11px;">@role.Name</span>
                                    }
                                    @if (roles.Count > 2)
                                    {
                                        <span class="badge badge-occupied" style="font-size: 11px;">+@(roles.Count - 2) more</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">No Roles</span>
                            }
                        </td>
                        <td>
                            @if (branches.Any())
                            {
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    @foreach (var branch in branches.Take(2))
                                    {
                                        <span class="badge badge-cleaning" style="font-size: 11px;">@branch.BranchCode</span>
                                    }
                                    @if (branches.Count > 2)
                                    {
                                        <span class="badge badge-occupied" style="font-size: 11px;">+@(branches.Count - 2) more</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="badge badge-maintenance">No branches</span>
                            }
                        </td>
                        <td>@(user.LastLoginDate.HasValue ? user.LastLoginDate.Value.ToString("dd MMM yyyy") : "Never")</td>
                        <td><span class="badge @statusBadgeClass">@(user.IsActive ? "Active" : "Inactive")</span></td>
                        <td>
                            <div class="action-buttons">
                                <a asp-action="Details" asp-route-id="@user.Id" class="btn-action btn-view" title="View User">
                                    <i class="fas fa-eye"></i>
                                    <span>View</span>
                                </a>
                                <a asp-action="Edit" asp-route-id="@user.Id" class="btn-action btn-edit" title="Edit User">
                                    <i class="fas fa-pen"></i>
                                    <span>Edit</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="empty-state" id="emptyState">
        <i class="fas fa-users-cog"></i>
        <h3>No Users Found</h3>
        <p>No users are assigned to this branch yet.</p>
        <a asp-action="Create" class="btn-create">
            <i class="fas fa-plus"></i> Add New User
        </a>
    </div>
}
</div>

@if (isHOAdmin)
{
    <script>
    (function () {
        var sel = document.getElementById('branchFilterSelect');
        if (!sel) return;
        var spinner = document.getElementById('filterSpinner');

        sel.addEventListener('change', function () {
            var branchId = this.value;
            if (spinner) spinner.style.display = '';
            fetch('/UserManagement/GetUsersByBranch?branchId=' + branchId, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (spinner) spinner.style.display = 'none';
                if (!data.success) return;
                updateTable(data.users, branchId);
            })
            .catch(function () { if (spinner) spinner.style.display = 'none'; });
        });

        function updateTable(users, branchId) {
            var wrapper = document.getElementById('usersTableWrapper');
            if (!users || !users.length) {
                var emptyMsg = branchId === '0' ? 'No users found.' : 'No users are assigned to this branch yet.';
                wrapper.innerHTML = '<div class="empty-state"><i class="fas fa-users-cog"></i><h3>No Users Found</h3><p>' + emptyMsg + '</p></div>';
                return;
            }

            var tableHtml = '<div class="table-container"><table class="data-table"><thead><tr>' +
                '<th>Username</th><th>Full Name</th><th>Email</th><th>Roles</th><th>Assigned Branches</th><th>Last Login</th><th>Status</th><th>Actions</th>' +
                '</tr></thead><tbody>';

            users.forEach(function (u) {
                var rolesBadges = u.roles.length
                    ? u.roles.slice(0,2).map(function(r){ return '<span class="badge badge-active" style="font-size:11px;">'+escHtml(r)+'</span>'; }).join(' ') +
                      (u.roles.length > 2 ? '<span class="badge badge-occupied" style="font-size:11px;">+' + (u.roles.length-2) + ' more</span>' : '')
                    : '<span class="text-muted">No Roles</span>';

                var branchesBadges = u.branches.length
                    ? u.branches.slice(0,2).map(function(b){ return '<span class="badge badge-cleaning" style="font-size:11px;">'+escHtml(b)+'</span>'; }).join(' ') +
                      (u.branches.length > 2 ? '<span class="badge badge-occupied" style="font-size:11px;">+' + (u.branches.length-2) + ' more</span>' : '')
                    : '<span class="badge badge-maintenance">No branches</span>';

                var statusCls = u.isActive ? 'badge-available' : 'badge-maintenance';
                var statusTxt = u.isActive ? 'Active' : 'Inactive';

                tableHtml += '<tr>' +
                    '<td><strong>' + escHtml(u.username) + '</strong></td>' +
                    '<td>' + escHtml(u.fullName) + '</td>' +
                    '<td>' + escHtml(u.email) + '</td>' +
                    '<td><div style="display:flex;gap:5px;flex-wrap:wrap;">' + rolesBadges + '</div></td>' +
                    '<td><div style="display:flex;gap:5px;flex-wrap:wrap;">' + branchesBadges + '</div></td>' +
                    '<td>' + escHtml(u.lastLogin) + '</td>' +
                    '<td><span class="badge ' + statusCls + '">' + statusTxt + '</span></td>' +
                    '<td><div class="action-buttons">' +
                        '<a href="/UserManagement/Details/' + u.id + '" class="btn-action btn-view" title="View User"><i class="fas fa-eye"></i><span>View</span></a>' +
                        '<a href="/UserManagement/Edit/' + u.id + '" class="btn-action btn-edit" title="Edit User"><i class="fas fa-pen"></i><span>Edit</span></a>' +
                    '</div></td>' +
                    '</tr>';
            });

            tableHtml += '</tbody></table></div>';
            wrapper.innerHTML = tableHtml;
        }

        function escHtml(s) {
            if (!s) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
    })();
    </script>
}
