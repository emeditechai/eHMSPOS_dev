@model HotelApp.Web.ViewModels.BookingDashboardViewModel
@{
    ViewData["Title"] = "Bookings Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/room-dashboard.css" asp-append-version="true" />
}

<div class="page-header">
    <h2><i class="fas fa-calendar-check"></i> Bookings Dashboard</h2>
    <a asp-action="Create" class="btn-create">
        <i class="fas fa-plus"></i> New Booking
    </a>
</div>

@if (TempData["SuccessMessage"] is string successMessage)
{
    <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> @successMessage
    </div>
}
@if (TempData["ErrorMessage"] is string errorMessage)
{
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> @errorMessage
    </div>
}

<!-- Dashboard Cards (match Rooms Dashboard style) -->
<div class="status-cards booking-status-cards">
    <div class="status-card available">
        <h3>Today's Bookings</h3>
        <div class="value">@Model.TodayBookingCount</div>
    </div>

    <div class="status-card occupied">
        <h3>Today's Advance Amount</h3>
        <div class="value">₹@Model.TodayAdvanceAmount.ToString("N0")</div>
    </div>

    <div class="status-card maintenance">
        <h3>Today's Check-ins</h3>
        <div class="value">@Model.TodayCheckInCount</div>
    </div>

    <div class="status-card cleaning">
        <h3>Today's Check-outs</h3>
        <div class="value">@Model.TodayCheckOutCount</div>
    </div>
</div>

<!-- Date Filters -->
<div class="filters-container">
    <form method="get" asp-action="List" class="date-filter-form">
        <div class="filter-group">
            <label for="fromDate">From Check-In Date:</label>
            <input type="date" id="fromDate" name="fromDate" class="form-control" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="filter-group">
            <label for="toDate">To Check-In Date:</label>
            <input type="date" id="toDate" name="toDate" class="form-control" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="filter-group">
            <label for="statusFilter">Status Filter:</label>
            <select id="statusFilter" name="statusFilter" class="form-control" style="padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; background: white;">
                <option value="">All Bookings</option>
                <option value="upcoming" selected="@(Model.StatusFilter == "upcoming")">Upcoming Booking</option>
                <option value="assigned" selected="@(Model.StatusFilter == "assigned")">Assigned Room</option>
                <option value="notassigned" selected="@(Model.StatusFilter == "notassigned")">Not Assigned Room</option>
                <option value="checkedin" selected="@(Model.StatusFilter == "checkedin")">Checked In</option>
                <option value="checkedout" selected="@(Model.StatusFilter == "checkedout")">Checked Out</option>
                <option value="cancelled" selected="@(Model.StatusFilter == "cancelled")">Cancelled</option>
                <option value="due" selected="@(Model.StatusFilter == "due")">Due Payment</option>
                <option value="fullypaid" selected="@(Model.StatusFilter == "fullypaid")">Fully Paid</option>
            </select>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn-filter-apply">
                <i class="fas fa-filter"></i> Apply Filter
            </button>
            <a asp-action="List" class="btn-filter-clear">
                <i class="fas fa-times"></i> Clear
            </a>
        </div>
    </form>
</div>

@if (Model.Bookings.Any())
{
    <!-- Search and Export Section -->
    <div class="search-export-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div class="search-box" style="flex: 1; max-width: 500px;">
            <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                <input type="text" id="searchInput" placeholder="Search by Booking Number, Guest Name, or Room Type..." 
                       style="width: 100%; padding: 10px 12px 10px 40px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: all 0.3s;"
                       onkeyup="searchTable()" />
            </div>
        </div>
        <div class="export-buttons" style="display: flex; gap: 10px;">
            <button onclick="exportToExcel()" class="btn-export" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button onclick="exportToPDF()" class="btn-export" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
    </div>

    <div class="table-container" style="overflow: visible;">
        <table class="data-table" id="bookingTable">
            <thead>
                <tr>
                    <th>Booking #</th>
                    <th>Guest</th>
                    <th>Stay</th>
                    <th>Room</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in Model.Bookings)
                {
                    <tr>
                        <td>
                            <strong>@booking.BookingNumber</strong>
                            <div class="subtext">@booking.Source / @booking.Channel</div>
                        </td>
                        <td>
                            <strong>@booking.PrimaryGuestFirstName @booking.PrimaryGuestLastName</strong>
                            <div class="subtext">@booking.PrimaryGuestPhone</div>
                        </td>
                        <td>
                            <div>@booking.CheckInDate.ToString("dd MMM yyyy") - @booking.CheckOutDate.ToString("dd MMM yyyy")</div>
                            <div class="subtext">@booking.Nights night(s)</div>
                        </td>
                        <td>
                            <div>@booking.RoomType?.TypeName</div>
                            @if (booking.Room != null)
                            {
                                <div class="subtext">Room: @booking.Room.RoomNumber</div>
                            }
                            else
                            {
                                <div class="subtext text-muted">Not Assigned</div>
                            }
                            @if (booking.RequiredRooms > 1)
                            {
                                <div class="subtext" style="color: #6366f1; font-weight: 600; margin-top: 4px;">
                                    <i class="fas fa-layer-group" style="font-size: 10px;"></i> @booking.RequiredRooms Rooms
                                </div>
                            }
                        </td>
                        <td>
                            ₹@booking.TotalAmount.ToString("N0")
                            <div class="subtext">Deposit: ₹@booking.DepositAmount.ToString("N0")</div>
                        </td>
                        <td>
                            <span class="badge badge-available">@booking.Status</span>
                            <div class="subtext">@booking.PaymentStatus</div>
                            @if (booking.ActualCheckInDate.HasValue)
                            {
                                <div class="subtext" style="margin-top: 4px; color: #0d6efd; font-weight: 600;">
                                    <i class="fas fa-sign-in-alt" style="font-size: 10px;"></i> Checked In: @booking.ActualCheckInDate.Value.ToString("dd MMM yyyy hh:mm tt")
                                </div>
                            }
                            else
                            {
                                <div class="subtext" style="margin-top: 4px; color: #6c757d; font-weight: 500;">
                                    <i class="fas fa-door-open" style="font-size: 10px;"></i> Due In: @booking.CheckInDate.ToString("dd MMM yyyy")
                                </div>
                            }
                            @if (booking.ActualCheckOutDate.HasValue)
                            {
                                <div class="subtext" style="margin-top: 4px; color: #28a745; font-weight: 600;">
                                    <i class="fas fa-check-circle" style="font-size: 10px;"></i> Checked Out: @booking.ActualCheckOutDate.Value.ToString("dd MMM yyyy hh:mm tt")
                                </div>
                            }
                            else
                            {
                                <div class="subtext" style="margin-top: 4px; color: #dc3545; font-weight: 500;">
                                    <i class="fas fa-calendar-check" style="font-size: 10px;"></i> Out: @booking.CheckOutDate.ToString("dd MMM yyyy")
                                </div>
                            }
                        </td>
                        <td>@booking.CreatedDate.ToString("dd/MM/yyyy")<br/><span class="subtext">@booking.CreatedDate.ToString("hh:mm tt")</span></td>
                        <td>
                            <div class="dropdown">
                                <button class="btn-action-dropdown" onclick="toggleDropdown(event, 'dropdown-@booking.BookingNumber')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="dropdown-@booking.BookingNumber" class="dropdown-menu">
                                    <a asp-action="Details" asp-route-bookingNumber="@booking.BookingNumber" class="dropdown-item">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>

                                    <a href="#" onclick="openOtherChargesModal('@booking.BookingNumber'); return false;" class="dropdown-item">
                                        <i class="fas fa-receipt"></i> Other Charges
                                    </a>
                                    @* Only show edit actions if booking is NOT checked out *@
                                    @if (!booking.ActualCheckOutDate.HasValue)
                                    {
                                        @if (booking.ActualCheckInDate.HasValue)
                                        {
                                            <a href="#" onclick="checkoutGuest('@booking.BookingNumber', '@booking.Room?.Id')" class="dropdown-item" style="color: #059669;">
                                                <i class="fas fa-sign-out-alt"></i> Check Out Guest
                                            </a>
                                            <hr class="dropdown-divider" />
                                        }
                                        @if (booking.Room == null)
                                        {
                                            <a href="#" onclick="assignRoom('@booking.BookingNumber')" class="dropdown-item">
                                                <i class="fas fa-door-open"></i> Assign Room
                                            </a>
                                        }
                                        else
                                        {
                                            <a href="#" onclick="changeRoom('@booking.BookingNumber')" class="dropdown-item">
                                                <i class="fas fa-exchange-alt"></i> Change Room
                                            </a>
                                        }
                                        <a href="#" onclick="editRoomType('@booking.BookingNumber')" class="dropdown-item">
                                            <i class="fas fa-bed"></i> Edit Room Type
                                        </a>
                                        <a href="#" onclick="editDates('@booking.BookingNumber')" class="dropdown-item">
                                            <i class="fas fa-calendar-alt"></i> Edit Dates
                                        </a>
                                        <hr class="dropdown-divider" />
                                        <a href="#" onclick="cancelBooking('@booking.BookingNumber')" class="dropdown-item text-danger">
                                            <i class="fas fa-times-circle"></i> Cancel Booking
                                        </a>
                                    }
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="empty-state">
        <i class="fas fa-calendar-check"></i>
        <h3>No bookings yet</h3>
        <p>Create your first booking to get started.</p>
        <a asp-action="Create" class="btn-create">
            <i class="fas fa-plus"></i> Add Booking
        </a>
    </div>
}

<style>
    /* Booking cards should look identical to Rooms Dashboard cards */
    .booking-status-cards {
        margin-bottom: 30px;
    }

    /* Fallback in case room-dashboard.css is not loaded for some reason */
    .booking-status-cards.status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
    }

    /* Date Filters */
    .filters-container {
        background: white;
        border-radius: 12px;
        padding: 20px 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .date-filter-form {
        display: flex;
        align-items: flex-end;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
        min-width: 180px;
    }

    .filter-group label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
    }

    .filter-group .form-control {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .filter-group .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-filter-apply, .btn-filter-clear {
        padding: 8px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        border: none;
    }

    .btn-filter-apply {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-filter-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-filter-clear {
        background: white;
        color: #6b7280;
        border: 2px solid #e5e7eb;
    }

    .btn-filter-clear:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #374151;
    }

    /* Note: We intentionally reuse global `.status-cards`/`.status-card` styles */

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .btn-action-dropdown {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 32px;
    }

    .btn-action-dropdown:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-action-dropdown:active {
        transform: translateY(0);
    }

    .dropdown-menu {
        display: none;
        position: fixed;
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
        width: max-content;
        min-width: 180px;
        max-width: min(260px, calc(100vw - 16px));
        z-index: 10000;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .dropdown-menu.show {
        display: block;
        animation: dropdownSlide 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-15px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        color: #374151;
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 12px;
        font-weight: 500;
        border: none;
        width: 100%;
        text-align: left;
        background: white;
        cursor: pointer;
        white-space: nowrap;
    }

    .dropdown-item:hover {
        background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
        color: #0369a1;
        padding-left: 16px;
    }

    .dropdown-item i {
        margin-right: 8px;
        width: 14px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .dropdown-item.text-danger {
        color: #dc2626;
    }

    .dropdown-item.text-danger:hover {
        background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%);
        color: #b91c1c;
    }

    .dropdown-divider {
        margin: 2px 6px;
        border: none;
        border-top: 1px solid #f1f5f9;
    }

    .text-muted {
        color: #a0aec0 !important;
        font-style: italic;
    }

    @@media (max-width: 768px) {
        .dashboard-cards {
            grid-template-columns: 1fr;
        }

        .dashboard-card {
            padding: 20px;
        }

        .dashboard-card .card-icon {
            width: 50px;
            height: 50px;
            font-size: 24px;
        }

        .dashboard-card .card-content h3 {
            font-size: 24px;
        }
    }
</style>

<script>
    // Toggle to `true` temporarily while debugging dropdown close behavior.
    const BOOKING_DROPDOWN_DEBUG = false;
    function bookingDropdownLog(...args) {
        if (BOOKING_DROPDOWN_DEBUG && window?.console) console.log('[BookingDropdown]', ...args);
    }

    // ----- Booking List action dropdown helpers -----
    function closeAllBookingActionDropdowns(exceptId) {
        bookingDropdownLog('closeAllBookingActionDropdowns', { exceptId });
        document.querySelectorAll('.data-table .dropdown-menu.show').forEach(menu => {
            if (!exceptId || menu.id !== exceptId) {
                menu.classList.remove('show');
                // Clear any inline styles used for positioning so CSS can hide it.
                menu.style.left = '';
                menu.style.top = '';
                menu.style.right = '';
                menu.style.visibility = '';
            }
        });
    }

    function toggleDropdown(event, dropdownId) {
        event.preventDefault();
        event.stopPropagation();
        
        const button = event.currentTarget;
        const dropdown = document.getElementById(dropdownId);

        bookingDropdownLog('toggleDropdown', { dropdownId, hasDropdown: !!dropdown });
        if (!dropdown) return;
        
        // Close all other booking-row dropdowns
        closeAllBookingActionDropdowns(dropdownId);
        
        // Toggle current dropdown
        const isShown = dropdown.classList.contains('show');
        
        if (!isShown) {
            // Position dropdown relative to button
            const rect = button.getBoundingClientRect();
            const gap = 6;
            const margin = 8;

            // Make it measurable using CSS-controlled display via `.show`.
            dropdown.style.visibility = 'hidden';
            dropdown.classList.add('show');

            const menuWidth = dropdown.offsetWidth || 180;
            const menuHeight = dropdown.offsetHeight || 0;

            // Prefer opening down-right aligned to the button.
            let left = rect.right - menuWidth;
            let top = rect.bottom + gap;

            // Clamp horizontally to viewport
            left = Math.max(margin, Math.min(left, window.innerWidth - menuWidth - margin));

            // If it would overflow bottom, open upwards.
            if (menuHeight && top + menuHeight + margin > window.innerHeight) {
                top = rect.top - menuHeight - gap;
            }

            top = Math.max(margin, Math.min(top, window.innerHeight - (menuHeight || 0) - margin));

            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.right = 'auto';
            dropdown.style.visibility = 'visible';
            bookingDropdownLog('opened', { dropdownId, left, top });
        } else {
            dropdown.classList.remove('show');
            dropdown.style.left = '';
            dropdown.style.top = '';
            dropdown.style.right = '';
            dropdown.style.visibility = '';
            bookingDropdownLog('closed', { dropdownId });
        }
    }

    // Ensure the close handlers are attached even if other scripts override bubbling.
    // Use pointerdown (fires earlier than click) + capture phase.
    window.addEventListener('pointerdown', function(event) {
        bookingDropdownLog('pointerdown', { target: event.target?.tagName, inside: !!event.target.closest('.data-table .dropdown, .data-table .dropdown-menu') });
        if (!event.target.closest('.data-table .dropdown') && !event.target.closest('.data-table .dropdown-menu')) {
            closeAllBookingActionDropdowns();
        }
    }, true);

    // Close on ESC (capture phase)
    window.addEventListener('keydown', function(event) {
        bookingDropdownLog('keydown', { key: event.key });
        if (event.key === 'Escape') {
            closeAllBookingActionDropdowns();
        }
    }, true);

    // Close when a dropdown item is clicked.
    // IMPORTANT: do NOT close on pointerdown, otherwise the subsequent click may not fire
    // (because the element becomes hidden before pointerup/click).
    window.addEventListener('click', function(event) {
        if (event.target.closest('.data-table .dropdown-menu .dropdown-item')) {
            setTimeout(() => closeAllBookingActionDropdowns(), 0);
        }
    }, true);

    // Close ONLY booking-row action dropdowns on scroll
    window.addEventListener('scroll', function() {
        closeAllBookingActionDropdowns();
    }, true);

    // Extra safety: close if focus moves elsewhere or viewport changes.
    window.addEventListener('focusin', function(event) {
        if (!event.target.closest('.data-table .dropdown') && !event.target.closest('.data-table .dropdown-menu')) {
            closeAllBookingActionDropdowns();
        }
    }, true);

    window.addEventListener('resize', function() {
        closeAllBookingActionDropdowns();
    }, true);

    function assignRoom(bookingNumber) {
        window.location.href = '/Booking/AssignRoom?bookingNumber=' + bookingNumber;
    }

    function changeRoom(bookingNumber) {
        window.location.href = '/Booking/AssignRoom?bookingNumber=' + bookingNumber;
    }

    function editRoomType(bookingNumber) {
        window.location.href = '/Booking/EditRoomType?bookingNumber=' + bookingNumber;
    }

    function editDates(bookingNumber) {
        window.location.href = '/Booking/EditDates?bookingNumber=' + bookingNumber;
    }

    function cancelBooking(bookingNumber) {
        if (confirm('Are you sure you want to cancel booking: ' + bookingNumber + '?\n\nThis action cannot be undone.')) {
            fetch('/Booking/Cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ bookingNumber: bookingNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Booking cancelled successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while cancelling the booking');
            });
        }
    }

    function checkoutGuest(bookingNumber, roomId) {
        if (!roomId || roomId === '') {
            Swal.fire({
                icon: 'warning',
                title: 'No Room Assigned',
                text: 'This booking does not have a room assigned yet.'
            });
            return;
        }

        Swal.fire({
            title: 'Checkout Confirmation',
            html: `<p>Are you sure you want to check out guest for booking:</p><p><strong>${bookingNumber}</strong></p>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#059669',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, checkout!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'Processing...',
                    text: 'Checking payment status and processing checkout',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Call checkout endpoint
                fetch('@Url.Action("CheckoutRoom", "Rooms")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ roomId: parseInt(roomId) })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Checkout Successful',
                            text: data.message,
                            timer: 2000
                        }).then(() => {
                            location.reload();
                        });
                    } else if (data.requiresPayment) {
                        // Payment not cleared - show alert and redirect to payment
                        Swal.fire({
                            icon: 'warning',
                            title: 'Payment Not Cleared',
                            html: `
                                <p><strong>Booking:</strong> ${data.bookingNumber}</p>
                                <p><strong>Balance Amount:</strong> ₹${data.balanceAmount.toLocaleString()}</p>
                                <p>Please clear the payment before checkout.</p>
                            `,
                            confirmButtonColor: '#059669',
                            confirmButtonText: 'Go to Payment'
                        }).then(() => {
                            // Redirect to booking details page where payment can be made
                            window.location.href = '@Url.Action("Details", "Booking")?bookingNumber=' + data.bookingNumber;
                        });
                    } else {
                        // Check if booking not found - offer force checkout
                        if (data && (data.isExpired === true || (data.message && data.message.includes('No active booking found')))) {
                            const detectedDateText = data.detectedCheckOutDate
                                ? new Date(data.detectedCheckOutDate).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' })
                                : null;
                            const expiredHtml = detectedDateText
                                ? `<p>This booking was expected to check out on <strong>${detectedDateText}</strong>.</p>`
                                : `<p>The checkout date for this booking has passed.</p>`;

                            Swal.fire({
                                icon: 'warning',
                                title: 'Booking Expired',
                                html: `
                                    ${expiredHtml}
                                    <p>Would you like to <strong>Force Checkout</strong>?</p>
                                `,
                                showCancelButton: true,
                                confirmButtonColor: '#dc3545',
                                cancelButtonColor: '#6c757d',
                                confirmButtonText: 'Force Checkout'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    forceCheckoutRoom(roomId);
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Checkout Failed',
                                text: data.message
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking out guest:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to check out guest: ' + error.message
                    });
                });
            }
        });
    }

    function forceCheckoutRoom(roomId) {
        Swal.fire({
            title: 'Processing Force Checkout...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('@Url.Action("ForceCheckoutRoom", "Rooms")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ roomId: parseInt(roomId) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Force Checkout Successful',
                    text: data.message,
                    timer: 2000
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Force Checkout Failed',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Error force checking out room:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to force checkout: ' + error.message
            });
        });
    }

    // Client-side search function
    function searchTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('bookingTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const bookingNumber = row.cells[0].textContent.toLowerCase();
            const guestName = row.cells[1].textContent.toLowerCase();
            const roomType = row.cells[3].textContent.toLowerCase();
            
            if (bookingNumber.includes(filter) || guestName.includes(filter) || roomType.includes(filter)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        // Update search input style based on results
        if (filter && visibleCount === 0) {
            input.style.borderColor = '#ef4444';
        } else if (filter && visibleCount > 0) {
            input.style.borderColor = '#10b981';
        } else {
            input.style.borderColor = '#e0e0e0';
        }
    }

    // Export to Excel
    function exportToExcel() {
        const fromDate = '@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")';
        const toDate = '@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")';
        const statusFilter = '@(Model.StatusFilter ?? "")';
        let url = '@Url.Action("ExportToExcel", "Booking")';
        
        const params = new URLSearchParams();
        if (fromDate) params.append('fromDate', fromDate);
        if (toDate) params.append('toDate', toDate);
        if (statusFilter) params.append('statusFilter', statusFilter);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.location.href = url;
    }

    // Export to PDF
    function exportToPDF() {
        const fromDate = '@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")';
        const toDate = '@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")';
        const statusFilter = '@(Model.StatusFilter ?? "")';
        let url = '@Url.Action("ExportToPDF", "Booking")';
        
        const params = new URLSearchParams();
        if (fromDate) params.append('fromDate', fromDate);
        if (toDate) params.append('toDate', toDate);
        if (statusFilter) params.append('statusFilter', statusFilter);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.open(url, '_blank');
    }

    // Hover effect for export buttons
    document.querySelectorAll('.btn-export').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // Focus effect for search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('focus', function() {
            this.style.borderColor = '#667eea';
            this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
        });
        searchInput.addEventListener('blur', function() {
            if (!this.value) {
                this.style.borderColor = '#e0e0e0';
                this.style.boxShadow = 'none';
            }
        });
    }

    async function openOtherChargesModal(bookingNumber) {
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const [masterRes, existingRes] = await Promise.all([
                fetch('/Booking/GetOtherChargesMaster'),
                fetch('/Booking/GetBookingOtherCharges?bookingNumber=' + encodeURIComponent(bookingNumber))
            ]);

            const masterJson = await masterRes.json();
            const existingJson = await existingRes.json();

            if (!masterJson?.success) {
                throw new Error(masterJson?.message || 'Failed to load Other Charges master');
            }
            if (!existingJson?.success) {
                throw new Error(existingJson?.message || 'Failed to load booking Other Charges');
            }

            const masterRows = masterJson.rows || [];
            const existingRows = existingJson.rows || [];

            const html = `
                <div style="text-align:left;">
                    <div style="margin-bottom:12px; font-weight:600;">Booking: <span style="font-weight:800;">${bookingNumber}</span></div>

                    <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap; margin-bottom:12px;">
                        <div style="flex:1; min-width:260px;">
                            <label style="display:block; font-size:12px; color:#6b7280; margin-bottom:6px;">Select Other Charge</label>
                            <select id="ocSelect" class="swal2-input" style="margin:0; height:40px;"></select>
                        </div>
                        <div>
                            <button id="ocAddBtn" type="button" class="swal2-confirm swal2-styled" style="margin:0; height:40px;">Add</button>
                        </div>
                    </div>

                    <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:10px;">
                        <table style="width:100%; border-collapse:collapse; min-width:820px;">
                            <thead>
                                <tr style="background:#f9fafb;">
                                    <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">Charge</th>
                                    <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">Rate</th>
                                    <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">Qty</th>
                                    <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">Note</th>
                                    <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">GST %</th>
                                    <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">GST Amt</th>
                                    <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">CGST Amt</th>
                                    <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">SGST Amt</th>
                                    <th style="text-align:center; padding:10px; border-bottom:1px solid #e5e7eb;">Remove</th>
                                </tr>
                            </thead>
                            <tbody id="ocItemsBody"></tbody>
                        </table>
                    </div>
                </div>
            `;

            const masterById = new Map(masterRows.map(r => [r.id, r]));
            const originallySavedIds = new Set((existingRows || []).map(r => r.otherChargeId));

            const result = await Swal.fire({
                title: 'Other Charges',
                html,
                width: 980,
                showCancelButton: true,
                confirmButtonText: 'Save',
                cancelButtonText: 'Close',
                focusConfirm: false,
                didOpen: () => {
                    const sel = document.getElementById('ocSelect');
                    const addBtn = document.getElementById('ocAddBtn');
                    const body = document.getElementById('ocItemsBody');

                    // Populate dropdown
                    sel.innerHTML = masterRows.map(r => {
                        const label = `${r.code} - ${r.name}`;
                        return `<option value="${r.id}">${escapeHtml(label)}</option>`;
                    }).join('');

                    // Seed existing rows
                    for (const row of existingRows) {
                        appendRow(body, {
                            otherChargeId: row.otherChargeId,
                            code: row.code,
                            name: row.name,
                            gstPercent: row.gstPercent,
                            cgstPercent: row.cgstPercent,
                            sgstPercent: row.sgstPercent,
                            qty: row.qty,
                            note: row.note,
                            rate: row.rate
                        }, true);
                    }

                    addBtn.addEventListener('click', () => {
                        const id = parseInt(sel.value, 10);
                        if (!Number.isFinite(id)) return;
                        if (body.querySelector(`tr[data-ocid="${id}"]`)) {
                            return;
                        }
                        const m = masterById.get(id);
                        if (!m) return;
                        appendRow(body, {
                            otherChargeId: m.id,
                            code: m.code,
                            name: m.name,
                            gstPercent: m.gstPercent,
                            cgstPercent: m.cgstPercent,
                            sgstPercent: m.sgstPercent,
                            qty: 1,
                            note: '',
                            rate: m.rate
                        }, originallySavedIds.has(m.id));
                    });
                },
                preConfirm: async () => {
                    const body = document.getElementById('ocItemsBody');
                    const rows = Array.from(body.querySelectorAll('tr'));

                    const items = rows.map(tr => {
                        const otherChargeId = parseInt(tr.getAttribute('data-ocid'), 10);
                        const rateInput = tr.querySelector('input[data-role="rate"]');
                        const qtyInput = tr.querySelector('input[data-role="qty"]');
                        const noteInput = tr.querySelector('input[data-role="note"]');
                        const rate = parseFloat(rateInput?.value);
                        const qty = parseInt(qtyInput?.value, 10);
                        const note = noteInput?.value;
                        return {
                            otherChargeId,
                            rate: Number.isFinite(rate) ? rate : 0,
                            qty: Number.isFinite(qty) ? qty : 1,
                            note: (note ?? '').trim()
                        };
                    });

                    if (items.length === 0) {
                        Swal.showValidationMessage('Please add at least one Other Charge');
                        return;
                    }

                    const resp = await fetch('/Booking/SaveBookingOtherCharges', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({ bookingNumber, items })
                    });
                    const data = await resp.json();
                    if (!data?.success) {
                        Swal.showValidationMessage(data?.message || 'Failed to save other charges');
                        return;
                    }
                    return data;
                }
            });

            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'success',
                    title: 'Saved',
                    text: result.value?.message || 'Other charges saved',
                    timer: 1200,
                    showConfirmButton: false
                }).then(() => location.reload());
            }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: err?.message || 'Failed to open Other Charges'
            });
        }

        function appendRow(tbody, row, isPersisted) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-ocid', row.otherChargeId);
            tr.setAttribute('data-gst', row.gstPercent);
            tr.setAttribute('data-cgst', row.cgstPercent);
            tr.setAttribute('data-sgst', row.sgstPercent);
            tr.setAttribute('data-persisted', isPersisted ? '1' : '0');

            tr.innerHTML = `
                <td style="padding:10px; border-bottom:1px solid #f3f4f6;">
                    <div style="font-weight:700;">${escapeHtml(row.code)}</div>
                    <div style="font-size:12px; color:#6b7280;">${escapeHtml(row.name)}</div>
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:right;">
                    <input data-role="rate" type="number" step="0.01" min="0" value="${Number(row.rate || 0).toFixed(2)}" style="width:120px; text-align:right; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px;" />
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:right;">
                    <input data-role="qty" type="number" step="1" min="1" value="${Number(row.qty || 1)}" style="width:80px; text-align:right; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px;" />
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6;">
                    <input data-role="note" type="text" value="${escapeAttr(row.note || '')}" style="width:240px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px;" placeholder="Note" />
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:right;">
                    <span data-role="gstPercent">${Number(row.gstPercent || 0).toFixed(2)}</span>
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:right;">
                    ₹<span data-role="gstAmt">0.00</span>
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:right;">
                    ₹<span data-role="cgstAmt">0.00</span>
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:right;">
                    ₹<span data-role="sgstAmt">0.00</span>
                </td>
                <td style="padding:10px; border-bottom:1px solid #f3f4f6; text-align:center;">
                    <button
                        type="button"
                        data-role="remove"
                        title="Remove"
                        aria-label="Remove"
                        style="margin:0; width:40px; height:40px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; color:#ef4444; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;"
                    ><i class="fas fa-times"></i></button>
                </td>
            `;

            const rateInput = tr.querySelector('input[data-role="rate"]');
            const qtyInput = tr.querySelector('input[data-role="qty"]');
            const removeBtn = tr.querySelector('button[data-role="remove"]');
            rateInput.addEventListener('input', () => recalc(tr));
            qtyInput.addEventListener('input', () => recalc(tr));
            removeBtn.addEventListener('click', async () => {
                const persisted = tr.getAttribute('data-persisted') === '1';
                if (!persisted) {
                    tr.remove();
                    return;
                }

                const confirm = await Swal.fire({
                    title: 'Remove this charge?',
                    text: 'This charge is already saved. It will be removed when you click Save.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove',
                    cancelButtonText: 'Cancel',
                    focusCancel: true
                });

                if (confirm.isConfirmed) {
                    tr.remove();
                }
            });

            tbody.appendChild(tr);
            recalc(tr);
        }

        function recalc(tr) {
            const rate = parseFloat(tr.querySelector('input[data-role="rate"]').value);
            const qty = parseInt(tr.querySelector('input[data-role="qty"]').value, 10);
            const safeRate = Number.isFinite(rate) ? Math.max(0, rate) : 0;
            const safeQty = Number.isFinite(qty) ? Math.max(1, qty) : 1;
            const taxable = round2(safeRate * safeQty);
            const gstPct = parseFloat(tr.getAttribute('data-gst')) || 0;
            const cgstPct = parseFloat(tr.getAttribute('data-cgst')) || 0;
            const sgstPct = parseFloat(tr.getAttribute('data-sgst')) || 0;
            const gstAmt = round2(taxable * gstPct / 100);
            const cgstAmt = round2(taxable * cgstPct / 100);
            const sgstAmt = round2(taxable * sgstPct / 100);
            tr.querySelector('span[data-role="gstAmt"]').textContent = gstAmt.toFixed(2);
            tr.querySelector('span[data-role="cgstAmt"]').textContent = cgstAmt.toFixed(2);
            tr.querySelector('span[data-role="sgstAmt"]').textContent = sgstAmt.toFixed(2);
        }

        function round2(v) {
            return Math.round((v + Number.EPSILON) * 100) / 100;
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>'\"]/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;',
                '\\': '&#92;'
            }[c]));
        }

        function escapeAttr(str) {
            // Escape for placing inside a quoted HTML attribute value
            return String(str ?? '').replace(/[&<>'"]/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[c]));
        }
    }

</script>

<form method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>
