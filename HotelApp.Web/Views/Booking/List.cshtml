@model HotelApp.Web.ViewModels.BookingDashboardViewModel
@{
    ViewData["Title"] = "Bookings Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/room-dashboard.css" asp-append-version="true" />
}

<div class="page-header">
    <h2><i class="fas fa-calendar-check"></i> Bookings Dashboard</h2>
    <a asp-action="Create" class="btn-create">
        <i class="fas fa-plus"></i> New Booking
    </a>
</div>

<form style="display:none;">@Html.AntiForgeryToken()</form>

@{
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

@if (!string.IsNullOrWhiteSpace(successMessage) || !string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="toast-stack" aria-live="polite" aria-atomic="true">
        @if (!string.IsNullOrWhiteSpace(successMessage))
        {
            <div class="alert alert-success toast-item" role="status" data-toast>
                <i class="fas fa-check-circle"></i>
                <span>@successMessage</span>
                <button type="button" class="toast-close" aria-label="Close">&times;</button>
            </div>
        }
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger toast-item" role="alert" data-toast>
                <i class="fas fa-exclamation-triangle"></i>
                <span>@errorMessage</span>
                <button type="button" class="toast-close" aria-label="Close">&times;</button>
            </div>
        }
    </div>
}

<!-- Dashboard Cards (match Rooms Dashboard style) -->
<div class="status-cards booking-status-cards">
    <div class="status-card available">
        <h3>Today's Bookings</h3>
        <div class="value">@Model.TodayBookingCount</div>
    </div>

    <div class="status-card occupied">
        <h3>Today's Advance Amount</h3>
        <div class="value">₹@Model.TodayAdvanceAmount.ToString("N0")</div>
    </div>

    <div class="status-card maintenance">
        <h3>Today's Check-ins</h3>
        <div class="value">@Model.TodayCheckInCount</div>
    </div>

    <div class="status-card cleaning">
        <h3>Today's Check-outs</h3>
        <div class="value">@Model.TodayCheckOutCount</div>
    </div>
</div>

<!-- Date Filters -->
<div class="filters-container">
    <form method="get" asp-action="List" class="date-filter-form">
        <div class="filter-group">
            <label for="fromDate">From Check-In Date:</label>
            <input type="date" id="fromDate" name="fromDate" class="form-control" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="filter-group">
            <label for="toDate">To Check-In Date:</label>
            <input type="date" id="toDate" name="toDate" class="form-control" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="filter-group">
            <label for="statusFilter">Status Filter:</label>
            <select id="statusFilter" name="statusFilter" class="form-control" style="padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; background: white;">
                <option value="">All Bookings</option>
                <option value="upcoming" selected="@(Model.StatusFilter == "upcoming")">Upcoming Booking</option>
                <option value="assigned" selected="@(Model.StatusFilter == "assigned")">Assigned Room</option>
                <option value="notassigned" selected="@(Model.StatusFilter == "notassigned")">Not Assigned Room</option>
                <option value="checkedin" selected="@(Model.StatusFilter == "checkedin")">Checked In</option>
                <option value="checkedout" selected="@(Model.StatusFilter == "checkedout")">Checked Out</option>
                <option value="cancelled" selected="@(Model.StatusFilter == "cancelled")">Cancelled</option>
                <option value="due" selected="@(Model.StatusFilter == "due")">Due Payment</option>
                <option value="fullypaid" selected="@(Model.StatusFilter == "fullypaid")">Fully Paid</option>
            </select>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn-filter-apply">
                <i class="fas fa-filter"></i> Apply Filter
            </button>
            <a asp-action="List" class="btn-filter-clear">
                <i class="fas fa-times"></i> Clear
            </a>
        </div>
    </form>
</div>

@if (Model.Bookings.Any())
{
    <!-- Search and Export Section -->
    <div class="search-export-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div class="search-box" style="flex: 1; max-width: 500px;">
            <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                <input type="text" id="searchInput" placeholder="Search by Booking Number, Guest Name, or Room Type..." 
                       style="width: 100%; padding: 10px 12px 10px 40px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: all 0.3s;"
                       onkeyup="searchTable()" />
            </div>
        </div>
        <div class="export-buttons" style="display: flex; gap: 10px;">
            <button onclick="exportToExcel()" class="btn-export" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button onclick="exportToPDF()" class="btn-export" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
    </div>

    <div class="table-container" style="overflow: visible;">
        <table class="data-table" id="bookingTable">
            <thead>
                <tr>
                    <th>Booking #</th>
                    <th>Guest</th>
                    <th>Stay</th>
                    <th>Room</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in Model.Bookings)
                {
                    <tr>
                        <td>
                            <strong>@booking.BookingNumber</strong>
                            <div class="subtext">@booking.Source / @booking.Channel</div>
                        </td>
                        <td>
                            <strong>@booking.PrimaryGuestFirstName @booking.PrimaryGuestLastName</strong>
                            <div class="subtext">@booking.PrimaryGuestPhone</div>
                            @if (!string.IsNullOrWhiteSpace(booking.PrimaryGuestEmail))
                            {
                                <div class="subtext" style="font-size:11px;">@booking.PrimaryGuestEmail</div>
                            }
                        </td>
                        <td>
                            <div>@booking.CheckInDate.ToString("dd MMM yyyy") - @booking.CheckOutDate.ToString("dd MMM yyyy")</div>
                            <div class="subtext">@booking.Nights night(s)</div>
                        </td>
                        <td>
                            <div>@booking.RoomType?.TypeName</div>
                            @if (booking.Room != null)
                            {
                                <div class="subtext">Room: @booking.Room.RoomNumber</div>
                            }
                            else
                            {
                                <div class="subtext text-muted">Not Assigned</div>
                            }
                            @if (booking.RequiredRooms > 1)
                            {
                                <div class="subtext" style="color: #6366f1; font-weight: 600; margin-top: 4px;">
                                    <i class="fas fa-layer-group" style="font-size: 10px;"></i> @booking.RequiredRooms Rooms
                                </div>
                            }
                        </td>
                        <td>
                            ₹@booking.TotalAmount.ToString("N0")
                            <div class="subtext">Deposit: ₹@booking.DepositAmount.ToString("N0")</div>
                        </td>
                        <td>
                            @{
                                // Calculate status badge class
                                var statusBadgeClass = booking.Status?.ToLower() switch
                                {
                                    "confirmed" => "status-badge-confirmed",
                                    "checkedin" => "status-badge-checkedin",
                                    "pending" => "status-badge-pending",
                                    "cancelled" => "status-badge-cancelled",
                                    _ => "status-badge-default"
                                };
                                
                                if (booking.ActualCheckOutDate.HasValue)
                                {
                                    statusBadgeClass = "status-badge-checkedout";
                                }
                                
                                // Calculate payment status
                                // DepositAmount stores cash received (net). But a booking can be fully settled by
                                // net + payment-time discount, with round-off adjusting the final payable amount.
                                var paymentsForBalance = booking.Payments ?? Enumerable.Empty<HotelApp.Web.Models.BookingPayment>();
                                var totalRoundOffApplied = paymentsForBalance.Any()
                                    ? paymentsForBalance.Sum(p => p.IsRoundOffApplied ? p.RoundOffAmount : 0m)
                                    : 0m;
                                var settledNet = paymentsForBalance.Any()
                                    ? paymentsForBalance.Sum(p => p.Amount + p.DiscountAmount)
                                    : booking.DepositAmount;

                                var finalPayable = booking.TotalAmount + totalRoundOffApplied;
                                var balanceAmount = finalPayable - settledNet;
                                var paymentPercentage = booking.TotalAmount > 0
                                    ? Math.Max(0, Math.Min(100, (settledNet / booking.TotalAmount) * 100))
                                    : 0;
                                var paymentStatusClass = "";
                                var paymentStatusIcon = "";
                                var paymentStatusText = "";
                                
                                if (balanceAmount <= 0)
                                {
                                    paymentStatusClass = "payment-badge-fullypaid";
                                    paymentStatusIcon = "fas fa-check-circle";
                                    paymentStatusText = "Fully Paid";
                                }
                                else if (settledNet > 0)
                                {
                                    paymentStatusClass = "payment-badge-partial";
                                    paymentStatusIcon = "fas fa-clock";
                                    paymentStatusText = $"Partial ({paymentPercentage:F0}%)";
                                }
                                else
                                {
                                    paymentStatusClass = "payment-badge-pending";
                                    paymentStatusIcon = "fas fa-hourglass-half";
                                    paymentStatusText = "Pending";
                                }
                                
                                // Check if payment is overdue (checked out but balance remaining)
                                if (booking.ActualCheckOutDate.HasValue && balanceAmount > 0)
                                {
                                    paymentStatusClass = "payment-badge-overdue";
                                    paymentStatusIcon = "fas fa-exclamation-triangle";
                                    paymentStatusText = "Overdue";
                                }
                                
                                // Urgency flags
                                var isCheckInToday = booking.CheckInDate.Date == DateTime.Today && !booking.ActualCheckInDate.HasValue;
                                var isCheckOutToday = booking.CheckOutDate.Date == DateTime.Today && !booking.ActualCheckOutDate.HasValue;
                                var isArrivingSoon = booking.CheckInDate.Date == DateTime.Today && 
                                                     (booking.CheckInDate - DateTime.Now).TotalHours <= 2 && 
                                                     (booking.CheckInDate - DateTime.Now).TotalHours > 0 &&
                                                     !booking.ActualCheckInDate.HasValue;
                                var isPaymentOverdue = booking.ActualCheckOutDate.HasValue && balanceAmount > 0;
                                
                                // Timeline calculation
                                var totalDays = (booking.CheckOutDate - booking.CheckInDate).Days;
                                var today = DateTime.Today;
                                var progressPercentage = 0.0;
                                
                                if (today < booking.CheckInDate.Date)
                                {
                                    progressPercentage = 0; // Not started
                                }
                                else if (today > booking.CheckOutDate.Date || booking.ActualCheckOutDate.HasValue)
                                {
                                    progressPercentage = 100; // Completed
                                }
                                else
                                {
                                    var daysPassed = (today - booking.CheckInDate.Date).Days;
                                    progressPercentage = totalDays > 0 ? (daysPassed / (double)totalDays) * 100 : 0;
                                }
                            }
                            
                            @* Urgency Flags *@
                            <div class="urgency-flags">
                                @if (isCheckInToday)
                                {
                                    <div class="urgency-flag flag-checkin-today">
                                        <i class="fas fa-flag"></i> Check-in Today
                                    </div>
                                }
                                @if (isCheckOutToday)
                                {
                                    <div class="urgency-flag flag-checkout-today">
                                        <i class="fas fa-flag"></i> Check-out Today
                                    </div>
                                }
                                @if (isArrivingSoon)
                                {
                                    <div class="urgency-flag flag-arriving-soon">
                                        <i class="fas fa-bolt"></i> Arriving Soon
                                    </div>
                                }
                                @if (isPaymentOverdue)
                                {
                                    <div class="urgency-flag flag-payment-overdue">
                                        <i class="fas fa-exclamation-circle"></i> ₹@balanceAmount.ToString("N0") Due
                                    </div>
                                }
                            </div>
                            
                            @* Status Badge *@
                            <span class="status-badge @statusBadgeClass">
                                @if (booking.ActualCheckOutDate.HasValue)
                                {
                                    <i class="fas fa-check-circle"></i> <text>Checked Out</text>
                                }
                                else
                                {
                                    @booking.Status
                                }
                            </span>

                            @* Refund Info (for cancelled bookings) *@
                            @if (booking.Status?.ToLower() == "cancelled" && booking.CancellationRefundAmount.HasValue)
                            {
                                var refundAmt = booking.CancellationRefundAmount.Value;
                                var paidAmt = booking.CancellationAmountPaid ?? 0m;
                                var deductAmt = paidAmt - refundAmt;
                                var isRefunded = booking.CancellationIsRefunded == true;
                                <div style="margin-top:4px; display:flex; flex-wrap:wrap; align-items:center; gap:6px; font-size:10px; font-weight:600;">
                                    <span style="color:#dc3545;"><i class="fas fa-minus-circle"></i> Deducted: ₹@deductAmt.ToString("N0")</span>
                                    <span style="color:#6b7280;">|</span>
                                    <span style="color:#28a745;"><i class="fas fa-undo-alt"></i> Refund: ₹@refundAmt.ToString("N0")</span>
                                    <span style="color:#6b7280;">|</span>
                                    @if (isRefunded)
                                    {
                                        <span style="color:#0369a1;"><i class="fas fa-check-circle"></i> Refunded</span>
                                    }
                                    else
                                    {
                                        <span style="color:#d97706;"><i class="fas fa-clock"></i> Pending</span>
                                    }
                                </div>
                            }
                            
                            @* Payment Status Badge *@
                            <div class="payment-status-badge @paymentStatusClass" style="margin-top: 4px;">
                                <i class="@paymentStatusIcon"></i>
                                <span>@paymentStatusText</span>
                                @if (paymentStatusClass == "payment-badge-partial")
                                {
                                    <div class="payment-progress-bar">
                                        <div class="payment-progress-fill" style="width: @paymentPercentage%"></div>
                                    </div>
                                }
                            </div>
                            
                            @* Visual Timeline Bar *@
                            <div class="booking-timeline-container" style="margin-top: 8px;">
                                <div class="timeline-bar">
                                    <div class="timeline-progress" style="width: @progressPercentage%"></div>
                                </div>
                                <div class="timeline-labels">
                                    <span class="timeline-label-start">@booking.CheckInDate.ToString("dd MMM")</span>
                                    <span class="timeline-label-end">@booking.CheckOutDate.ToString("dd MMM")</span>
                                </div>
                            </div>
                            
                            @if (booking.ActualCheckInDate.HasValue)
                            {
                                <div class="subtext" style="margin-top: 4px; color: #0d6efd; font-weight: 600;">
                                    <i class="fas fa-sign-in-alt" style="font-size: 10px;"></i> Checked In: @booking.ActualCheckInDate.Value.ToString("dd MMM yyyy hh:mm tt")
                                </div>
                            }
                            @if (booking.ActualCheckOutDate.HasValue)
                            {
                                <div class="subtext" style="margin-top: 4px; color: #28a745; font-weight: 600;">
                                    <i class="fas fa-check-circle" style="font-size: 10px;"></i> Checked Out: @booking.ActualCheckOutDate.Value.ToString("dd MMM yyyy hh:mm tt")
                                </div>
                            }
                        </td>
                        <td>@booking.CreatedDate.ToString("dd/MM/yyyy")<br/><span class="subtext">@booking.CreatedDate.ToString("hh:mm tt")</span></td>
                        <td>
                            <div class="dropdown">
                                <button class="btn-action-dropdown" onclick="toggleDropdown(event, 'dropdown-@booking.BookingNumber')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="dropdown-@booking.BookingNumber" class="dropdown-menu">
                                    <a asp-action="Details" asp-route-bookingNumber="@booking.BookingNumber" class="dropdown-item">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>

                                    @* Only show other options if booking is NOT checked out and NOT cancelled *@
                                    @if (!booking.ActualCheckOutDate.HasValue && booking.Status != "Cancelled")
                                    {
                                        <a href="#" onclick="openOtherChargesModal('@booking.BookingNumber'); return false;" class="dropdown-item">
                                            <i class="fas fa-receipt"></i> Other Charges
                                        </a>
                                        
                                        @if (booking.ActualCheckInDate.HasValue)
                                        {
                                            <a href="#" onclick="checkoutGuest('@booking.BookingNumber', '@booking.Room?.Id')" class="dropdown-item" style="color: #059669;">
                                                <i class="fas fa-sign-out-alt"></i> Check Out Guest
                                            </a>
                                            <hr class="dropdown-divider" />
                                        }
                                        @if (booking.Room == null)
                                        {
                                            <a href="#" onclick="assignRoom('@booking.BookingNumber')" class="dropdown-item">
                                                <i class="fas fa-door-open"></i> Assign Room
                                            </a>
                                        }
                                        else
                                        {
                                            <a href="#" onclick="changeRoom('@booking.BookingNumber')" class="dropdown-item">
                                                <i class="fas fa-exchange-alt"></i> Change Room
                                            </a>
                                        }
                                        <a href="#" onclick="editRoomType('@booking.BookingNumber')" class="dropdown-item">
                                            <i class="fas fa-bed"></i> Edit Room Type
                                        </a>
                                        <a href="#" onclick="editDates('@booking.BookingNumber')" class="dropdown-item">
                                            <i class="fas fa-calendar-alt"></i> Edit Dates
                                        </a>
                                        <hr class="dropdown-divider" />
                                        <a href="#" onclick="cancelBooking('@booking.BookingNumber')" class="dropdown-item text-danger">
                                            <i class="fas fa-times-circle"></i> Cancel Booking
                                        </a>
                                    }
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="empty-state">
        <i class="fas fa-calendar-check"></i>
        <h3>No bookings yet</h3>
        <p>Create your first booking to get started.</p>
        <a asp-action="Create" class="btn-create">
            <i class="fas fa-plus"></i> Add Booking
        </a>
    </div>
}

<style>
    /* Booking cards should look identical to Rooms Dashboard cards */
    .booking-status-cards {
        margin-bottom: 30px;
    }

    /* Fallback in case room-dashboard.css is not loaded for some reason */
    .booking-status-cards.status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
    }

    /* Date Filters */
    .filters-container {
        background: white;
        border-radius: 12px;
        padding: 20px 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .date-filter-form {
        display: flex;
        align-items: flex-end;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
        min-width: 180px;
    }

    .filter-group label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
    }

    .filter-group .form-control {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .filter-group .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-filter-apply, .btn-filter-clear {
        padding: 8px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        border: none;
    }

    .btn-filter-apply {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-filter-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-filter-clear {
        background: white;
        color: #6b7280;
        border: 2px solid #e5e7eb;
    }

    .btn-filter-clear:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #374151;
    }

    /* Note: We intentionally reuse global `.status-cards`/`.status-card` styles */

    /* Compact row override */
    .data-table tbody td {
        padding: 7px 10px !important;
        font-size: 13px;
        vertical-align: middle;
    }
    .data-table thead th {
        padding: 10px 10px !important;
        font-size: 12px;
    }
    .subtext {
        font-size: 11px;
        color: #6b7280;
        margin-top: 1px;
    }

    .data-table .dropdown {
        position: relative;
        display: inline-block;
    }

    .data-table .btn-action-dropdown {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 32px;
    }

    .data-table .btn-action-dropdown:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .data-table .btn-action-dropdown:active {
        transform: translateY(0);
    }

    .data-table .dropdown-menu {
        display: none;
        position: fixed;
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
        width: max-content;
        min-width: 180px;
        max-width: min(260px, calc(100vw - 16px));
        z-index: 10000;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .data-table .dropdown-menu.show {
        display: block;
        animation: dropdownSlide 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-15px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .data-table .dropdown-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        color: #374151;
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 12px;
        font-weight: 500;
        border: none;
        width: 100%;
        text-align: left;
        background: white;
        cursor: pointer;
        white-space: nowrap;
    }

    .data-table .dropdown-item:hover {
        background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
        color: #0369a1;
        padding-left: 16px;
    }

    .data-table .dropdown-item i {
        margin-right: 8px;
        width: 14px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .data-table .dropdown-item.text-danger {
        color: #dc2626;
    }

    .data-table .dropdown-item.text-danger:hover {
        background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%);
        color: #b91c1c;
    }

    .data-table .dropdown-divider {
        margin: 2px 6px;
        border: none;
        border-top: 1px solid #f1f5f9;
    }

    .text-muted {
        color: #a0aec0 !important;
        font-style: italic;
    }
    
    /* Color-Coded Status Badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }
    
    .status-badge i {
        font-size: 10px;
    }
    
    /* Blue - Confirmed */
    .status-badge-confirmed {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Green - Checked In */
    .status-badge-checkedin {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Yellow/Orange - Pending */
    .status-badge-pending {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Gray - Checked Out */
    .status-badge-checkedout {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Red - Cancelled */
    .status-badge-cancelled {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .status-badge-default {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Payment Status Badges */
    .payment-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 7px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    
    .payment-status-badge i {
        font-size: 10px;
    }
    
    /* Green with checkmark - Fully Paid */
    .payment-badge-fullypaid {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Orange with progress bar - Partial */
    .payment-badge-partial {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .payment-progress-bar {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .payment-progress-fill {
        height: 100%;
        background: white;
        border-radius: 2px;
        transition: width 0.5s ease;
    }
    
    /* Red pulsing - Overdue */
    .payment-badge-overdue {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: pulse-payment 2s ease-in-out infinite;
    }
    
    @@keyframes pulse-payment {
        0%, 100% { 
            opacity: 1;
            transform: scale(1);
        }
        50% { 
            opacity: 0.85;
            transform: scale(1.02);
        }
    }
    
    /* Yellow - Pending */
    .payment-badge-pending {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #78350f;
        border: 1px solid rgba(120, 53, 15, 0.2);
    }
    
    /* Urgency Flags */
    .urgency-flags {
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        margin-bottom: 4px;
    }
    
    .urgency-flag {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .urgency-flag i {
        font-size: 9px;
    }
    
    /* Red flag - Check-in today */
    .flag-checkin-today {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Orange flag - Check-out today */
    .flag-checkout-today {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Animated - Arriving within 2 hours */
    .flag-arriving-soon {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: blink-flag 1s ease-in-out infinite;
    }
    
    @@keyframes blink-flag {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .flag-arriving-soon i {
        animation: shake-icon 0.5s ease-in-out infinite;
    }
    
    @@keyframes shake-icon {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
    }
    
    /* Red badge - Payment overdue */
    .flag-payment-overdue {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: pulse-overdue 2s ease-in-out infinite;
    }
    
    @@keyframes pulse-overdue {
        0%, 100% { 
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
        }
        50% { 
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.6);
        }
    }
    
    /* Visual Timeline Bar */
    .booking-timeline-container {
        width: 100%;
    }
    
    .timeline-bar {
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 100%);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .timeline-progress {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.5s ease;
        position: relative;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    .timeline-progress::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255, 255, 255, 0.3) 50%, 
            transparent 100%);
        animation: shimmer-timeline 2s infinite;
    }
    
    @@keyframes shimmer-timeline {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .timeline-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
        font-size: 9px;
        color: #6b7280;
        font-weight: 600;
    }

    @@media (max-width: 768px) {
        .dashboard-cards {
            grid-template-columns: 1fr;
        }

        .dashboard-card {
            padding: 20px;
        }

        .dashboard-card .card-icon {
            width: 50px;
            height: 50px;
            font-size: 24px;
        }

        .dashboard-card .card-content h3 {
            font-size: 24px;
        }
    }

    .toast-stack {
        position: fixed;
        top: 80px;
        right: 16px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: min(520px, calc(100vw - 32px));
    }

    .toast-item {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .toast-close {
        margin-left: auto;
        background: transparent;
        border: none;
        padding: 0 4px;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        color: inherit;
    }

    .toast-hidden {
        opacity: 0;
        transform: translateY(-8px);
        pointer-events: none;
        transition: opacity 200ms ease, transform 200ms ease;
    }
</style>

<script>
    (function () {
        const toasts = document.querySelectorAll('[data-toast]');
        if (!toasts || toasts.length === 0) return;

        function hideToast(toast) {
            if (!toast || toast.classList.contains('toast-hidden')) return;
            toast.classList.add('toast-hidden');
            window.setTimeout(() => toast.remove(), 250);
        }

        toasts.forEach(toast => {
            const closeBtn = toast.querySelector('.toast-close');
            if (closeBtn) closeBtn.addEventListener('click', () => hideToast(toast));
            window.setTimeout(() => hideToast(toast), 3500);
        });
    })();

    // Toggle to `true` temporarily while debugging dropdown close behavior.
    const BOOKING_DROPDOWN_DEBUG = false;
    function bookingDropdownLog(...args) {
        if (BOOKING_DROPDOWN_DEBUG && window?.console) console.log('[BookingDropdown]', ...args);
    }

    // ----- Booking List action dropdown helpers -----
    function closeAllBookingActionDropdowns(exceptId) {
        bookingDropdownLog('closeAllBookingActionDropdowns', { exceptId });
        document.querySelectorAll('.data-table .dropdown-menu.show').forEach(menu => {
            if (!exceptId || menu.id !== exceptId) {
                menu.classList.remove('show');
                // Clear any inline styles used for positioning so CSS can hide it.
                menu.style.left = '';
                menu.style.top = '';
                menu.style.right = '';
                menu.style.visibility = '';
            }
        });
    }

    function toggleDropdown(event, dropdownId) {
        event.preventDefault();
        event.stopPropagation();
        
        const button = event.currentTarget;
        const dropdown = document.getElementById(dropdownId);

        bookingDropdownLog('toggleDropdown', { dropdownId, hasDropdown: !!dropdown });
        if (!dropdown) return;
        
        // Close all other booking-row dropdowns
        closeAllBookingActionDropdowns(dropdownId);
        
        // Toggle current dropdown
        const isShown = dropdown.classList.contains('show');
        
        if (!isShown) {
            // Position dropdown relative to button
            const rect = button.getBoundingClientRect();
            const gap = 6;
            const margin = 8;

            // Make it measurable using CSS-controlled display via `.show`.
            dropdown.style.visibility = 'hidden';
            dropdown.classList.add('show');

            const menuWidth = dropdown.offsetWidth || 180;
            const menuHeight = dropdown.offsetHeight || 0;

            // Prefer opening down-right aligned to the button.
            let left = rect.right - menuWidth;
            let top = rect.bottom + gap;

            // Clamp horizontally to viewport
            left = Math.max(margin, Math.min(left, window.innerWidth - menuWidth - margin));

            // If it would overflow bottom, open upwards.
            if (menuHeight && top + menuHeight + margin > window.innerHeight) {
                top = rect.top - menuHeight - gap;
            }

            top = Math.max(margin, Math.min(top, window.innerHeight - (menuHeight || 0) - margin));

            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.right = 'auto';
            dropdown.style.visibility = 'visible';
            bookingDropdownLog('opened', { dropdownId, left, top });
        } else {
            dropdown.classList.remove('show');
            dropdown.style.left = '';
            dropdown.style.top = '';
            dropdown.style.right = '';
            dropdown.style.visibility = '';
            bookingDropdownLog('closed', { dropdownId });
        }
    }

    // Ensure the close handlers are attached even if other scripts override bubbling.
    // Use pointerdown (fires earlier than click) + capture phase.
    window.addEventListener('pointerdown', function(event) {
        bookingDropdownLog('pointerdown', { target: event.target?.tagName, inside: !!event.target.closest('.data-table .dropdown, .data-table .dropdown-menu') });
        if (!event.target.closest('.data-table .dropdown') && !event.target.closest('.data-table .dropdown-menu')) {
            closeAllBookingActionDropdowns();
        }
    }, true);

    // Close on ESC (capture phase)
    window.addEventListener('keydown', function(event) {
        bookingDropdownLog('keydown', { key: event.key });
        if (event.key === 'Escape') {
            closeAllBookingActionDropdowns();
        }
    }, true);

    // Close when a dropdown item is clicked.
    // IMPORTANT: do NOT close on pointerdown, otherwise the subsequent click may not fire
    // (because the element becomes hidden before pointerup/click).
    window.addEventListener('click', function(event) {
        if (event.target.closest('.data-table .dropdown-menu .dropdown-item')) {
            setTimeout(() => closeAllBookingActionDropdowns(), 0);
        }
    }, true);

    // Close ONLY booking-row action dropdowns on scroll
    window.addEventListener('scroll', function() {
        closeAllBookingActionDropdowns();
    }, true);

    // Extra safety: close if focus moves elsewhere or viewport changes.
    window.addEventListener('focusin', function(event) {
        if (!event.target.closest('.data-table .dropdown') && !event.target.closest('.data-table .dropdown-menu')) {
            closeAllBookingActionDropdowns();
        }
    }, true);

    window.addEventListener('resize', function() {
        closeAllBookingActionDropdowns();
    }, true);

    function assignRoom(bookingNumber) {
        window.location.href = '/Booking/AssignRoom?bookingNumber=' + bookingNumber;
    }

    function changeRoom(bookingNumber) {
        window.location.href = '/Booking/AssignRoom?bookingNumber=' + bookingNumber;
    }

    function editRoomType(bookingNumber) {
        window.location.href = '/Booking/EditRoomType?bookingNumber=' + bookingNumber;
    }

    function editDates(bookingNumber) {
        window.location.href = '/Booking/EditDates?bookingNumber=' + bookingNumber;
    }

    async function cancelBooking(bookingNumber) {
        const antiForgeryToken = () => document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        // ── Step 1: Fetch cancellation preview ────────────────────────────────
        Swal.fire({ title: 'Loading Preview…', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        let preview = null;
        try {
            const r = await fetch('/Booking/CancellationPreview?bookingNumber=' + encodeURIComponent(bookingNumber));
            const d = await r.json();
            if (d.success) preview = d;
        } catch (e) { console.error('Preview error:', e); }

        // ── Step 2: Build preview card ────────────────────────────────────────
        function buildPreviewHtml(title) {
            let html = `<p style="margin-bottom:10px;">${title}</p>`;
            if (preview) {
                const hrs  = preview.hoursBeforeCheckIn != null ? `${Math.round(preview.hoursBeforeCheckIn)} hrs before check-in` : '—';
                const paid = preview.amountPaid   != null ? '₹' + Number(preview.amountPaid).toLocaleString('en-IN',{minimumFractionDigits:2})   : '—';
                const ref  = preview.refundAmount != null ? '₹' + Number(preview.refundAmount).toLocaleString('en-IN',{minimumFractionDigits:2}) : '—';
                const refColor = (preview.refundAmount > 0) ? '#059669' : '#dc2626';
                const pctLabel = preview.refundPercent != null && preview.refundPercent > 0 ? ` (${preview.refundPercent}%)` : '';
                html += `<div style="background:#f8f9fa;border-radius:8px;padding:12px 16px;margin:10px 0;text-align:left;font-size:0.9rem;border:1px solid #e5e7eb;">
                    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #e5e7eb;"><span style="color:#6b7280;">Amount Paid</span><strong>${paid}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #e5e7eb;"><span style="color:#6b7280;">Eligible Refund</span><strong style="color:${refColor};">${ref}${pctLabel}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:5px 0;"><span style="color:#6b7280;">Time to Check-in</span><span>${hrs}</span></div>
                </div>`;
                if (preview.policyName) {
                    html += `<p style="font-size:0.82rem;color:#6b7280;margin:4px 0 6px;"><i class="fas fa-file-alt"></i>&nbsp;Policy: <strong>${preview.policyName}</strong></p>`;
                }
                if (preview.refundBreakdownNote) {
                    html += `<p style="font-size:0.82rem;color:#6b7280;margin:4px 0 6px;"><i class="fas fa-info-circle"></i>&nbsp;${preview.refundBreakdownNote}</p>`;
                }
                if (preview.approvalStatus === 'Pending') {
                    html += `<p style="color:#d97706;font-size:0.83rem;margin:6px 0;"><i class="fas fa-clock"></i>&nbsp;Refund requires manager approval before processing.</p>`;
                }
            }
            html += `<div style="margin-top:12px;text-align:left;">
                <label style="font-size:0.85rem;color:#6b7280;display:block;margin-bottom:4px;">Reason for cancellation <span style="opacity:.6;">(optional)</span></label>
                <textarea id="swal-cancel-reason" class="swal2-textarea" placeholder="Enter reason…" style="margin:0;width:100%;box-sizing:border-box;font-size:0.9rem;min-height:64px;"></textarea>
            </div>
            <p style="margin-top:10px;color:#ef4444;font-size:0.8rem;">⚠️ This action cannot be undone.</p>`;
            return html;
        }

        // ── Step 3: Confirmation dialog ───────────────────────────────────────
        const confirm1 = await Swal.fire({
            title: 'Cancel Booking?',
            html: buildPreviewHtml(`You are about to cancel booking <strong>${bookingNumber}</strong>.`),
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fas fa-times-circle"></i>&nbsp;Yes, Cancel Booking',
            cancelButtonText: 'Go Back',
            width: 520,
            preConfirm: () => document.getElementById('swal-cancel-reason')?.value?.trim() || ''
        });
        if (!confirm1.isConfirmed) return;
        const reason = confirm1.value || '';

        // ── Step 4: POST cancel request ───────────────────────────────────────
        async function doCancel(isOverride, overrideReason) {
            Swal.fire({ title: 'Processing Cancellation…', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const resp = await fetch('/Booking/Cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': antiForgeryToken() },
                body: JSON.stringify({ bookingNumber, reason, isOverride, overrideReason: overrideReason || '' })
            });
            return resp.json();
        }

        try {
            let data = await doCancel(false, '');

            // ── Step 5: Handle checked-in override scenario ───────────────────
            if (!data.success && data.requiresOverride) {
                const overrideResult = await Swal.fire({
                    title: '⚠️ Guest Is Currently Checked In',
                    html: `<p style="color:#dc2626;font-weight:600;margin-bottom:10px;">This guest has already checked in.</p>
                           <p>Cancelling an active stay is a non-standard operation and requires manager authorisation.</p>
                           <div style="margin-top:12px;text-align:left;">
                               <label style="font-size:0.85rem;color:#6b7280;display:block;margin-bottom:4px;">Override reason <span style="color:#ef4444;">*</span></label>
                               <textarea id="swal-override-reason" class="swal2-textarea" placeholder="e.g. Guest requested early departure, emergency…" style="margin:0;width:100%;box-sizing:border-box;font-size:0.9rem;min-height:72px;"></textarea>
                           </div>`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-exclamation-triangle"></i>&nbsp;Force Cancel (Override)',
                    cancelButtonText: 'Abort',
                    width: 520,
                    preConfirm: () => {
                        const val = document.getElementById('swal-override-reason')?.value?.trim() || '';
                        if (!val) { Swal.showValidationMessage('An override reason is required.'); return false; }
                        return val;
                    }
                });
                if (!overrideResult.isConfirmed) return;
                data = await doCancel(true, overrideResult.value);
            }

            // ── Step 6: Result feedback ───────────────────────────────────────
            if (data.success) {
                let successHtml = `<p>${data.message || 'Booking cancelled successfully.'}</p>`;
                if (data.refundAmount != null && data.refundAmount > 0) {
                    successHtml += `<p>Refund of <strong>₹${Number(data.refundAmount).toLocaleString('en-IN',{minimumFractionDigits:2})}</strong> is applicable.</p>`;
                }
                if (data.approvalStatus === 'Pending') {
                    successHtml += `<p style="color:#d97706;font-size:0.85rem;">⏳ Awaiting manager approval to process refund.</p>`;
                }
                await Swal.fire({ icon: 'success', title: 'Booking Cancelled', html: successHtml, confirmButtonColor: '#059669', timer: 3500, timerProgressBar: true });
                window.location.reload();
            } else {
                Swal.fire({ icon: 'error', title: 'Cancellation Failed', text: data.message || 'An unexpected error occurred.', confirmButtonColor: '#ef4444' });
            }
        } catch (err) {
            console.error('Cancel error:', err);
            Swal.fire({ icon: 'error', title: 'Request Failed', text: 'Unable to reach the server. Please try again.', confirmButtonColor: '#ef4444' });
        }
    }

    function checkoutGuest(bookingNumber, roomId) {
        if (!roomId || roomId === '') {
            Swal.fire({
                icon: 'warning',
                title: 'No Room Assigned',
                text: 'This booking does not have a room assigned yet.'
            });
            return;
        }

        Swal.fire({
            title: 'Checkout Confirmation',
            html: `<p>Are you sure you want to check out guest for booking:</p><p><strong>${bookingNumber}</strong></p>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#059669',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, checkout!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'Processing...',
                    text: 'Checking payment status and processing checkout',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Call checkout endpoint
                fetch('@Url.Action("CheckoutRoom", "Rooms")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ roomId: parseInt(roomId) })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Checkout Successful',
                            text: data.message,
                            timer: 2000
                        }).then(() => {
                            location.reload();
                        });
                    } else if (data.requiresPayment) {
                        // Payment not cleared - show alert and redirect to payment
                        Swal.fire({
                            icon: 'warning',
                            title: 'Payment Not Cleared',
                            html: `
                                <p><strong>Booking:</strong> ${data.bookingNumber}</p>
                                <p><strong>Balance Amount:</strong> ₹${data.balanceAmount.toLocaleString()}</p>
                                <p>Please clear the payment before checkout.</p>
                            `,
                            confirmButtonColor: '#059669',
                            confirmButtonText: 'Go to Payment'
                        }).then(() => {
                            // Redirect to booking details page where payment can be made
                            window.location.href = '@Url.Action("Details", "Booking")?bookingNumber=' + data.bookingNumber;
                        });
                    } else {
                        // Check if booking not found - offer force checkout
                        if (data && (data.isExpired === true || (data.message && data.message.includes('No active booking found')))) {
                            const detectedDateText = data.detectedCheckOutDate
                                ? new Date(data.detectedCheckOutDate).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' })
                                : null;
                            const expiredHtml = detectedDateText
                                ? `<p>This booking was expected to check out on <strong>${detectedDateText}</strong>.</p>`
                                : `<p>The checkout date for this booking has passed.</p>`;

                            Swal.fire({
                                icon: 'warning',
                                title: 'Booking Expired',
                                html: `
                                    ${expiredHtml}
                                    <p>Would you like to <strong>Force Checkout</strong>?</p>
                                `,
                                showCancelButton: true,
                                confirmButtonColor: '#dc3545',
                                cancelButtonColor: '#6c757d',
                                confirmButtonText: 'Force Checkout'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    forceCheckoutRoom(roomId);
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Checkout Failed',
                                text: data.message
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking out guest:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to check out guest: ' + error.message
                    });
                });
            }
        });
    }

    function forceCheckoutRoom(roomId) {
        Swal.fire({
            title: 'Processing Force Checkout...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('@Url.Action("ForceCheckoutRoom", "Rooms")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ roomId: parseInt(roomId) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Force Checkout Successful',
                    text: data.message,
                    timer: 2000
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Force Checkout Failed',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Error force checking out room:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to force checkout: ' + error.message
            });
        });
    }

    // Client-side search function
    function searchTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('bookingTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const bookingNumber = row.cells[0].textContent.toLowerCase();
            const guestName = row.cells[1].textContent.toLowerCase();
            const roomType = row.cells[3].textContent.toLowerCase();
            
            if (bookingNumber.includes(filter) || guestName.includes(filter) || roomType.includes(filter)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        // Update search input style based on results
        if (filter && visibleCount === 0) {
            input.style.borderColor = '#ef4444';
        } else if (filter && visibleCount > 0) {
            input.style.borderColor = '#10b981';
        } else {
            input.style.borderColor = '#e0e0e0';
        }
    }

    // Export to Excel
    function exportToExcel() {
        const fromDate = '@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")';
        const toDate = '@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")';
        const statusFilter = '@(Model.StatusFilter ?? "")';
        let url = '@Url.Action("ExportToExcel", "Booking")';
        
        const params = new URLSearchParams();
        if (fromDate) params.append('fromDate', fromDate);
        if (toDate) params.append('toDate', toDate);
        if (statusFilter) params.append('statusFilter', statusFilter);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.location.href = url;
    }

    // Export to PDF
    function exportToPDF() {
        const fromDate = '@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")';
        const toDate = '@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")';
        const statusFilter = '@(Model.StatusFilter ?? "")';
        let url = '@Url.Action("ExportToPDF", "Booking")';
        
        const params = new URLSearchParams();
        if (fromDate) params.append('fromDate', fromDate);
        if (toDate) params.append('toDate', toDate);
        if (statusFilter) params.append('statusFilter', statusFilter);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.open(url, '_blank');
    }

    // Hover effect for export buttons
    document.querySelectorAll('.btn-export').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // Focus effect for search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('focus', function() {
            this.style.borderColor = '#667eea';
            this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
        });
        searchInput.addEventListener('blur', function() {
            if (!this.value) {
                this.style.borderColor = '#e0e0e0';
                this.style.boxShadow = 'none';
            }
        });
    }

</script>

@await Html.PartialAsync("_OtherChargesModal")
