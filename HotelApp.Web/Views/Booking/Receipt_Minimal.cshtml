@model HotelApp.Web.Models.Booking
@{
    ViewData["Title"] = $"Receipt - {Model.BookingNumber}";
    Layout = null;
    var hotelSettings = ViewBag.HotelSettings as HotelApp.Web.Models.HotelSettings;
    var payments = ViewBag.Payments as IEnumerable<HotelApp.Web.Models.BookingPayment> ?? Enumerable.Empty<HotelApp.Web.Models.BookingPayment>();
    var totalPaid = payments.Sum(x => x.Amount);

    var roomServiceLines = ViewBag.RoomServiceLines as IEnumerable<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>();
    var roomServiceLinesList = roomServiceLines.ToList();
    var rsOrders = roomServiceLinesList.GroupBy(x => x.OrderId).Select(g => g.First()).ToList();
    var rsActualBillTotal = rsOrders.Sum(x => x.ActualBillAmount);

    var bookingOtherCharges = ViewBag.BookingOtherCharges as IEnumerable<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>();
    var ocAmountTotal = bookingOtherCharges.Sum(x => x.Rate * (x.Qty <= 0 ? 1 : x.Qty));
    var ocGstTotal = bookingOtherCharges.Sum(x => x.GSTAmount);
    var ocGrandTotal = ocAmountTotal + ocGstTotal;

    var receiptAdjustedGrandTotal = ViewBag.ReceiptAdjustedGrandTotal is decimal serverGrandTotal
        ? serverGrandTotal
        : (Model.TotalAmount + ocGrandTotal + rsActualBillTotal);

    var paymentRoundOffTotal = payments.Where(p => p.IsRoundOffApplied).Sum(p => p.RoundOffAmount);

    var appliedToBalanceFromPayments = payments.Sum(p =>
        p.Amount
        + p.DiscountAmount
    );

    var receiptAdjustedFinalPayable = receiptAdjustedGrandTotal + paymentRoundOffTotal;
    var receiptAdjustedBalanceDueRaw = receiptAdjustedFinalPayable - appliedToBalanceFromPayments;
    var receiptAdjustedBalanceDueComputed = Math.Max(0m, Math.Round(receiptAdjustedBalanceDueRaw, 2, MidpointRounding.AwayFromZero));
    var receiptAdjustedBalanceDue = ViewBag.ReceiptAdjustedBalanceDue is decimal serverBalanceDue
        ? serverBalanceDue
        : receiptAdjustedBalanceDueComputed;

    var paymentDiscountTotal = payments.Sum(p => p.DiscountAmount);

    var showDueQr = ViewBag.ShowDueQr is bool b && b;
    var dueQrUrl = ViewBag.DueQrUrl as string;
    var showDueQrBlock = receiptAdjustedBalanceDue > 0m;
    var isCancelled = string.Equals(Model.Status, "Cancelled", StringComparison.OrdinalIgnoreCase);
    var cancellationRecord = ViewBag.CancellationRecord as HotelApp.Web.Models.BookingCancellationRecord;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: "Times New Roman", Times, serif; color: #000; margin: 0; }
        .paper { max-width: 760px; margin: 0 auto; padding: 18px; }

        .print-button {
            position: fixed;
            top: 14px;
            right: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid #000;
            background: #000;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            z-index: 9999;
        }

        .print-button svg { display: block; }
        .center { text-align: center; }
        .title { font-size: 18px; font-weight: 700; }
        .small { font-size: 12px; }
        .line { border-top: 1px solid #000; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 6px 4px; font-size: 12px; }
        th { border-bottom: 1px solid #000; text-transform: uppercase; }
        tbody td { border-bottom: 1px solid #ddd; }
        .r { text-align: right; }
        .b { font-weight: 700; }
        .muted { color: #333; }
        @@media print {
            @@page { size: A4; margin: 10mm; }
            .paper { padding: 0; max-width: none; }
            .print-button { display: none !important; }
        }
    </style>
</head>
<body>
    <button type="button" class="print-button" onclick="window.print()" aria-label="Print receipt">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9V2h12v7" />
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
            <rect x="6" y="14" width="12" height="8" />
        </svg>
        Print
    </button>
    <div class="paper">
        <div class="center">
            <div class="title">@(string.IsNullOrWhiteSpace(hotelSettings?.HotelName) ? "LuxStay Hotel" : hotelSettings!.HotelName)</div>
            @if (!string.IsNullOrWhiteSpace(hotelSettings?.Address))
            {
                <div class="small">@hotelSettings!.Address</div>
            }
            @if (!string.IsNullOrWhiteSpace(hotelSettings?.ContactNumber1))
            {
                <div class="small">@hotelSettings!.ContactNumber1</div>
            }
            @if (!string.IsNullOrWhiteSpace(hotelSettings?.GSTCode))
            {
                <div class="small">GST: @hotelSettings!.GSTCode</div>
            }
        </div>

        <div class="line"></div>

        <table>
            <tbody>
                <tr>
                    <td class="b">Receipt</td>
                    <td class="r">@Model.BookingNumber</td>
                </tr>
                <tr>
                    <td class="b">Date</td>
                    <td class="r">@DateTime.Now.ToString("dd MMM yyyy")</td>
                </tr>
                <tr>
                    <td class="b">Guest</td>
                    <td class="r">@($"{Model.PrimaryGuestFirstName} {Model.PrimaryGuestLastName}".Trim())</td>
                </tr>
                <tr>
                    <td class="b">Stay</td>
                    <td class="r">@Model.CheckInDate.ToString("dd MMM yyyy") - @Model.CheckOutDate.ToString("dd MMM yyyy")</td>
                </tr>
            </tbody>
                    <tr>
                        <td class="b">Phone</td>
                        <td class="r">@(!string.IsNullOrWhiteSpace(Model.PrimaryGuestPhone) ? Model.PrimaryGuestPhone : "-")</td>
                    </tr>
                    <tr>
                        <td class="b">Email</td>
                        <td class="r">@(!string.IsNullOrWhiteSpace(Model.PrimaryGuestEmail) ? Model.PrimaryGuestEmail : "-")</td>
                    </tr>
        </table>

        <div class="line"></div>

                    <tr>
                        <td class="b">Guests</td>
                        <td class="r">@Model.Adults A / @Model.Children C</td>
                    </tr>
                    <tr>
                        <td class="b">Room</td>
                        <td class="r">@(Model.RoomType?.TypeName ?? "-") • @Model.RequiredRooms room(s)</td>
                    </tr>
        <table>
            <thead>
                <tr>
                    <th>Head</th>
                    <th class="r">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Room (incl. taxes)</td><td class="r">₹@Model.TotalAmount.ToString("N2")</td></tr>
                <tr><td>Other Charges (incl. GST)</td><td class="r">₹@ocGrandTotal.ToString("N2")</td></tr>
                <tr><td>Room Service</td><td class="r">₹@rsActualBillTotal.ToString("N2")</td></tr>
                <tr class="b"><td>Grand Total</td><td class="r">₹@receiptAdjustedGrandTotal.ToString("N2")</td></tr>
                <tr class="b"><td>Paid</td><td class="r">₹@totalPaid.ToString("N2")</td></tr>
                <tr class="b"><td>Payment Discounts</td><td class="r">₹@paymentDiscountTotal.ToString("N2")</td></tr>
                <tr class="b"><td>Round-off</td><td class="r">₹@paymentRoundOffTotal.ToString("N2")</td></tr>
                @if (isCancelled && cancellationRecord != null)
                {
                    var crDeduct = cancellationRecord.AmountPaid - cancellationRecord.RefundAmount;
                    <tr class="b"><td style="color:#dc2626;">Deducted</td><td class="r" style="color:#dc2626;">₹@crDeduct.ToString("N2")</td></tr>
                    <tr class="b"><td style="color:#16a34a;">Refund Amount</td><td class="r" style="color:#16a34a;">₹@cancellationRecord.RefundAmount.ToString("N2")</td></tr>
                    <tr class="b"><td>Refund Status</td><td class="r" style="color:@(cancellationRecord.IsRefunded ? "#0369a1" : "#d97706");">
                        @(cancellationRecord.IsRefunded ? "REFUNDED" : "REFUND PENDING")
                    </td></tr>
                }
                else
                {
                    <tr class="b"><td>Due</td><td class="r">₹@receiptAdjustedBalanceDue.ToString("N2")</td></tr>
                }
            </tbody>
        </table>

        @if (payments.Any())
        {
            <div class="line"></div>
            <div class="b" style="margin-bottom:6px;">Payments</div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Method</th>
                        <th class="r">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in payments.OrderBy(x => x.PaidOn))
                    {
                        <tr>
                            <td>@p.PaidOn.ToString("dd MMM yyyy")</td>
                            <td>@p.PaymentMethod</td>
                            <td class="r">₹@p.Amount.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (bookingOtherCharges.Any())
        {
            <div class="line"></div>
            <div class="b" style="margin-bottom:6px;">Other Charges</div>
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Date</th>
                        <th class="r">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var oc in bookingOtherCharges.OrderBy(x => x.ChargeDate))
                    {
                        var safeQty = oc.Qty <= 0 ? 1 : oc.Qty;
                        var total = (oc.Rate * safeQty) + oc.GSTAmount;
                        <tr>
                            <td>@oc.Code</td>
                            <td>@oc.ChargeDate.ToString("dd MMM yyyy")</td>
                            <td class="r">₹@total.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (showDueQr && showDueQrBlock && !string.IsNullOrWhiteSpace(dueQrUrl))
        {
            <div class="line"></div>
            <div class="b" style="margin-bottom:6px;">Pay Due (UPI QR)</div>
            <div class="small muted">Scan to pay ₹@receiptAdjustedBalanceDue.ToString("N2")</div>
            <div style="margin-top:10px; text-align:center;">
                <img src="@dueQrUrl" alt="UPI QR" style="width: 160px; height: 160px; object-fit: contain;" />
            </div>
        }

        <div class="line"></div>

        <div class="center small">Thank you.</div>
    </div>
</body>
</html>
