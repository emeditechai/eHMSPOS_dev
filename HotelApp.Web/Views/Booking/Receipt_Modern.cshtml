@model HotelApp.Web.Models.Booking
@{
    ViewData["Title"] = $"Receipt - {Model.BookingNumber}";
    Layout = null;
    var hotelSettings = ViewBag.HotelSettings as HotelApp.Web.Models.HotelSettings;
    var payments = ViewBag.Payments as IEnumerable<HotelApp.Web.Models.BookingPayment> ?? Enumerable.Empty<HotelApp.Web.Models.BookingPayment>();
    var totalPaid = payments.Sum(p => p.Amount);
    var receiptIssueDate = DateTime.Now;

    // Room Service (for receipt display + totals)
    var roomServiceLines = ViewBag.RoomServiceLines as IEnumerable<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>();
    var roomServiceLinesList = roomServiceLines.ToList();
    var rsOrders = roomServiceLinesList.GroupBy(x => x.OrderId).Select(g => g.First()).ToList();
    var rsActualBillTotal = rsOrders.Sum(x => x.ActualBillAmount);
    var rsDiscountTotal = rsOrders.Sum(x => x.DiscountAmount);
    var rsGstTotal = rsOrders.Sum(x => x.GSTAmount);
    var rsCgstTotal = rsOrders.Sum(x => x.CGSTAmount);
    var rsSgstTotal = rsOrders.Sum(x => x.SGSTAmount);

    // Other Charges (for receipt display + totals)
    var bookingOtherCharges = ViewBag.BookingOtherCharges as IEnumerable<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>();
    var ocAmountTotal = bookingOtherCharges.Sum(x => x.Rate * (x.Qty <= 0 ? 1 : x.Qty));
    var ocGstTotal = bookingOtherCharges.Sum(x => x.GSTAmount);
    var ocCgstTotal = bookingOtherCharges.Sum(x => x.CGSTAmount);
    var ocSgstTotal = bookingOtherCharges.Sum(x => x.SGSTAmount);
    var ocGrandTotal = ocAmountTotal + ocGstTotal;

    var receiptAdjustedGrandTotal = ViewBag.ReceiptAdjustedGrandTotal is decimal serverGrandTotal
        ? serverGrandTotal
        : (Model.TotalAmount + ocGrandTotal + rsActualBillTotal);

    var paymentRoundOffTotal = payments.Where(p => p.IsRoundOffApplied).Sum(p => p.RoundOffAmount);

    var appliedToBalanceFromPayments = payments.Sum(p =>
        p.Amount
        + p.DiscountAmount
    );

    var receiptAdjustedFinalPayable = receiptAdjustedGrandTotal + paymentRoundOffTotal;
    var receiptAdjustedBalanceDueRaw = receiptAdjustedFinalPayable - appliedToBalanceFromPayments;
    var receiptAdjustedBalanceDueComputed = Math.Max(0m, Math.Round(receiptAdjustedBalanceDueRaw, 2, MidpointRounding.AwayFromZero));
    var receiptAdjustedBalanceDue = ViewBag.ReceiptAdjustedBalanceDue is decimal serverBalanceDue
        ? serverBalanceDue
        : receiptAdjustedBalanceDueComputed;

    var paymentDiscountTotal = payments.Sum(p => p.DiscountAmount);

    var showDueQr = ViewBag.ShowDueQr is bool b && b;
    var dueQrUrl = ViewBag.DueQrUrl as string;
    var showDueQrBlock = receiptAdjustedBalanceDue > 0m;

    var assignedRooms = ViewBag.AssignedRooms as IEnumerable<string> ?? Enumerable.Empty<string>();
    var roomLabel = string.Join(", ", assignedRooms.Where(x => !string.IsNullOrWhiteSpace(x)).Select(x => x.Trim()));
    var guestName = ($"{Model.PrimaryGuestFirstName} {Model.PrimaryGuestLastName}").Trim();
    var isCancelled = string.Equals(Model.Status, "Cancelled", StringComparison.OrdinalIgnoreCase);
    var cancellationRecord = ViewBag.CancellationRecord as HotelApp.Web.Models.BookingCancellationRecord;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: Inter, system-ui, -apple-system, Segoe UI, sans-serif; margin: 0; color: #111827; background: #f5f6fb; }
        .page { max-width: 920px; margin: 24px auto; padding: 0 16px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; overflow: hidden; }

        .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .chip { display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px; background: #f3f4f6; color: #111827; font-weight: 700; font-size: 0.85rem; }
        .chip span { color: #6b7280; font-weight: 800; margin-right: 6px; }

        .print-button {
            position: fixed;
            top: 16px;
            right: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #111827;
            color: #fff;
            font-weight: 800;
            cursor: pointer;
            z-index: 9999;
        }

        .print-button svg { display: block; }

        .print-button:hover { filter: brightness(1.05); }
        .header { padding: 18px 18px 14px 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .header-top { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
        .hotel-name { font-weight: 800; font-size: 1.15rem; margin: 0; }
        .hotel-meta { margin-top: 6px; opacity: 0.95; font-size: 0.9rem; }
        .receipt-box { text-align: right; }
        .receipt-no { font-weight: 800; font-size: 1rem; }
        .receipt-date { opacity: 0.95; font-size: 0.9rem; margin-top: 6px; }

        .section { padding: 18px; }
        .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
        .info { border: 1px solid #eef2f7; background: #fafbff; border-radius: 12px; padding: 12px; }
        .k { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.04em; color: #6b7280; font-weight: 700; }
        .v { margin-top: 6px; font-weight: 700; color: #111827; }

        .summary { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 14px; align-items: start; }
        .totals { border: 1px solid #eef2f7; border-radius: 12px; padding: 12px; }
        .totals-row { display: flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .totals-row:last-child { border-bottom: none; }
        .totals-row strong { font-weight: 800; }
        .badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-weight: 800; font-size: 0.9rem; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 10px; border-bottom: 1px solid #f3f4f6; text-align: left; vertical-align: top; }
        th { font-size: 0.78rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.04em; }
        td.r, th.r { text-align: right; }

        tbody tr:nth-child(even) td { background: #fafbff; }

        .subhead { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 0 0 10px 0; }
        .subhead h3 { margin: 0; font-size: 1rem; }
        .muted { color: #6b7280; font-size: 0.9rem; }

        .qr { margin-top: 14px; border: 1px dashed #d1d5db; border-radius: 12px; padding: 12px; display: flex; gap: 14px; align-items: center; }
        .qr img { width: 120px; height: 120px; object-fit: contain; background: #fff; }

        @@media print {
            @@page {
                size: A4;
                margin: 10mm;
            }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            body { background: #fff; }
            .page { max-width: none; margin: 0; padding: 0; }
            .card { border: none; border-radius: 0; }
            .print-button { display: none !important; }
        }
    </style>
</head>
<body>
    <button type="button" class="print-button" onclick="window.print()" aria-label="Print receipt">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9V2h12v7" />
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
            <rect x="6" y="14" width="12" height="8" />
        </svg>
        Print
    </button>
    <div class="page">
        <div class="card">
            <div class="header">
                <div class="header-top">
                    <div>
                        <p class="hotel-name">@(string.IsNullOrWhiteSpace(hotelSettings?.HotelName) ? "LuxStay Hotel" : hotelSettings!.HotelName)</p>
                        <div class="hotel-meta">
                            @if (!string.IsNullOrWhiteSpace(hotelSettings?.Address))
                            {
                                <div>@hotelSettings!.Address</div>
                            }
                            <div>
                                @if (!string.IsNullOrWhiteSpace(hotelSettings?.ContactNumber1))
                                {
                                    <span>@hotelSettings!.ContactNumber1</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(hotelSettings?.GSTCode))
                                {
                                    <span style="margin-left:10px;">GST: @hotelSettings!.GSTCode</span>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="receipt-box">
                        <div class="receipt-no">Receipt: @Model.BookingNumber</div>
                        <div class="receipt-date">Issued: @receiptIssueDate.ToString("dd MMM yyyy, hh:mm tt")</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="chips">
                    <div class="chip"><span>Status</span>
                        @if (isCancelled)
                        {
                            <span style="color:#dc2626;font-weight:800;">Cancelled</span>
                        }
                        else
                        {
                            @(string.IsNullOrWhiteSpace(Model.Status) ? "-" : Model.Status)
                        }
                    </div>
                    <div class="chip"><span>Payment</span>@(string.IsNullOrWhiteSpace(Model.PaymentStatus) ? "-" : Model.PaymentStatus)</div>
                    <div class="chip"><span>Guests</span>@Model.Adults A / @Model.Children C</div>
                    @if (!string.IsNullOrWhiteSpace(Model.Channel))
                    {
                        <div class="chip"><span>Channel</span>@Model.Channel</div>
                    }
                </div>
                <div class="grid">
                    <div class="info">
                        <div class="k">Guest</div>
                        <div class="v">@(string.IsNullOrWhiteSpace(guestName) ? "-" : guestName)</div>
                        <div class="muted" style="margin-top:6px;">@(!string.IsNullOrWhiteSpace(Model.PrimaryGuestPhone) ? Model.PrimaryGuestPhone : "-")</div>
                        <div class="muted" style="margin-top:4px;">@(!string.IsNullOrWhiteSpace(Model.PrimaryGuestEmail) ? Model.PrimaryGuestEmail : "-")</div>
                    </div>
                    <div class="info">
                        <div class="k">Stay</div>
                        <div class="v">
                            @Model.CheckInDate.ToString("dd MMM yyyy") @(hotelSettings != null ? hotelSettings.CheckInTime.ToString("hh\\:mm") : "")
                            →
                            @Model.CheckOutDate.ToString("dd MMM yyyy") @(hotelSettings != null ? hotelSettings.CheckOutTime.ToString("hh\\:mm") : "")
                        </div>
                        <div class="muted" style="margin-top:6px;">Nights: @Model.Nights</div>
                        @if (Model.ActualCheckInDate.HasValue || Model.ActualCheckOutDate.HasValue)
                        {
                            <div class="muted" style="margin-top:4px;">
                                Actual: @(Model.ActualCheckInDate.HasValue ? Model.ActualCheckInDate.Value.ToString("dd MMM yyyy, hh:mm tt") : "-")
                                →
                                @(Model.ActualCheckOutDate.HasValue ? Model.ActualCheckOutDate.Value.ToString("dd MMM yyyy, hh:mm tt") : "-")
                            </div>
                        }
                    </div>
                    <div class="info">
                        <div class="k">Room</div>
                        <div class="v">@(string.IsNullOrWhiteSpace(roomLabel) ? (Model.RoomType?.TypeName ?? "-") : roomLabel)</div>
                        <div class="muted" style="margin-top:6px;">Type: @(Model.RoomType?.TypeName ?? "-") • Rooms: @Model.RequiredRooms</div>
                    </div>
                </div>

                <div style="height:14px"></div>

                <div class="summary">
                    <div>
                        <div class="subhead">
                            <h3>Charges</h3>
                            <span class="badge">Grand Total: ₹@receiptAdjustedGrandTotal.ToString("N2")</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Head</th>
                                    <th class="r">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div style="font-weight:700;">Room</div>
                                        <div class="muted" style="margin-top:4px;">Base ₹@Model.BaseAmount.ToString("N2") + Tax ₹@Model.TaxAmount.ToString("N2") - Disc ₹@Model.DiscountAmount.ToString("N2")</div>
                                    </td>
                                    <td class="r">₹@Model.TotalAmount.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td>
                                        <div style="font-weight:700;">Other Charges</div>
                                        <div class="muted" style="margin-top:4px;">Amount ₹@ocAmountTotal.ToString("N2") + GST ₹@ocGstTotal.ToString("N2")</div>
                                    </td>
                                    <td class="r">₹@ocGrandTotal.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td>
                                        <div style="font-weight:700;">Room Service</div>
                                        <div class="muted" style="margin-top:4px;">Bill ₹@rsActualBillTotal.ToString("N2") (Disc ₹@rsDiscountTotal.ToString("N2"))</div>
                                    </td>
                                    <td class="r">₹@rsActualBillTotal.ToString("N2")</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="totals">
                        <div class="totals-row"><span>Total Paid</span><strong>₹@totalPaid.ToString("N2")</strong></div>
                        @if (isCancelled && cancellationRecord != null)
                        {
                            var crAmtPaid = cancellationRecord.AmountPaid;
                            var crRefund = cancellationRecord.RefundAmount;
                            var crDeduct = crAmtPaid - crRefund;
                            <div class="totals-row" style="color:#dc2626;"><span>Deducted</span><strong>₹@crDeduct.ToString("N2")</strong></div>
                            <div class="totals-row" style="color:#16a34a;"><span>Refund Amount</span><strong>₹@crRefund.ToString("N2")</strong></div>
                            <div class="totals-row">
                                <span>Refund Status</span>
                                <strong style="color:@(cancellationRecord.IsRefunded ? "#0369a1" : "#d97706")">
                                    @(cancellationRecord.IsRefunded ? "Refunded" : "Pending")
                                </strong>
                            </div>
                        }
                        else
                        {
                            <div class="totals-row"><span>Balance Due</span><strong>₹@receiptAdjustedBalanceDue.ToString("N2")</strong></div>
                        }
                        @if (showDueQr && showDueQrBlock && !string.IsNullOrWhiteSpace(dueQrUrl))
                        {
                            <div style="margin-top: 10px;" class="muted">Scan QR to pay due amount.</div>
                        }
                    </div>
                </div>

                @if (showDueQr && showDueQrBlock && !string.IsNullOrWhiteSpace(dueQrUrl))
                {
                    <div class="qr">
                        <img src="@dueQrUrl" alt="UPI QR" />
                        <div>
                            <div style="font-weight:800;">Pay Due: ₹@receiptAdjustedBalanceDue.ToString("N2")</div>
                            <div class="muted" style="margin-top:6px;">Use any UPI app to scan and pay.</div>
                        </div>
                    </div>
                }

                <div style="height:18px"></div>

                <div class="subhead">
                    <h3>Other Charges</h3>
                    <span class="muted">@(bookingOtherCharges.Any() ? "" : "No other charges")</span>
                </div>
                @if (bookingOtherCharges.Any())
                {
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Date</th>
                                <th>Name</th>
                                <th class="r">Rate</th>
                                <th class="r">Qty</th>
                                <th class="r">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var oc in bookingOtherCharges)
                            {
                                var safeQty = oc.Qty <= 0 ? 1 : oc.Qty;
                                var amount = (oc.Rate * safeQty) + oc.GSTAmount;
                                <tr>
                                    <td><strong>@oc.Code</strong></td>
                                    <td>@oc.ChargeDate.ToString("dd MMM yyyy")</td>
                                    <td>@oc.Name</td>
                                    <td class="r">₹@oc.Rate.ToString("N2")</td>
                                    <td class="r">@safeQty</td>
                                    <td class="r">₹@amount.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }

                <div style="height:18px"></div>

                <div class="subhead">
                    <h3>Payments</h3>
                    <span class="muted">@(payments.Any() ? "" : "No payments")</span>
                </div>
                @if (payments.Any())
                {
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Method</th>
                                <th>Ref</th>
                                <th class="r">Amount</th>
                                <th class="r">Disc</th>
                                <th class="r">Round</th>
                                <th class="r">Applied</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in payments.OrderBy(x => x.PaidOn))
                            {
                                var applied = p.Amount + p.DiscountAmount + (p.IsRoundOffApplied ? p.RoundOffAmount : 0m);
                                <tr>
                                    <td>@p.PaidOn.ToString("dd MMM yyyy")</td>
                                    <td>@p.PaymentMethod</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.PaymentReference) ? "-" : p.PaymentReference)</td>
                                    <td class="r">₹@p.Amount.ToString("N2")</td>
                                    <td class="r">₹@p.DiscountAmount.ToString("N2")</td>
                                    <td class="r">₹@(p.IsRoundOffApplied ? p.RoundOffAmount : 0m).ToString("N2")</td>
                                    <td class="r">₹@applied.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="height:10px"></div>
                    <div class="muted" style="display:flex; justify-content:flex-end; gap:18px; flex-wrap:wrap;">
                        <div><strong>Payment Discounts:</strong> ₹@paymentDiscountTotal.ToString("N2")</div>
                        <div><strong>Round-off:</strong> ₹@paymentRoundOffTotal.ToString("N2")</div>
                        <div><strong>Total Applied:</strong> ₹@appliedToBalanceFromPayments.ToString("N2")</div>
                    </div>
                }

                <div style="height:14px"></div>
                <div class="muted" style="text-align:center; padding-bottom: 8px;">
                    Thank you for staying with us.
                </div>
            </div>
        </div>
    </div>
</body>
</html>
