@model HotelApp.Web.Models.Booking
@{
    ViewData["Title"] = $"Receipt - {Model.BookingNumber}";
    Layout = null;
    var hotelSettings = ViewBag.HotelSettings as HotelApp.Web.Models.HotelSettings;
    var payments = ViewBag.Payments as IEnumerable<HotelApp.Web.Models.BookingPayment>;
    var totalPaid = payments?.Sum(p => p.Amount) ?? 0;
    var receiptIssueDate = DateTime.Now;

    // Room Service (for receipt display + totals)
    var roomServiceLines = ViewBag.RoomServiceLines as IEnumerable<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>();
    var roomServiceLinesList = roomServiceLines.ToList();
    var hasRoomServices = roomServiceLinesList.Any();
    var rsOrders = roomServiceLinesList
        .GroupBy(x => x.OrderId)
        .Select(g => g.First())
        .ToList();
    var rsNetTotal = roomServiceLinesList.Sum(x => x.NetAmount);
    var rsActualBillTotal = rsOrders.Sum(x => x.ActualBillAmount);
    var rsDiscountTotal = rsOrders.Sum(x => x.DiscountAmount);
    var rsGstTotal = rsOrders.Sum(x => x.GSTAmount);
    var rsCgstTotal = rsOrders.Sum(x => x.CGSTAmount);
    var rsSgstTotal = rsOrders.Sum(x => x.SGSTAmount);
    var rsGrandTotal = rsActualBillTotal;

    // Other Charges (for receipt display + totals)
    var bookingOtherCharges = ViewBag.BookingOtherCharges as IEnumerable<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>();
    var hasOtherCharges = bookingOtherCharges.Any();
    var ocAmountTotal = bookingOtherCharges.Sum(x => x.Rate * (x.Qty <= 0 ? 1 : x.Qty));
    var ocGstTotal = bookingOtherCharges.Sum(x => x.GSTAmount);
    var ocCgstTotal = bookingOtherCharges.Sum(x => x.CGSTAmount);
    var ocSgstTotal = bookingOtherCharges.Sum(x => x.SGSTAmount);
    var ocGrandTotal = ocAmountTotal + ocGstTotal;

    // Header/summary totals
    var receiptAdjustedGrandTotal = Model.TotalAmount + ocGrandTotal + rsActualBillTotal;

    // Compute due from payments so payment-time discounts/round-off reduce balance correctly.
    var totalRoundOffApplied = payments?.Sum(p => p.IsRoundOffApplied ? p.RoundOffAmount : 0m) ?? 0m;

    var appliedToBalanceFromPayments = payments?.Sum(p =>
        p.Amount
        + p.DiscountAmount
        + (p.IsRoundOffApplied ? p.RoundOffAmount : 0m)
    ) ?? 0m;

    var receiptAdjustedBalanceDueRaw = receiptAdjustedGrandTotal - appliedToBalanceFromPayments;
    var receiptAdjustedBalanceDue = Math.Max(0m, Math.Round(receiptAdjustedBalanceDueRaw, 2, MidpointRounding.AwayFromZero));
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .mono {
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum" 1;
        }

        .subtle {
            color: #6b7280;
        }

        .receipt-container {
            max-width: 210mm; /* A4 width */
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 297mm; /* A4 height */
        }

        .receipt-content {
            padding: 15mm 20mm; /* A4 standard margins */
        }

        .receipt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .receipt-meta {
            flex-shrink: 0;
            text-align: right;
            min-width: 220px;
        }

        .receipt-meta .title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1.8px;
            color: #111827;
            text-transform: uppercase;
        }

        .receipt-meta .subtitle {
            font-size: 11px;
            margin-top: 6px;
            color: #6b7280;
        }

        .receipt-meta .meta-row {
            margin-top: 8px;
            font-size: 12px;
            color: #374151;
        }

        .receipt-meta .meta-row .label {
            color: #6b7280;
            margin-right: 6px;
        }

        .hotel-logo-section {
            flex-shrink: 0;
            margin-right: 20px;
        }

        .hotel-logo {
            max-width: 120px;
            max-height: 120px;
            object-fit: contain;
        }

        .hotel-info-section {
            flex: 1;
            text-align: center;
        }

        .hotel-name {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .receipt-title {
            font-size: 15px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            border-top: 2px solid #e0e0e0;
            border-bottom: 2px solid #e0e0e0;
            padding: 8px 0;
        }

        .receipt-title {
            display: none;
        }

        .hotel-details {
            font-size: 12px;
            color: #555;
            line-height: 1.8;
            margin-top: 10px;
        }

        .hotel-details p {
            margin: 3px 0;
        }

        .hotel-details .detail-label {
            font-weight: 600;
            color: #333;
        }

        .reservation-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 18px;
            margin-bottom: 22px;
            padding-bottom: 18px;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 14px 14px;
            background: #fff;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-top: 8px;
            font-size: 13px;
        }

        .summary-row:first-child {
            margin-top: 0;
        }

        .summary-row .label {
            color: #6b7280;
        }

        .summary-row .value {
            font-weight: 600;
            color: #111827;
        }

        .summary-row.total .value {
            color: #4f46e5;
            font-size: 15px;
        }

        .summary-row.due .value {
            color: #ef4444;
            font-size: 15px;
        }

        .section-title {
            margin-bottom: 12px;
        }

        .section-title.small {
            font-size: 13px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #111827;
        }

        .info-section {
            flex: 1;
            min-width: 200px;
        }

        .info-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .booking-number {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .date-section {
            display: flex;
            gap: 40px;
            align-items: center;
            margin: 20px 0;
        }

        .date-block {
            text-align: center;
        }

        .date-day {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
        }

        .date-month {
            font-size: 13px;
            color: #666;
            margin-top: 2px;
        }

        .date-time {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            font-weight: 500;
        }

        .actual-dates-section {
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            padding: 12px 16px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .actual-date-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 13px;
        }

        .actual-date-label {
            font-weight: 600;
            color: #555;
            min-width: 130px;
        }

        .actual-date-value {
            color: #333;
            font-weight: 500;
        }

        .actual-time {
            color: #667eea;
            font-weight: 600;
            margin-left: 8px;
        }

        .date-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .nights-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .rooms-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-direct {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-room {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .receipt-status {
            font-weight: 700;
        }

        .receipt-status.paid {
            color: #4caf50;
        }

        .receipt-status.due {
            color: #dc2626;
        }

        .assigned-rooms-section {
            display: inline-block;
            margin: 8px 0;
        }

        .assigned-rooms-label {
            font-size: 11px;
            font-weight: 500;
            color: #666;
            display: inline;
            margin-right: 6px;
        }

        .assigned-rooms-list {
            display: inline;
        }

        .room-number-badge {
            background: #4caf50;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .room-number-badge:before {
            content: "ðŸšª";
            font-size: 14px;
        }

        .totals-section {
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .total-row.stack {
            display: block;
            padding: 6px 0;
        }

        .total-row.stack .total-value {
            display: block;
            width: 100%;
            text-align: right;
            margin-top: 2px;
        }

        .total-row.highlight {
            font-size: 16px;
            font-weight: 700;
            padding-top: 12px;
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
        }

        .total-label {
            color: #666;
        }

        .total-value {
            font-weight: 600;
            color: #333;
        }

        .plan-details {
            margin: 30px 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .detail-table th {
            background: #f8f9fa;
            padding: 9px 10px;
            text-align: left;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }

        .detail-table td {
            padding: 9px 10px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-table tbody tr:nth-child(even) td {
            background: #fbfbfb;
        }

        .detail-table .mono {
            white-space: nowrap;
        }

        .detail-table tfoot td {
            padding: 10px 10px !important;
        }

        .detail-table tr:last-child td {
            border-bottom: none;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        /* Room Service table: fixed layout + stable numeric columns */
        .room-service-table {
            table-layout: fixed;
        }

        .room-service-table th:nth-child(1),
        .room-service-table td:nth-child(1) { width: 14%; }
        .room-service-table th:nth-child(2),
        .room-service-table td:nth-child(2) { width: 14%; }
        .room-service-table th:nth-child(3),
        .room-service-table td:nth-child(3) { width: 20%; }
        .room-service-table th:nth-child(4),
        .room-service-table td:nth-child(4) { width: 8%; }
        .room-service-table th:nth-child(5),
        .room-service-table td:nth-child(5) { width: 6%; }
        .room-service-table th:nth-child(6),
        .room-service-table td:nth-child(6) { width: 12%; }
        .room-service-table th:nth-child(7),
        .room-service-table td:nth-child(7) { width: 8%; }
        .room-service-table th:nth-child(8),
        .room-service-table td:nth-child(8) { width: 8%; }
        .room-service-table th:nth-child(9),
        .room-service-table td:nth-child(9) { width: 10%; }

        .room-service-table td,
        .room-service-table th {
            vertical-align: top;
            word-break: break-word;
        }

        .room-service-table td.text-right,
        .room-service-table th.text-right {
            white-space: nowrap;
        }

        .payment-summary {
            margin: 20px 0;
        }

        .inclusions-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .inclusions-list li {
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            font-size: 13px;
            color: #555;
        }

        .inclusions-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .contact-info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .watermark {
            position: fixed;
            top: 30%;
            right: 5%;
            transform: rotate(-15deg);
            width: 180px;
            height: 180px;
            border: 6px solid rgba(220, 53, 69, 0.35);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            pointer-events: none;
        }

        .watermark::before {
            content: 'PAID';
            font-size: 48px;
            font-weight: 900;
            color: rgba(220, 53, 69, 0.35);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .watermark::after {
            content: '';
            position: absolute;
            width: 165px;
            height: 165px;
            border: 2px dashed rgba(220, 53, 69, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .receipt-content {
            position: relative;
            z-index: 2;
        }

        @@media print {
            @@page {
                size: A4;
                margin: 10mm;
            }
            
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .watermark {
                position: absolute;
                top: 25%;
                right: 10%;
                width: 160px;
                height: 160px;
            }
            
            body {
                background: white;
                padding: 0;
                margin: 0;
                width: 210mm;
            }
            
            .receipt-container {
                box-shadow: none;
                max-width: 100%;
                width: 210mm;
                min-height: 297mm;
                margin: 0;
                page-break-after: avoid;
            }

            .totals-section,
            .summary-card {
                background: transparent !important;
            }

            .plan-details,
            .payment-summary,
            .totals-section,
            .summary-grid,
            .receipt-header,
            .contact-info {
                page-break-inside: avoid;
            }

            table,
            tr,
            td,
            th {
                page-break-inside: avoid;
            }
            
            .receipt-content {
                padding: 10mm 15mm;
            }
            .print-button {
                display: none;
            }
            .hotel-logo {
                max-width: 100px;
                max-height: 100px;
            }
        }
    </style>
</head>
<body>
    @{
        var isCheckedOut = Model.ActualCheckOutDate != null || Model.Status == "CheckedOut";
        var isFullyPaid = receiptAdjustedBalanceDue <= 0;
        var showWatermark = isCheckedOut && isFullyPaid;
        var isFinalBill = showWatermark; // Can add more conditions here if needed
    }
    
    @if (showWatermark)
    {
        <div class="watermark"></div>
    }
    
    <div class="receipt-container">
        <div class="receipt-content">
            <!-- Header -->
            <div class="receipt-header">
                @if (hotelSettings != null && !string.IsNullOrEmpty(hotelSettings.LogoPath))
                {
                    <div class="hotel-logo-section">
                        <img src="@hotelSettings.LogoPath" alt="Hotel Logo" class="hotel-logo" />
                    </div>
                }
                <div class="hotel-info-section">
                    <h1 class="hotel-name">@(hotelSettings?.HotelName ?? "Hotel Management System")</h1>
                    <div class="receipt-title">@(isFinalBill ? "FINAL BILL" : "RESERVATION")</div>
                    @if (hotelSettings != null)
                    {
                        <div class="hotel-details">
                        @if (!string.IsNullOrEmpty(hotelSettings.Address))
                        {
                            <p>@hotelSettings.Address</p>
                        }
                        <p>
                            @if (!string.IsNullOrEmpty(hotelSettings.ContactNumber1))
                            {
                                <span><span class="detail-label">Phone:</span> @hotelSettings.ContactNumber1</span>
                            }
                            @if (!string.IsNullOrEmpty(hotelSettings.ContactNumber2))
                            {
                                <span> / @hotelSettings.ContactNumber2</span>
                            }
                        </p>
                        @if (!string.IsNullOrEmpty(hotelSettings.EmailAddress))
                        {
                            <p><span class="detail-label">Email:</span> @hotelSettings.EmailAddress</p>
                        }
                        @if (!string.IsNullOrEmpty(hotelSettings.Website))
                        {
                            <p><span class="detail-label">Website:</span> @hotelSettings.Website</p>
                        }
                        @if (!string.IsNullOrEmpty(hotelSettings.GSTCode))
                        {
                            <p><span class="detail-label">GSTIN:</span> @hotelSettings.GSTCode</p>
                        }
                    </div>
                    }
                </div>
                <div class="receipt-meta">
                    <div class="title">@(isFinalBill ? "Tax Invoice" : "Receipt")</div>
                    <div class="subtitle">@(isFinalBill ? "Final Bill" : "Booking Receipt")</div>
                    <div class="meta-row"><span class="label">Booking No.</span> <span class="mono"><strong>@Model.BookingNumber</strong></span></div>
                    <div class="meta-row"><span class="label">Issue</span> <span class="mono">@receiptIssueDate.ToString("dd MMM yyyy hh:mm tt")</span></div>
                    <div class="meta-row"><span class="label">Status</span> <span class="mono receipt-status @(receiptAdjustedBalanceDue <= 0 ? "paid" : "due")">@(receiptAdjustedBalanceDue <= 0 ? "Paid" : "Due")</span></div>
                </div>
            </div>

            <!-- Reservation Info -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="section-title small">Booking Details</div>
                    <div class="summary-row">
                        <span class="label">Booking No.</span>
                        <span class="value mono">@Model.BookingNumber</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Ref. ID</span>
                        <span class="value mono">@Model.Id</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Issue Date</span>
                        <span class="value mono">@receiptIssueDate.ToString("dd MMM yyyy hh:mm tt")</span>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="section-title small">Guest & Amount</div>
                    <div class="summary-row">
                        <span class="label">Guest</span>
                        <span class="value">@Model.PrimaryGuestFirstName @Model.PrimaryGuestLastName</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Phone</span>
                        <span class="value mono">@Model.PrimaryGuestPhone</span>
                    </div>
                    <div class="summary-row total">
                        <span class="label">Grand Total</span>
                        <span class="value mono">â‚¹ @receiptAdjustedGrandTotal.ToString("N2")</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Round Off Applied</span>
                        <span class="value mono">â‚¹ @totalRoundOffApplied.ToString("N2")</span>
                    </div>
                    <div class="summary-row due">
                        <span class="label">Balance Due</span>
                        <span class="value mono">â‚¹ @receiptAdjustedBalanceDue.ToString("N2")</span>
                    </div>
                </div>
            </div>

            <!-- Check-in/Check-out Dates -->
            <div class="date-section">
                <div class="date-block">
                    <div class="date-label">Check-in</div>
                    <div class="date-day">@Model.CheckInDate.ToString("dd")</div>
                    <div class="date-month">@Model.CheckInDate.ToString("MMM yyyy").ToUpper()</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                    <span class="nights-badge">@Model.Nights Night@(Model.Nights > 1 ? "s" : "")</span>
                    <span class="rooms-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V7H1v10h22v-6c0-2.21-1.79-4-4-4z"/>
                        </svg>
                        @Model.RequiredRooms Room@(Model.RequiredRooms > 1 ? "s" : "")
                    </span>
                </div>
                <div class="date-block">
                    <div class="date-label">Check-out</div>
                    <div class="date-day">@Model.CheckOutDate.ToString("dd")</div>
                    <div class="date-month">@Model.CheckOutDate.ToString("MMM yyyy").ToUpper()</div>
                </div>
            </div>

            <!-- Actual Check-in/Check-out Times (if available) -->
            @if (Model.ActualCheckInDate.HasValue || Model.ActualCheckOutDate.HasValue)
            {
                <div class="actual-dates-section">
                    @if (Model.ActualCheckInDate.HasValue)
                    {
                        <div class="actual-date-item">
                            <span class="actual-date-label">Actual Check-in:</span>
                            <span class="actual-date-value">
                                @Model.ActualCheckInDate.Value.ToString("dd MMM yyyy")
                                <span class="actual-time">@Model.ActualCheckInDate.Value.ToString("hh:mm tt")</span>
                            </span>
                        </div>
                    }
                    @if (Model.ActualCheckOutDate.HasValue)
                    {
                        <div class="actual-date-item">
                            <span class="actual-date-label">Actual Check-out:</span>
                            <span class="actual-date-value">
                                @Model.ActualCheckOutDate.Value.ToString("dd MMM yyyy")
                                <span class="actual-time">@Model.ActualCheckOutDate.Value.ToString("hh:mm tt")</span>
                            </span>
                        </div>
                    }
                </div>
            }

            <!-- Status Badges -->
            <div class="status-badges">
                <span class="badge badge-direct">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    @Model.Source?.ToUpper()
                </span>
                <span class="badge badge-room">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 21v-2h18v2H3zm0-4v-6h2v6H3zm4 0v-6h2v6H7zm4 0v-6h2v6h-2zm4 0v-6h2v6h-2zm4 0v-6h2v6h-2zM3 9V7h18v2H3z"/>
                    </svg>
                    @(Model.RoomType?.TypeName ?? "Room")
                </span>
            </div>

            <!-- Assigned Room(s) -->
            @{
                var assignedRooms = ViewBag.AssignedRooms as IEnumerable<string>;
            }
            @if (assignedRooms != null && assignedRooms.Any())
            {
                <div class="assigned-rooms-section">
                    <span class="assigned-rooms-label">Assigned Room@(assignedRooms.Count() > 1 ? "s" : ""):</span>
                    <span class="assigned-rooms-list">
                        @foreach (var roomNumber in assignedRooms)
                        {
                            <span class="room-number-badge">@roomNumber</span>
                        }
                    </span>
                </div>
            }

            @{
                // Compute totals once (used by both Plan Details and Totals sections)
                var assignedRoomsForReceipt = ViewBag.AssignedRooms as IEnumerable<string>;
                var hasAssignedRoomsForReceipt = assignedRoomsForReceipt != null && assignedRoomsForReceipt.Any();

                // Use ReservationRoomNights only before room assignment.
                // Keep current workflow unchanged: once rooms are assigned, BookingRoomNights continues to drive totals.
                var roomNightsForTotals = hasAssignedRoomsForReceipt
                    ? (Model.RoomNights ?? new List<HotelApp.Web.Models.BookingRoomNight>()).Cast<dynamic>().ToList()
                    : (Model.ReservationRoomNights ?? new List<HotelApp.Web.Models.ReservationRoomNight>()).Cast<dynamic>().ToList();
                var hasNightBreakdownForTotals = roomNightsForTotals.Any();

                // IMPORTANT:
                // BookingRoomNights may be stored as one row per *room per date*.
                // In that case, RoomNights sums already represent all rooms and must NOT be multiplied again.
                var roomsForTotals = Model.RequiredRooms > 0 ? Model.RequiredRooms : 1;
                var distinctDatesForTotals = roomNightsForTotals.Select(n => n.StayDate.Date).Distinct().Count();
                var rowsPerDateForTotals = distinctDatesForTotals > 0 ? (decimal)roomNightsForTotals.Count / distinctDatesForTotals : 0m;
                var roomNightsIncludeAllRooms = hasNightBreakdownForTotals && roomsForTotals > 1 && rowsPerDateForTotals > 1m;
                var roomMultiplierForTotals = roomNightsIncludeAllRooms ? 1 : roomsForTotals;

                var hasNightPricingColumns = hasNightBreakdownForTotals
                    && roomNightsForTotals.Any(n => n.ActualBaseRate > 0 || n.DiscountAmount > 0);

                var afterDiscountTotal = hasNightBreakdownForTotals
                    ? ((decimal)roomNightsForTotals.Sum(n => (decimal)n.RateAmount) * roomMultiplierForTotals)
                    : Model.BaseAmount;

                var taxTotal = hasNightBreakdownForTotals
                    ? ((decimal)roomNightsForTotals.Sum(n => (decimal)n.TaxAmount) * roomMultiplierForTotals)
                    : Model.TaxAmount;

                var cgstTotal = hasNightBreakdownForTotals
                    ? ((decimal)roomNightsForTotals.Sum(n => (decimal)n.CGSTAmount) * roomMultiplierForTotals)
                    : Model.CGSTAmount;

                var sgstTotal = hasNightBreakdownForTotals
                    ? ((decimal)roomNightsForTotals.Sum(n => (decimal)n.SGSTAmount) * roomMultiplierForTotals)
                    : Model.SGSTAmount;

                var discountAmount = hasNightPricingColumns
                    ? Math.Round(((decimal)roomNightsForTotals.Sum(n => (decimal)n.DiscountAmount) * roomMultiplierForTotals), 2, MidpointRounding.AwayFromZero)
                    : Model.DiscountAmount;

                // Backward-compatible: if older data doesn't have per-night discount, reconstruct from discount percentage.
                var discountPercentForTotals = ViewBag.DiscountPercentage != null ? (decimal)ViewBag.DiscountPercentage : 0m;
                if (!hasNightPricingColumns && hasNightBreakdownForTotals && discountPercentForTotals > 0)
                {
                    var divisor = 1 - (discountPercentForTotals / 100m);
                    if (divisor > 0)
                    {
                        var originalTotal = Math.Round(afterDiscountTotal / divisor, 2, MidpointRounding.AwayFromZero);
                        discountAmount = Math.Round(originalTotal - afterDiscountTotal, 2, MidpointRounding.AwayFromZero);
                    }
                }

                var preDiscountTotal = afterDiscountTotal + discountAmount;

                // Receipt-level adjusted totals (display-only)
                var adjustedCgstTotal = cgstTotal + ocCgstTotal + rsCgstTotal;
                var adjustedSgstTotal = sgstTotal + ocSgstTotal + rsSgstTotal;
                var adjustedTaxTotal = taxTotal + ocGstTotal + rsGstTotal;
                var adjustedTotalAmount = Math.Round(afterDiscountTotal + taxTotal + ocGrandTotal + rsActualBillTotal, 2, MidpointRounding.AwayFromZero);
                var adjustedBalancePayable = receiptAdjustedBalanceDue;
            }

            <!-- Stay Summary -->
            <div class="plan-details">
                <h2 class="section-title">Stay Summary</h2>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>Room Category</th>
                            <th class="text-center">Nights</th>
                            <th class="text-center">Room Qty</th>
                            <th class="text-center">Adults</th>
                            <th class="text-center">Children</th>
                            <th>Meal Plan</th>
                            <th class="text-right">Rate / Night (Per Room)</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var rooms = Model.RequiredRooms > 0 ? Model.RequiredRooms : 1;
                            var roomNights = hasAssignedRoomsForReceipt
                                ? (Model.RoomNights ?? new List<HotelApp.Web.Models.BookingRoomNight>())
                                    .Cast<dynamic>()
                                    .OrderBy(n => n.StayDate)
                                    .ToList()
                                : (Model.ReservationRoomNights ?? new List<HotelApp.Web.Models.ReservationRoomNight>())
                                    .Cast<dynamic>()
                                    .OrderBy(n => n.StayDate)
                                    .ToList();
                            var hasNightBreakdown = roomNights.Any();

                            // Group by actual AFTER-discount nightly rate so different dates show separately.
                            // Important: sort groups by date so the receipt reflects the stay chronology.
                            // Use dynamic groups because the source collection can be BookingRoomNight or ReservationRoomNight.
                            var groupedNightRates = hasNightBreakdown
                                ? roomNights
                                    .GroupBy(n => Math.Round((decimal)n.RateAmount, 2, MidpointRounding.AwayFromZero))
                                    .Select(g => (dynamic)new { Rate = g.Key, Items = g.ToList() })
                                    .OrderBy(g => ((IEnumerable<dynamic>)g.Items).Min(x => ((DateTime)x.StayDate)))
                                    .ThenByDescending(g => (decimal)g.Rate)
                                    .ToList()
                                : new List<dynamic>();

                            // Discount is shown in totals area; Plan Details focuses on visible per-night pricing.
                            // If nights are missing, fall back to a single summarized row.
                        }

                        @if (hasNightBreakdown)
                        {
                            foreach (var g in groupedNightRates)
                            {
                                // Nights should represent distinct stay dates for the booking.
                                // BookingRoomNights may contain one row per room per date, so counting rows can inflate nights.
                                var items = (IEnumerable<dynamic>)g.Items;
                                var groupNights = items.Select(x => ((DateTime)x.StayDate).Date).Distinct().Count();
                                decimal discountedRatePerNightPerRoom = (decimal)g.Rate;
                                var discountedGroupTotalPerRoom = Math.Round(items.Sum(x => (decimal)x.RateAmount), 2, MidpointRounding.AwayFromZero);

                                // Prefer persisted pricing columns.
                                var hasActualNightRates = items.Any(x => (decimal)x.ActualBaseRate > 0 || (decimal)x.DiscountAmount > 0);
                                var actualRatePerNightPerRoom = hasActualNightRates
                                    ? Math.Round(items.Average(x => (decimal)x.ActualBaseRate), 2, MidpointRounding.AwayFromZero)
                                    : discountedRatePerNightPerRoom;
                                var actualGroupTotalPerRoom = hasActualNightRates
                                    ? Math.Round(items.Sum(x => (decimal)x.ActualBaseRate), 2, MidpointRounding.AwayFromZero)
                                    : discountedGroupTotalPerRoom;

                                // For receipt consistency (before/after room assignment), show totals based on BookingRoomNights rows.
                                // If BookingRoomNights is per-room-per-date, sums already represent all rooms.
                                // If BookingRoomNights is per-date only, sums represent the booking plan total already (not per-room).
                                var distinctDatesInGroup = items.Select(x => ((DateTime)x.StayDate).Date).Distinct().Count();
                                var rowsPerDateInGroup = distinctDatesInGroup > 0 ? (decimal)items.Count() / distinctDatesInGroup : 0m;
                                var groupIncludesAllRooms = hasAssignedRoomsForReceipt && rooms > 1 && rowsPerDateInGroup > 1m;
                                var groupRoomMultiplier = groupIncludesAllRooms ? 1 : rooms;
                                var planGroupTotal = actualGroupTotalPerRoom;

                                var fromDate = items.Min(x => ((DateTime)x.StayDate)).Date;
                                var toDate = items.Max(x => ((DateTime)x.StayDate)).Date;
                                var dateHint = fromDate == toDate
                                    ? fromDate.ToString("dd MMM yyyy")
                                    : $"{fromDate:dd MMM yyyy} - {toDate:dd MMM yyyy}";

                                <tr>
                                    <td>
                                        @(Model.RoomType?.TypeName ?? "N/A")
                                        <br /><small style="color:#888;">@dateHint</small>
                                    </td>
                                    <td class="text-center">@groupNights</td>
                                    <td class="text-center">@rooms</td>
                                    <td class="text-center">@Model.Adults</td>
                                    <td class="text-center">@Model.Children</td>
                                    <td>@(Model.CustomerType == "B2B" ? "EP" : "CP")</td>
                                    <td class="text-right">
                                        <span class="mono">@actualRatePerNightPerRoom.ToString("N2")</span>
                                        @if (hasActualNightRates)
                                        {
                                            <br /><small class="subtle mono">After discount: @discountedRatePerNightPerRoom.ToString("N2")</small>
                                        }
                                    </td>
                                    <td class="text-right mono">â‚¹ @(Math.Round(planGroupTotal * groupRoomMultiplier, 2, MidpointRounding.AwayFromZero).ToString("N2"))</td>
                                </tr>
                            }
                        }
                        else
                        {
                            // Fallback (no BookingRoomNights): keep previous behavior as a single summarized row.
                            <tr>
                                <td>@(Model.RoomType?.TypeName ?? "N/A")</td>
                                <td class="text-center">@Model.Nights</td>
                                <td class="text-center">@rooms</td>
                                <td class="text-center">@Model.Adults</td>
                                <td class="text-center">@Model.Children</td>
                                <td>@(Model.CustomerType == "B2B" ? "EP" : "CP")</td>
                                <td class="text-right">
                                    @{
                                        var nights = Model.Nights > 0 ? Model.Nights : 0;
                                        var totalRoomNights = rooms * nights;

                                        var discountPercentFallback = ViewBag.DiscountPercentage != null ? (decimal)ViewBag.DiscountPercentage : 0m;
                                        var afterDiscountTotalFallback = Model.BaseAmount;
                                        var discountAmountFallback = Model.DiscountAmount;
                                        if (discountPercentFallback > 0)
                                        {
                                            var divisor = 1 - (discountPercentFallback / 100m);
                                            if (divisor > 0)
                                            {
                                                var originalTotal = Math.Round(afterDiscountTotalFallback / divisor, 2, MidpointRounding.AwayFromZero);
                                                discountAmountFallback = Math.Round(originalTotal - afterDiscountTotalFallback, 2, MidpointRounding.AwayFromZero);
                                            }
                                        }

                                        var preDiscountTotalFallback = afterDiscountTotalFallback + discountAmountFallback;
                                        var ratePerNight = totalRoomNights > 0 ? (preDiscountTotalFallback / totalRoomNights) : 0;
                                        var discountedRatePerNight = totalRoomNights > 0 ? (afterDiscountTotalFallback / totalRoomNights) : 0;
                                    }
                                    <span class="mono">@ratePerNight.ToString("N2")</span>
                                    @if (discountedRatePerNight > 0)
                                    {
                                        <br/><small style="color: #e74c3c; font-weight: 600;" class="mono">After Discount: @discountedRatePerNight.ToString("N2")</small>
                                    }
                                </td>
                                <td class="text-right mono">â‚¹ @((Model.BaseAmount + Model.DiscountAmount).ToString("N2"))</td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (hasOtherCharges)
                {
                    <h2 class="section-title" style="margin-top: 22px;">Other Charges</h2>
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>Particulars</th>
                                <th class="text-center">Qty</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">GST</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var oc in bookingOtherCharges)
                            {
                                var qty = oc.Qty <= 0 ? 1 : oc.Qty;
                                var amount = oc.Rate * qty;
                                var total = amount + oc.GSTAmount;
                                <tr>
                                    <td>
                                        <strong>@oc.Name</strong>
                                        <br /><small class="subtle">@oc.Code</small>
                                        @if (!string.IsNullOrWhiteSpace(oc.Note))
                                        {
                                            <br /><small class="subtle">Note: @oc.Note</small>
                                        }
                                    </td>
                                    <td class="text-center mono">@qty</td>
                                    <td class="text-right mono">â‚¹ @oc.Rate.ToString("N2")</td>
                                    <td class="text-right mono">â‚¹ @amount.ToString("N2")</td>
                                    <td class="text-right mono">â‚¹ @oc.GSTAmount.ToString("N2")</td>
                                    <td class="text-right mono">â‚¹ @total.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: 600; background: #f8f9fa;">
                                <td colspan="3" class="text-right" style="padding: 12px;">Total Other Charges:</td>
                                <td class="text-right mono" style="padding: 12px;">â‚¹ @ocAmountTotal.ToString("N2")</td>
                                <td class="text-right mono" style="padding: 12px;">â‚¹ @ocGstTotal.ToString("N2")</td>
                                <td class="text-right mono" style="padding: 12px;">â‚¹ @ocGrandTotal.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                }

                @* Room Service details are printed separately from Booking Details (Room Service -> Print Detail). *@

                <!-- Totals -->
                <div class="totals-section">
                    <div class="total-row stack">
                        <span class="total-label">Room&nbsp;Total&nbsp;(Before&nbsp;Discount)</span>
                        <span class="total-value mono">â‚¹ @(preDiscountTotal.ToString("N2"))</span>
                    </div>
                    @if (discountAmount > 0)
                    {
                        var discountedAmount = afterDiscountTotal;
                        <div class="total-row stack">
                            <span class="total-label">Discount&nbsp;Applied</span>
                            <span class="total-value mono" style="color: #e74c3c;">- â‚¹ @discountAmount.ToString("N2")</span>
                        </div>
                        <div class="total-row stack" style="font-weight: 600;">
                            <span class="total-label">Subtotal&nbsp;(After&nbsp;Discount)</span>
                            <span class="total-value mono">â‚¹ @discountedAmount.ToString("N2")</span>
                        </div>
                    }
                    else
                    {
                        var discountedAmount = afterDiscountTotal;
                        <div class="total-row stack" style="font-weight: 600;">
                            <span class="total-label">Subtotal</span>
                            <span class="total-value mono">â‚¹ @discountedAmount.ToString("N2")</span>
                        </div>
                    }
                    @{
                        // Use actual tax percentages from RateMaster instead of recalculating from amounts
                        var cgstPercentage = ViewBag.CGSTPercentage != null ? (decimal)ViewBag.CGSTPercentage : 6m;
                        var sgstPercentage = ViewBag.SGSTPercentage != null ? (decimal)ViewBag.SGSTPercentage : 6m;
                    }
                    <div class="total-row stack">
                        <span class="total-label">Stay CGST @@ @cgstPercentage.ToString("0.##")%</span>
                        <span class="total-value mono">â‚¹ @(cgstTotal.ToString("N2"))</span>
                    </div>
                    <div class="total-row stack">
                        <span class="total-label">Stay SGST @@ @sgstPercentage.ToString("0.##")%</span>
                        <span class="total-value mono">â‚¹ @(sgstTotal.ToString("N2"))</span>
                    </div>
                    <div class="total-row stack">
                        <span class="total-label">Total GST (Stay)</span>
                        <span class="total-value mono">â‚¹ @(taxTotal.ToString("N2"))</span>
                    </div>
                    @if (hasOtherCharges)
                    {
                        <div class="total-row stack">
                            <span class="total-label">Other Charges GST</span>
                            <span class="total-value mono">â‚¹ @(ocGstTotal.ToString("N2"))</span>
                        </div>
                        <div class="total-row stack">
                            <span class="total-label">Other Charges (incl. GST)</span>
                            <span class="total-value mono">â‚¹ @(ocGrandTotal.ToString("N2"))</span>
                        </div>
                    }
                    @if (hasRoomServices)
                    {
                        <div class="total-row stack">
                            <span class="total-label">Room Service GST</span>
                            <span class="total-value mono">â‚¹ @(rsGstTotal.ToString("N2"))</span>
                        </div>
                        <div class="total-row stack">
                            <span class="total-label">Room Service Actual Bill (Incl. GST)</span>
                            <span class="total-value mono">â‚¹ @(rsActualBillTotal.ToString("N2"))</span>
                        </div>
                    }
                    <div class="total-row highlight stack">
                        <span class="total-label">Total Amount</span>
                        <span class="total-value mono">â‚¹ @(adjustedTotalAmount.ToString("N2"))</span>
                    </div>
                    <div class="total-row stack">
                        <span class="total-label">Payments</span>
                        <span class="total-value mono" style="color: #4caf50;">â‚¹ @(totalPaid.ToString("N2"))</span>
                    </div>
                    <div class="total-row highlight stack" style="color: #f5576c;">
                        <span class="total-label">Balance Payable</span>
                        <span class="total-value mono">â‚¹ @(adjustedBalancePayable.ToString("N2"))</span>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            @if (payments != null && payments.Any())
            {
                <div class="payment-summary">
                    <h2 class="section-title">Payment Summary</h2>
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>Receipt No.</th>
                                <th>Date & Time</th>
                                <th>Method</th>
                                <th>Reference</th>
                                <th class="text-right">Discount</th>
                                <th class="text-right">Round Off</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var g in payments
                                .GroupBy(p => string.IsNullOrWhiteSpace(p.ReceiptGroupNumber) ? (p.ReceiptNumber ?? "N/A") : p.ReceiptGroupNumber)
                                .OrderByDescending(g => g.Max(x => x.PaidOn)))
                            {
                                var first = g.OrderBy(x => x.Id).FirstOrDefault();
                                var receiptNo = g.Key ?? "N/A";
                                var paidOn = first?.PaidOn ?? g.Max(x => x.PaidOn);
                                var method = first?.PaymentMethod ?? "-";
                                var reference = first?.PaymentReference ?? "-";
                                var discount = g.Sum(x => x.DiscountAmount);
                                var roundOff = g.Sum(x => x.RoundOffAmount);
                                var amount = g.Sum(x => x.Amount);
                                var isAdvance = g.Any(x => x.IsAdvancePayment);

                                <tr>
                                    <td><strong>@receiptNo</strong></td>
                                    <td>@paidOn.ToString("dd MMM yyyy hh:mm tt")</td>
                                    <td>
                                        @method
                                        @if (isAdvance)
                                        {
                                            <span style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 10px; padding: 2px 6px; border-radius: 3px; margin-left: 4px; font-weight: 600;">
                                                â˜… ADVANCE
                                            </span>
                                        }
                                    </td>
                                    <td>@reference</td>
                                    <td class="text-right">â‚¹ @discount.ToString("N2")</td>
                                    <td class="text-right">â‚¹ @roundOff.ToString("N2")</td>
                                    <td class="text-right">â‚¹ @amount.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: 600; background: #f8f9fa;">
                                <td colspan="6" class="text-right" style="padding: 12px;">Total Paid:</td>
                                <td class="text-right" style="padding: 12px; color: #4caf50;">â‚¹ @totalPaid.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }

            <!-- Special Instructions -->
            @if (!string.IsNullOrEmpty(Model.SpecialRequests))
            {
                <div class="plan-details">
                    <h2 class="section-title">Special Instructions</h2>
                    <p style="font-size: 13px; color: #555; line-height: 1.6;">@Model.SpecialRequests</p>
                </div>
            }

            <!-- Inclusions -->
            <div class="plan-details">
                <h2 class="section-title">Inclusions</h2>
                <ul class="inclusions-list">
                    <li>Welcome Drinks</li>
                    <li>Breakfast: Complimentary (Excluding Meal Plan: "EP")</li>
                    <li>Free Wi-Fi</li>
                    <li>Swimming Pool</li>
                    <li>Car Parking</li>
                    <li>Beach Access</li>
                    <li>Multi Gym</li>
                </ul>
            </div>

            <!-- Contact Info -->
            <div class="contact-info">
                @if (hotelSettings != null)
                {
                    <div>@hotelSettings.Address</div>
                    <div>Phone: @hotelSettings.ContactNumber1 | Email: @hotelSettings.EmailAddress</div>
                    @if (!string.IsNullOrEmpty(hotelSettings.Website))
                    {
                        <div>Website: @hotelSettings.Website</div>
                    }
                }
                <div style="margin-top: 12px; font-weight: 600;">This is a system-generated receipt.</div>
                <div class="subtle" style="margin-top: 6px;">Thank you for choosing us!</div>
            </div>
        </div>
    </div>

    <button class="print-button" onclick="window.print()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
            <rect x="6" y="14" width="12" height="8"/>
        </svg>
        Print Receipt
    </button>
</body>
</html>
