@model HotelApp.Web.Models.Booking
@{
    ViewData["Title"] = $"Booking {Model.BookingNumber}";
    var statusClass = Model.Status switch
    {
        "Confirmed" => "status-confirmed",
        "CheckedIn" => "status-checkedin",
        "CheckedOut" => "status-checkedout",
        "Cancelled" => "status-cancelled",
        "Pending" => "status-pending",
        _ => "status-default"
    };
}

<form id="roomServiceSyncForm" method="post" action="@Url.Action("SyncRoomService", "Booking")" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<style>
    .booking-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .booking-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .booking-number {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .booking-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    .status-confirmed { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .status-checkedin { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .status-checkedout { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
    .status-cancelled { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .status-pending { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; }
    
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .detail-card {
        background: white;
        border-radius: 10px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    .detail-card:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        margin-bottom: 1rem;
        padding-bottom: 0.85rem;
        border-bottom: 2px solid #f3f4f6;
    }
    .card-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
    }
    .icon-stay { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .icon-guest { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .icon-finance { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .icon-info { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    
    .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.6rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .detail-row:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    .detail-label {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .detail-value {
        color: #1f2937;
        font-weight: 600;
        text-align: right;
        font-size: 0.9rem;
    }
    
    .financial-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .financial-rows {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        margin-top: 1rem;
    }
    .financial-row {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 0.85rem;
        align-items: center;
    }
    .financial-row-title {
        font-size: 0.95rem;
        font-weight: 800;
        opacity: 0.95;
        letter-spacing: 0.01em;
    }
    .financial-row-items {
        display: grid;
        grid-template-columns: repeat(3, minmax(160px, 1fr));
        gap: 0.85rem;
    }
    .financial-item {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 0.85rem;
        text-align: center;
    }
    .financial-label {
        font-size: 0.8rem;
        opacity: 0.9;
        margin-bottom: 0.4rem;
    }
    .financial-amount {
        font-size: 1.25rem;
        font-weight: 700;
    }
    .financial-grand-total {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }
    .financial-highlight-deposit {
        background: rgba(255, 255, 255, 0.16);
        border: 2px solid rgba(255, 255, 255, 0.35);
    }
    .financial-highlight-due {
        background: rgba(255, 255, 255, 0.26);
        border: 2px solid rgba(255, 255, 255, 0.45);
    }

    @@media (max-width: 900px) {
        .financial-row {
            grid-template-columns: 1fr;
            align-items: stretch;
        }
        .financial-row-items {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
    }

    .billing-headwise {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.18);
    }
    .billing-headwise-title {
        font-size: 0.9rem;
        font-weight: 700;
        opacity: 0.95;
        margin-bottom: 0.5rem;
        letter-spacing: 0.01em;
    }
    .billing-headwise-rows {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 10px;
        overflow: hidden;
    }
    .billing-headwise-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.65rem 0.85rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }
    .billing-headwise-row:last-child {
        border-bottom: none;
    }
    .billing-headwise-name {
        font-size: 0.9rem;
        font-weight: 600;
        opacity: 0.95;
        text-align: left;
    }
    .billing-headwise-amount {
        font-size: 0.95rem;
        font-weight: 800;
        text-align: right;
        white-space: nowrap;
    }
    
    .section-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
    }
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        margin-bottom: 1.25rem;
        padding-bottom: 0.85rem;
        border-bottom: 2px solid #f3f4f6;
    }
    .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.15rem;
    }
    .section-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }
    
    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    .modern-table thead th {
        background: #f9fafb;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
        border-bottom: 2px solid #e5e7eb;
    }
    .modern-table tbody td {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        color: #1f2937;
    }
    .modern-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .guest-list {
        display: grid;
        gap: 1rem;
    }
    .guest-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    .guest-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
    }
    .guest-info {
        flex: 1;
    }
    .guest-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }
    .guest-details {
        font-size: 0.9rem;
        color: #6b7280;
    }

    /* Watermark Styles */
    .watermark-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
    }
    .watermark {
        position: absolute;
        font-size: 120px;
        font-weight: 900;
        opacity: 0.08;
        transform: rotate(-45deg);
        white-space: nowrap;
        user-select: none;
    }
    .watermark.checked-out {
        color: #10b981;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
    }
    .watermark.paid {
        color: #3b82f6;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
    }
    @@media print {
        .watermark {
            opacity: 0.15;
        }
    }

    .guest-type-badge {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .btn-icon {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #6b7280;
        padding: 0.375rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .btn-icon:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #374151;
    }

    .btn-icon-danger {
        color: #dc2626;
        border-color: #fca5a5;
    }

    .btn-icon-danger:hover {
        background: #fee2e2;
        border-color: #dc2626;
        color: #991b1b;
    }

    .btn-icon-info {
        color: #2563eb;
        border-color: #93c5fd;
    }

    .btn-icon-info:hover {
        background: #dbeafe;
        border-color: #2563eb;
        color: #1e40af;
    }

    /* Modern Icon Buttons - Circular Style */
    .modern-icon-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.4);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), inset 0 -2px 4px rgba(0, 0, 0, 0.2);
    }

    .modern-icon-btn i {
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
        transition: transform 0.3s ease;
        filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
    }

    .modern-icon-btn:hover {
        transform: translateY(-3px) scale(1.08);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25), inset 0 -2px 4px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.6);
    }

    .modern-icon-btn:active {
        transform: translateY(-1px) scale(1.02);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2), inset 0 2px 4px rgba(0, 0, 0, 0.25);
    }

    .modern-icon-view {
        background: radial-gradient(circle at 30% 30%, #667eea, #4c63d2);
        color: white;
    }

    .modern-icon-view:hover {
        background: radial-gradient(circle at 30% 30%, #7c8ef5, #667eea);
    }

    .modern-icon-view:hover i {
        transform: scale(1.15);
    }

    .modern-icon-edit {
        background: radial-gradient(circle at 30% 30%, #84cc16, #65a30d);
        color: white;
    }

    .modern-icon-edit:hover {
        background: radial-gradient(circle at 30% 30%, #a3e635, #84cc16);
    }

    .modern-icon-edit:hover i {
        transform: rotate(15deg) scale(1.15);
    }

    .modern-icon-delete {
        background: radial-gradient(circle at 30% 30%, #ef4444, #dc2626);
        color: white;
    }

    .modern-icon-delete:hover {
        background: radial-gradient(circle at 30% 30%, #f87171, #ef4444);
    }

    .modern-icon-delete:hover i {
        transform: scale(1.15) rotate(-8deg);
    }

    /* View Guest Modal Styles */
    .guest-details-view {
        padding: 1.5rem;
        max-height: 65vh;
        overflow-y: auto;
        background: white;
    }

    .detail-section {
        background: linear-gradient(to bottom, #ffffff, #f9fafb);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .detail-section:last-child {
        margin-bottom: 0;
    }

    .section-title-view {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #667eea;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title-view i {
        color: #667eea;
        font-size: 1.2rem;
    }

    .detail-grid-view {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
    }

    .detail-item-view {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .detail-item-view:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .detail-item-view.full-width-view {
        grid-column: 1 / -1;
    }

    .detail-label-view {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .detail-label-view i {
        color: #9ca3af;
        font-size: 0.75rem;
    }

    .detail-value-view {
        font-size: 1rem;
        color: #111827;
        font-weight: 500;
        word-break: break-word;
        line-height: 1.5;
    }

    /* Document Preview */
    .document-preview-container {
        text-align: center;
    }

    .document-preview {
        background: #f3f4f6;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
    }

    .document-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .audit-timeline {
        position: relative;
        padding-left: 2rem;
    }
    .audit-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
    }
    .audit-item {
        position: relative;
        padding-bottom: 2rem;
    }
    .audit-item:last-child {
        padding-bottom: 0;
    }
    .audit-dot {
        position: absolute;
        left: -1.6rem;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: white;
        border: 3px solid #667eea;
        z-index: 1;
    }
    .audit-content {
        background: #f9fafb;
        padding: 1.25rem;
        border-radius: 8px;
        border-left: 3px solid #667eea;
    }
    .audit-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .audit-action {
        font-weight: 600;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .audit-time {
        font-size: 0.85rem;
        color: #6b7280;
    }
    .audit-desc {
        color: #4b5563;
        margin-bottom: 0.5rem;
    }
    .audit-changes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e7eb;
    }
    .audit-old {
        background: #fef2f2;
        padding: 0.75rem;
        border-radius: 6px;
        border-left: 3px solid #ef4444;
    }
    .audit-new {
        background: #f0fdf4;
        padding: 0.75rem;
        border-radius: 6px;
        border-left: 3px solid #10b981;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    .btn-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }
    .btn-secondary:hover {
        background: #667eea;
        color: white;
    }
</style>

@{
    // Watermark logic must use the same computed balance due shown in Financial Summary.
    // (Model.PaymentStatus can be stale/incorrect when there are extra charges or pending room service.)
    var watermarkBookingOtherCharges = ViewBag.BookingOtherCharges as IEnumerable<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>();

    var watermarkOcAmountTotal = watermarkBookingOtherCharges.Sum(x => x.Rate * (x.Qty <= 0 ? 1 : x.Qty));
    var watermarkOcGstTotal = watermarkBookingOtherCharges.Sum(x => x.GSTAmount);
    var watermarkOcGrandTotal = watermarkOcAmountTotal + watermarkOcGstTotal;

    var watermarkRoomServiceLines = ViewBag.RoomServiceLines as IEnumerable<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>
        ?? Enumerable.Empty<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>();

    var watermarkRsActualBillTotal = watermarkRoomServiceLines
        .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
        .Sum(g => g.First().ActualBillAmount);

    var watermarkPayments = (ViewBag.Payments as IEnumerable<HotelApp.Web.Models.BookingPayment>)
        ?? (Model.Payments ?? Enumerable.Empty<HotelApp.Web.Models.BookingPayment>());

    var watermarkAppliedToBalanceFromPayments = watermarkPayments.Sum(p =>
        p.Amount
        + p.DiscountAmount
        + (p.IsRoundOffApplied ? p.RoundOffAmount : 0m)
    );

    var watermarkAdjustedGrandTotal = Model.TotalAmount + watermarkOcGrandTotal + watermarkRsActualBillTotal;
    var watermarkBalanceDueRaw = watermarkAdjustedGrandTotal - watermarkAppliedToBalanceFromPayments;
    var watermarkBalanceDue = Math.Max(0m, Math.Round(watermarkBalanceDueRaw, 2, MidpointRounding.AwayFromZero));
    var showPaidWatermark = watermarkBalanceDueRaw <= 0;
    var showCheckedOutWatermark = Model.ActualCheckOutDate.HasValue;
}

@* Watermarks for Checked Out and Fully Paid bookings *@
@if (showCheckedOutWatermark || showPaidWatermark)
{
    <div class="watermark-container">
        @if (showCheckedOutWatermark)
        {
            <div class="watermark checked-out">CHECKED OUT</div>
        }
        @if (showPaidWatermark)
        {
            <div class="watermark paid">PAID</div>
        }
    </div>
}

<div class="booking-header">
    <div class="booking-header-content">
        <h1 class="booking-number">
            <i class="fas fa-bookmark"></i>
            @Model.BookingNumber
        </h1>
        <span class="booking-status-badge @statusClass">
            <i class="fas fa-circle" style="font-size: 0.6rem;"></i>
            @Model.Status
        </span>
    </div>
    <div class="action-buttons">
        <a asp-action="Receipt" asp-route-bookingNumber="@Model.BookingNumber" class="btn-modern btn-primary" target="_blank" style="margin-right: 0.5rem;">
            <i class="fas fa-receipt"></i> Print Receipt
        </a>
        <a asp-action="List" class="btn-modern btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Bookings
        </a>
    </div>
</div>

<div class="details-grid">
    <div class="detail-card">
        <div class="card-header">
            <div class="card-icon icon-info">
                <i class="fas fa-info-circle"></i>
            </div>
            <h3 class="card-title">Booking Information</h3>
        </div>
        <div class="detail-row">
            <span class="detail-label">Payment Status</span>
            <span class="detail-value">@Model.PaymentStatus</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Channel</span>
            <span class="detail-value">@Model.Channel</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Source</span>
            <span class="detail-value">@Model.Source</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Customer Type</span>
            <span class="detail-value">@Model.CustomerType</span>
        </div>
    </div>

    <div class="detail-card">
        <div class="card-header">
            <div class="card-icon icon-stay">
                <i class="fas fa-bed"></i>
            </div>
            <h3 class="card-title">Stay Details</h3>
        </div>
        <div class="detail-row">
            <span class="detail-label">Room Type</span>
            <span class="detail-value">@Model.RoomType?.TypeName</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Required Rooms</span>
            <span class="detail-value">
                @Model.RequiredRooms
                @if (Model.RequiredRooms > 1)
                {
                    <span style="color: #6366f1; font-weight: 600; margin-left: 8px;">
                        <i class="fas fa-layer-group"></i> Multiple Rooms
                    </span>
                }
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Assigned Room(s)</span>
            <span class="detail-value">
                @if (Model.AssignedRooms != null && Model.AssignedRooms.Any())
                {
                    var roomNumbers = string.Join(", ", Model.AssignedRooms.Select(ar => ar.Room?.RoomNumber));
                    @roomNumbers
                    @if (Model.AssignedRooms.Count > 1)
                    {
                        <span style="color: #6366f1; font-weight: 600; margin-left: 8px;">
                            <i class="fas fa-layer-group"></i> @Model.AssignedRooms.Count Rooms
                        </span>
                    }
                }
                else
                {
                    <text>Not Assigned</text>
                }
            </span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Check-In</span>
            <span class="detail-value">@Model.CheckInDate.ToString("dd MMM yyyy")</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Actual Check-In</span>
            <span class="detail-value">@(Model.ActualCheckInDate.HasValue ? Model.ActualCheckInDate.Value.ToString("dd MMM yyyy hh:mm tt") : "Pending")</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Check-Out</span>
            <span class="detail-value">@Model.CheckOutDate.ToString("dd MMM yyyy")</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Actual Check-Out</span>
            <span class="detail-value">@(Model.ActualCheckOutDate.HasValue ? Model.ActualCheckOutDate.Value.ToString("dd MMM yyyy hh:mm tt") : "Pending")</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Duration</span>
            <span class="detail-value">@Model.Nights Night(s)</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Guests</span>
            <span class="detail-value">@Model.Adults Adult(s), @Model.Children Child(ren)</span>
        </div>
        @if (!string.IsNullOrWhiteSpace(Model.SpecialRequests))
        {
            <div class="detail-row">
                <span class="detail-label">Special Requests</span>
                <span class="detail-value">@Model.SpecialRequests</span>
            </div>
        }
    </div>

    <div class="detail-card">
        <div class="card-header">
            <div class="card-icon icon-guest">
                <i class="fas fa-user"></i>
            </div>
            <h3 class="card-title">Primary Guest</h3>
        </div>
        <div class="detail-row">
            <span class="detail-label">Name</span>
            <span class="detail-value">@Model.PrimaryGuestFirstName @Model.PrimaryGuestLastName</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Email</span>
            <span class="detail-value">@Model.PrimaryGuestEmail</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Phone</span>
            <span class="detail-value">@Model.PrimaryGuestPhone</span>
        </div>
        @if (!string.IsNullOrWhiteSpace(Model.LoyaltyId))
        {
            <div class="detail-row">
                <span class="detail-label">Loyalty ID</span>
                <span class="detail-value">@Model.LoyaltyId</span>
            </div>
        }
    </div>
</div>

<div class="financial-summary">
    <h2 style="margin: 0 0 0.25rem 0; font-size: 1.3rem;">ðŸ’° Financial Summary</h2>
    <p style="opacity: 0.9; margin: 0 0 1rem 0; font-size: 0.9rem;">Complete breakdown of charges and payments</p>
    
    <div class="financial-rows">
        @{
            // Use actual tax percentages from RateMaster instead of recalculating from amounts
            var cgstPercentage = ViewBag.CGSTPercentage != null ? (decimal)ViewBag.CGSTPercentage : 6m;
            var sgstPercentage = ViewBag.SGSTPercentage != null ? (decimal)ViewBag.SGSTPercentage : 6m;

            // Other Charges totals (inclusive of GSTAmount)
            var bookingOtherCharges = ViewBag.BookingOtherCharges as IEnumerable<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>
                ?? Enumerable.Empty<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>();

            var ocAmountTotal = bookingOtherCharges.Sum(x => x.Rate * (x.Qty <= 0 ? 1 : x.Qty));
            var ocGstTotal = bookingOtherCharges.Sum(x => x.GSTAmount);
            var ocCgstTotal = bookingOtherCharges.Sum(x => x.CGSTAmount);
            var ocSgstTotal = bookingOtherCharges.Sum(x => x.SGSTAmount);
            var ocGrandTotal = ocAmountTotal + ocGstTotal;

            // Room Service totals (pending settlement); ActualBillAmount already includes GST
            var roomServiceLines = ViewBag.RoomServiceLines as IEnumerable<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>
                ?? Enumerable.Empty<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>();

            var rsActualBillTotal = roomServiceLines
                .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
                .Sum(g => g.First().ActualBillAmount);
            var rsGstTotal = roomServiceLines
                .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
                .Sum(g => g.First().GSTAmount);
            var rsCgstTotal = roomServiceLines
                .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
                .Sum(g => g.First().CGSTAmount);
            var rsSgstTotal = roomServiceLines
                .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
                .Sum(g => g.First().SGSTAmount);

            // Billing head definitions (from BillingsHeads table; best-effort)
            var billingHeads = ViewBag.BillingHeads as IEnumerable<BillingHead>
                ?? Enumerable.Empty<BillingHead>();

            var billingHeadRows = billingHeads
                .Select(h => new
                {
                    Head = h,
                    Code = (h.Code ?? string.Empty).Trim().ToUpperInvariant()
                })
                .Select(x => new
                {
                    x.Head,
                    Amount = x.Code switch
                    {
                        "S" => (decimal?)Model.TotalAmount,
                        "R" => (decimal?)rsActualBillTotal,
                        "O" => (decimal?)ocGrandTotal,
                        _ => null
                    }
                })
                .Where(x => x.Amount.HasValue)
                .OrderBy(x => (x.Head.Code ?? string.Empty).Trim().ToUpperInvariant() switch
                {
                    "S" => 0,
                    "O" => 1,
                    "R" => 2,
                    _ => 99
                })
                .ThenBy(x => x.Head.Name)
                .ToList();

            var adjustedCgstAmount = Model.CGSTAmount + ocCgstTotal + rsCgstTotal;
            var adjustedSgstAmount = Model.SGSTAmount + ocSgstTotal + rsSgstTotal;
            var adjustedTotalGstAmount = Model.TaxAmount + ocGstTotal + rsGstTotal;
            var adjustedGrandTotal = Model.TotalAmount + ocGrandTotal + rsActualBillTotal;

            // Compute due from payments so payment-time discounts/round-off adjust the balance immediately.
            // (Bookings.BalanceAmount can be stale for older rows.)
            var paymentsForBalance = (ViewBag.Payments as IEnumerable<HotelApp.Web.Models.BookingPayment>)
                ?? (Model.Payments ?? Enumerable.Empty<HotelApp.Web.Models.BookingPayment>());

            var totalRoundOffApplied = paymentsForBalance.Sum(p => p.IsRoundOffApplied ? p.RoundOffAmount : 0m);

            var appliedToBalanceFromPayments = paymentsForBalance.Sum(p =>
                p.Amount
                + p.DiscountAmount
                + (p.IsRoundOffApplied ? p.RoundOffAmount : 0m)
            );

            var paymentDiscountTotal = paymentsForBalance.Sum(p => p.DiscountAmount);
            var adjustedBalanceAmountRaw = adjustedGrandTotal - appliedToBalanceFromPayments;
            var adjustedBalanceAmount = Math.Max(0m, Math.Round(adjustedBalanceAmountRaw, 2, MidpointRounding.AwayFromZero));

            // Allocate paid/applied amount head-wise in the same order as the billing head table.
            // This is best-effort: BookingPayments are not stored per head, so we allocate sequentially
            // across (S)tays, (O)ther Charges, (R)oom Services.
            var billingHeadPaidLookup = billingHeadRows.ToDictionary(
                row => (row.Head.Code ?? string.Empty).Trim().ToUpperInvariant(),
                _ => 0m
            );

            foreach (var payment in paymentsForBalance)
            {
                var applied = payment.Amount
                             + payment.DiscountAmount
                             + (payment.IsRoundOffApplied ? payment.RoundOffAmount : 0m);

                var headCode = (payment.BillingHead ?? string.Empty).Trim().ToUpperInvariant();
                if (!string.IsNullOrWhiteSpace(headCode) && billingHeadPaidLookup.ContainsKey(headCode))
                {
                    billingHeadPaidLookup[headCode] += applied;
                    continue;
                }

                foreach (var row in billingHeadRows)
                {
                    var code = (row.Head.Code ?? string.Empty).Trim().ToUpperInvariant();
                    var currentPaid = billingHeadPaidLookup.TryGetValue(code, out var paid) ? paid : 0m;
                    var due = (row.Amount ?? 0m) - currentPaid;
                    if (due <= 0 || applied <= 0) continue;

                    var allocation = Math.Min(applied, due);
                    billingHeadPaidLookup[code] = currentPaid + allocation;
                    applied -= allocation;
                    if (applied <= 0) break;
                }
            }

            var billingHeadRowsPaid = billingHeadRows
                .Select(row =>
                {
                    var code = (row.Head.Code ?? string.Empty).Trim().ToUpperInvariant();
                    var paidAmount = billingHeadPaidLookup.TryGetValue(code, out var paid) ? paid : 0m;
                    return (Head: row.Head, Amount: row.Amount!.Value, PaidAmount: Math.Min(row.Amount!.Value, paidAmount));
                })
                .ToList();

            var billingHeadRowsWithDue = billingHeadRowsPaid
                .Select(x => (x.Head, x.Amount, x.PaidAmount, Due: Math.Max(0m, x.Amount - x.PaidAmount)))
                .ToList();

            var billingHeadLookup = billingHeads
                .Where(h => !string.IsNullOrWhiteSpace(h.Code))
                .GroupBy(h => (h.Code ?? string.Empty).Trim().ToUpperInvariant())
                .ToDictionary(g => g.Key, g => g.First().Name);

            // Prefer night-wise breakdown (same as what user sees in details table)
            // to avoid incorrect stored DiscountAmount on older multi-night bookings.
            var rooms = Model.RequiredRooms > 0 ? Model.RequiredRooms : 1;
            var roomNights = Model.RoomNights ?? new List<HotelApp.Web.Models.BookingRoomNight>();
            var hasNightBreakdown = roomNights.Any();

            var afterDiscountTotal = hasNightBreakdown
                ? roomNights.Sum(n => n.RateAmount) * rooms
                : Model.BaseAmount;

            var discountPercent = ViewBag.DiscountPercentage != null ? (decimal)ViewBag.DiscountPercentage : 0m;
            var computedDiscountAmount = Model.DiscountAmount;
            if (hasNightBreakdown && discountPercent > 0)
            {
                var divisor = 1 - (discountPercent / 100m);
                if (divisor > 0)
                {
                    var originalTotal = Math.Round(afterDiscountTotal / divisor, 2, MidpointRounding.AwayFromZero);
                    computedDiscountAmount = Math.Round(originalTotal - afterDiscountTotal, 2, MidpointRounding.AwayFromZero);
                }
            }
        }

        <div class="financial-row">
            <div class="financial-row-title">Stay Charges</div>
            <div class="financial-row-items">
                <div class="financial-item">
                    <div class="financial-label">Room Total</div>
                    <div class="financial-amount">â‚¹@Model.BaseAmount.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Stay GST Amount</div>
                    <div class="financial-amount">â‚¹@Model.TaxAmount.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Stay Total (Incl. GST)</div>
                    <div class="financial-amount">â‚¹@Model.TotalAmount.ToString("N2")</div>
                </div>
            </div>
        </div>

        <div class="financial-row">
            <div class="financial-row-title">Other Charges</div>
            <div class="financial-row-items">
                <div class="financial-item">
                    <div class="financial-label">Other Charges Total Amount</div>
                    <div class="financial-amount">â‚¹@ocAmountTotal.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Total GST Amount</div>
                    <div class="financial-amount">â‚¹@ocGstTotal.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Total Other Charges (Incl. GST)</div>
                    <div class="financial-amount">â‚¹@ocGrandTotal.ToString("N2")</div>
                </div>
            </div>
        </div>

        <div class="financial-row">
            <div class="financial-row-title">Room Services</div>
            <div class="financial-row-items">
                <div class="financial-item">
                    <div class="financial-label">Actual Bill (Incl. GST)</div>
                    <div class="financial-amount">â‚¹@rsActualBillTotal.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Total GST Amount</div>
                    <div class="financial-amount">â‚¹@rsGstTotal.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Final Amount</div>
                    <div class="financial-amount">â‚¹@rsActualBillTotal.ToString("N2")</div>
                </div>
            </div>
        </div>

        <div class="financial-row">
            <div class="financial-row-title">Overall</div>
            <div class="financial-row-items">
                <div class="financial-item financial-grand-total">
                    <div class="financial-label">Grand Total</div>
                    <div class="financial-amount">â‚¹@adjustedGrandTotal.ToString("N2")</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">Round Off Applied</div>
                    <div class="financial-amount">â‚¹@totalRoundOffApplied.ToString("N2")</div>
                </div>
                <div class="financial-item financial-highlight-deposit">
                    <div class="financial-label">Deposit Amount</div>
                    <div class="financial-amount">â‚¹@Model.DepositAmount.ToString("N2")</div>
                </div>
                <div class="financial-item financial-highlight-due">
                    <div class="financial-label">Due Amount</div>
                    <div class="financial-amount">â‚¹@adjustedBalanceAmount.ToString("N2")</div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3 class="section-title">Additional Guests</h3>
        <button type="button" class="btn btn-primary" onclick="showAddGuestModal()" style="margin-left: auto;">
            <i class="fas fa-user-plus"></i> Add Guest
        </button>
    </div>
    @if (Model.Guests.Any())
    {
        <div class="guest-list">
            @foreach (var guest in Model.Guests)
            {
                <div class="guest-item" style="flex-direction: column; align-items: flex-start;">
                    <div style="display: flex; align-items: center; width: 100%; margin-bottom: 0.5rem;">
                        <div class="guest-avatar">
                            @(guest.FullName?.Substring(0, 1).ToUpper() ?? "G")
                        </div>
                        <div class="guest-info" style="flex: 1;">
                            <div class="guest-name">
                                @guest.FullName
                                @if (!string.IsNullOrWhiteSpace(guest.RelationshipToPrimary))
                                {
                                    <span style="color: #6b7280; font-weight: normal; font-size: 0.875rem;">(@guest.RelationshipToPrimary)</span>
                                }
                            </div>
                            <div class="guest-details">
                                @if (!string.IsNullOrWhiteSpace(guest.Email))
                                {
                                    <span><i class="fas fa-envelope"></i> @guest.Email</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(guest.Phone))
                                {
                                    <span style="margin-left: 1rem;"><i class="fas fa-phone"></i> @guest.Phone</span>
                                }
                                @if (guest.Age.HasValue)
                                {
                                    <span style="margin-left: 1rem;"><i class="fas fa-birthday-cake"></i> @guest.Age years</span>
                                }
                            </div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(guest.GuestType))
                        {
                            <span class="guest-type-badge">@guest.GuestType</span>
                        }
                        <div style="margin-left: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                            <button type="button" class="modern-icon-btn modern-icon-view" onclick="showViewGuestModal(@guest.Id, @guest.GuestId, '@Html.Raw(guest.FullName?.Replace("'", "\\'"))', '@guest.Email', '@guest.Phone', '@guest.GuestType', '@guest.RelationshipToPrimary', @(guest.Age?.ToString() ?? "null"), '@(guest.DateOfBirth?.ToString("yyyy-MM-dd") ?? "")', '@guest.Gender', '@guest.IdentityType', '@guest.IdentityNumber', '@guest.Country', '@guest.State', '@guest.City', '@guest.Address', '@guest.Pincode', '@guest.DocumentPath')" title="View Guest Details">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor" style="width: 20px; height: 20px;">
                                    <path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/>
                                </svg>
                            </button>
                            @if (!guest.IsPrimary)
                            {
                                <button type="button" class="modern-icon-btn modern-icon-edit" onclick="showEditGuestModal(@guest.Id, '@Html.Raw(guest.FullName?.Replace("'", "\\'"))', '@guest.Email', '@guest.Phone', '@guest.GuestType', '@guest.RelationshipToPrimary', @(guest.Age?.ToString() ?? "null"), '@(guest.DateOfBirth?.ToString("yyyy-MM-dd") ?? "")', '@guest.Gender', '@guest.IdentityType', '@guest.IdentityNumber', @(guest.CountryId?.ToString() ?? "null"), '@guest.Country', @(guest.StateId?.ToString() ?? "null"), '@guest.State', @(guest.CityId?.ToString() ?? "null"), '@guest.City', '@guest.Address', '@guest.Pincode')" title="Edit Guest">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button type="button" class="modern-icon-btn modern-icon-delete" onclick="deleteGuest(@guest.Id, '@Html.Raw(guest.FullName?.Replace("'", "\\'"))')" title="Remove Guest">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            }
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(guest.IdentityType) || !string.IsNullOrWhiteSpace(guest.IdentityNumber))
                    {
                        <div style="padding-left: 3.5rem; color: #6b7280; font-size: 0.875rem;">
                            @if (!string.IsNullOrWhiteSpace(guest.IdentityType))
                            {
                                <span><i class="fas fa-id-card"></i> @guest.IdentityType</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(guest.IdentityNumber))
                            {
                                <span style="margin-left: 1rem;">@guest.IdentityNumber</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <p style="color: #6b7280; text-align: center; padding: 2rem 0;">No additional guests recorded for this booking.</p>
    }
</div>

<script>
    async function syncRoomService(bookingId) {
        try {
            const form = document.getElementById('roomServiceSyncForm');
            const tokenInput = form ? form.querySelector('input[name="__RequestVerificationToken"]') : null;
            const token = tokenInput ? tokenInput.value : null;

            if (!token) {
                Swal.fire({
                    icon: 'error',
                    title: 'Sync Error',
                    text: 'Security token missing. Please refresh the page and try again.',
                    confirmButtonColor: '#667eea'
                });
                return;
            }

            const result = await Swal.fire({
                title: 'Sync Room Service?',
                text: 'This will refresh room service data for this booking.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Sync',
                cancelButtonText: 'Cancel'
            });

            if (!result.isConfirmed) {
                return;
            }

            const response = await fetch('@Url.Action("SyncRoomService", "Booking")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: new URLSearchParams({
                    bookingId: bookingId,
                    __RequestVerificationToken: token
                })
            });

            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`HTTP ${response.status} ${response.statusText}: ${errText}`);
            }
            if (!contentType.includes('application/json')) {
                const errText = await response.text();
                throw new Error(`Unexpected response type: ${contentType}. ${errText}`);
            }

            const apiResult = await response.json();
            if (apiResult.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Synced',
                    text: apiResult.message,
                    confirmButtonColor: '#667eea',
                    timer: 1200,
                    timerProgressBar: true
                }).then(() => location.reload());
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Sync Failed',
                    text: apiResult.message,
                    confirmButtonColor: '#667eea'
                });
            }
        } catch (e) {
            Swal.fire({
                icon: 'error',
                title: 'Sync Failed',
                text: e?.message || 'Unexpected error',
                confirmButtonColor: '#667eea'
            });
        }
    }
</script>

<div class="section-card">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <h3 class="section-title">Payment History</h3>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 0.85rem;">
            @if (billingHeadRowsPaid.Count > 0)
            {
                <div class="form-check" style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <input class="form-check-input" type="checkbox" id="toggleBillingHeadwise" style="margin: 0;">
                    <label class="form-check-label" for="toggleBillingHeadwise" style="margin: 0; font-weight: 600; color: #6b7280;">
                        Billing Head wise Amount
                    </label>
                </div>
            }

            @if (adjustedBalanceAmount > 0)
            {
                <button type="button" class="btn btn-primary" onclick="showPaymentModal()">
                    <i class="fas fa-plus"></i> Add Payment
                </button>
            }
        </div>
    </div>

    @if (billingHeadRowsPaid.Count > 0)
    {
        <div id="billingHeadwiseContainer" style="display: none; margin: 0.25rem 0 1rem 0;">
            <table class="modern-table" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>Billing Head</th>
                        <th class="text-right"><i class="fas fa-rupee-sign"></i> Amount</th>
                        <th class="text-right"><i class="fas fa-rupee-sign"></i> Paid Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in billingHeadRowsPaid)
                    {
                        <tr>
                            <td><strong>@row.Head.Name</strong></td>
                            <td class="text-right" style="font-family: monospace;"><strong>â‚¹@row.Amount.ToString("N2")</strong></td>
                            <td class="text-right" style="font-family: monospace;"><strong>â‚¹@row.PaidAmount.ToString("N2")</strong></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toggle = document.getElementById('toggleBillingHeadwise');
                const container = document.getElementById('billingHeadwiseContainer');
                if (!toggle || !container) return;

                const update = () => {
                    container.style.display = toggle.checked ? '' : 'none';
                };

                toggle.addEventListener('change', update);
                update();
            });
        </script>
    }
    @{
        var payments = ViewBag.Payments as IEnumerable<HotelApp.Web.Models.BookingPayment> ?? Enumerable.Empty<HotelApp.Web.Models.BookingPayment>();
    }
    @if (payments.Any())
    {
        <table class="modern-table">
            <thead>
                <tr>
                    <th><i class="fas fa-calendar"></i> Date</th>
                    <th><i class="fas fa-rupee-sign"></i> Amount</th>
                    <th><i class="fas fa-list"></i> Billing Head</th>
                    <th><i class="fas fa-tags"></i> Discount</th>
                    <th><i class="fas fa-coins"></i> Round Off</th>
                    <th><i class="fas fa-credit-card"></i> Method</th>
                    <th><i class="fas fa-check-circle"></i> Status</th>
                    <th><i class="fas fa-hashtag"></i> Reference</th>
                    <th><i class="fas fa-sticky-note"></i> Notes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var payment in payments)
                {
                    var grossAmount = payment.Amount - payment.RoundOffAmount + payment.DiscountAmount;
                    var headLabel = "-";
                    if (!string.IsNullOrWhiteSpace(payment.BillingHead))
                    {
                        var normalizedHead = payment.BillingHead.Trim().ToUpperInvariant();
                        headLabel = billingHeadLookup.TryGetValue(normalizedHead, out var headName)
                            ? headName
                            : payment.BillingHead;
                    }
                    <tr>
                        <td>@payment.PaidOn.ToString("dd MMM yyyy, hh:mm tt")</td>
                        <td>
                            <strong title="Gross: â‚¹@grossAmount.ToString("N2")">â‚¹@payment.Amount.ToString("N2")</strong>
                            @if (payment.IsAdvancePayment)
                            {
                                <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem;">
                                    <i class="fas fa-star"></i> Advance
                                </span>
                            }
                        </td>
                        <td><strong>@headLabel</strong></td>
                        <td style="font-family: monospace;">â‚¹@payment.DiscountAmount.ToString("N2")</td>
                        <td style="font-family: monospace;">â‚¹@payment.RoundOffAmount.ToString("N2")</td>
                        <td><span class="badge badge-info">@payment.PaymentMethod</span></td>
                        <td><span class="badge badge-success">@payment.Status</span></td>
                        <td style="font-family: monospace;">@(payment.PaymentReference ?? "-")</td>
                        <td>@(payment.Notes ?? "-")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p style="color: #6b7280; text-align: center; padding: 2rem 0;">
            <i class="fas fa-info-circle" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i><br>
            No payments recorded yet.
        </p>
    }
</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-receipt"></i>
        </div>
        <h3 class="section-title">Other Charges</h3>
        @if (!Model.ActualCheckOutDate.HasValue)
        {
            <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                <button type="button" class="btn btn-outline-primary" onclick="openOtherChargesModal('@Model.BookingNumber');" title="Add Other Charges" aria-label="Add Other Charges">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        }
    </div>
    @{
        var otherCharges = ViewBag.BookingOtherCharges as IEnumerable<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>
            ?? Enumerable.Empty<HotelApp.Web.Repositories.BookingOtherChargeDetailRow>();

        string OtherChargeTypeLabel(int type) => type switch
        {
            1 => "Car Rentral",
            2 => "Fitness",
            3 => "Laundry",
            4 => "Others",
            _ => type.ToString()
        };

        var otherAmountTotal = otherCharges.Sum(x => x.Rate * (x.Qty <= 0 ? 1 : x.Qty));
        var otherGstTotal = otherCharges.Sum(x => x.GSTAmount);
        var otherCgstTotal = otherCharges.Sum(x => x.CGSTAmount);
        var otherSgstTotal = otherCharges.Sum(x => x.SGSTAmount);
        var otherGrandTotal = otherAmountTotal + otherGstTotal;
    }

    @if (otherCharges.Any())
    {
        <table class="modern-table">
            <thead>
                <tr>
                    <th><i class="fas fa-hashtag"></i> Code</th>
                    <th><i class="fas fa-tag"></i> Name</th>
                    <th><i class="fas fa-layer-group"></i> Type</th>
                    <th style="text-align:right;"><i class="fas fa-rupee-sign"></i> Rate</th>
                    <th style="text-align:right;"><i class="fas fa-sort-numeric-up"></i> Qty</th>
                    <th style="text-align:right;"><i class="fas fa-rupee-sign"></i> Amount</th>
                    <th><i class="fas fa-sticky-note"></i> Note</th>
                    <th style="text-align:right;"><i class="fas fa-percent"></i> GST %</th>
                    <th style="text-align:right;"><i class="fas fa-receipt"></i> GST Amt</th>
                    <th style="text-align:right;"><i class="fas fa-receipt"></i> CGST Amt</th>
                    <th style="text-align:right;"><i class="fas fa-receipt"></i> SGST Amt</th>
                    <th style="text-align:right;"><i class="fas fa-calculator"></i> Total</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var oc in otherCharges)
                {
                    var safeQty = oc.Qty <= 0 ? 1 : oc.Qty;
                    var amount = oc.Rate * safeQty;
                    <tr>
                        <td style="font-family: monospace;"><strong>@oc.Code</strong></td>
                        <td>@oc.Name</td>
                        <td><span class="badge badge-info">@OtherChargeTypeLabel(oc.Type)</span></td>
                        <td style="text-align:right;"><strong>â‚¹@oc.Rate.ToString("N2")</strong></td>
                        <td style="text-align:right;">@safeQty</td>
                        <td style="text-align:right;"><strong>â‚¹@amount.ToString("N2")</strong></td>
                        <td>@(string.IsNullOrWhiteSpace(oc.Note) ? "-" : oc.Note)</td>
                        <td style="text-align:right;">@oc.GSTPercent.ToString("0.##")</td>
                        <td style="text-align:right;">â‚¹@oc.GSTAmount.ToString("N2")</td>
                        <td style="text-align:right;">â‚¹@oc.CGSTAmount.ToString("N2")</td>
                        <td style="text-align:right;">â‚¹@oc.SGSTAmount.ToString("N2")</td>
                        <td style="text-align:right;"><strong>â‚¹@((amount + oc.GSTAmount).ToString("N2"))</strong></td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" style="text-align:right; font-weight:700;">Totals</td>
                    <td></td>
                    <td></td>
                    <td style="text-align:right; font-weight:700;">â‚¹@otherAmountTotal.ToString("N2")</td>
                    <td></td>
                    <td></td>
                    <td style="text-align:right; font-weight:700;">â‚¹@otherGstTotal.ToString("N2")</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@otherCgstTotal.ToString("N2")</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@otherSgstTotal.ToString("N2")</td>
                    <td style="text-align:right; font-weight:800;">â‚¹@otherGrandTotal.ToString("N2")</td>
                </tr>
            </tfoot>
        </table>
    }
    else
    {
        <p style="color: #6b7280; text-align: center; padding: 2rem 0;">
            <i class="fas fa-info-circle" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i><br>
            No other charges recorded for this booking.
        </p>
    }
</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-concierge-bell"></i>
        </div>
        <h3 class="section-title">Room Service</h3>
        <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
            <a asp-action="RoomServiceReceipt" asp-route-bookingNumber="@Model.BookingNumber" class="btn btn-outline-secondary" target="_blank" title="Print Detail" aria-label="Print Detail">
                <i class="fas fa-print"></i>
            </a>
            <button type="button" class="btn btn-outline-primary" onclick="syncRoomService(@Model.Id)">
                <i class="fas fa-sync-alt"></i> Sync
            </button>
        </div>
    </div>
    @{
        var roomServiceLinesSection = ViewBag.RoomServiceLines as IEnumerable<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>
            ?? Enumerable.Empty<HotelApp.Web.Repositories.RoomServiceSettlementLineRow>();

        var rsNetTotalSection = roomServiceLinesSection.Sum(x => x.NetAmount);
        var rsDiscountTotalSection = roomServiceLinesSection
            .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
            .Sum(g => g.First().DiscountAmount);
        var rsActualBillTotalSection = roomServiceLinesSection
            .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
            .Sum(g => g.First().ActualBillAmount);
        var rsGstTotalSection = roomServiceLinesSection
            .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
            .Sum(g => g.First().GSTAmount);
        var rsCgstTotalSection = roomServiceLinesSection
            .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
            .Sum(g => g.First().CGSTAmount);
        var rsSgstTotalSection = roomServiceLinesSection
            .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
            .Sum(g => g.First().SGSTAmount);

        var rsGrandTotalSection = rsActualBillTotalSection;
    }

    @if (roomServiceLinesSection.Any())
    {
        <table class="modern-table">
            <thead>
                <tr>
                    <th><i class="fas fa-calendar"></i> Order Date</th>
                    <th><i class="fas fa-hashtag"></i> OrderNo</th>
                    <th><i class="fas fa-utensils"></i> MenuItem</th>
                    <th style="text-align:right;"><i class="fas fa-rupee-sign"></i> Price</th>
                    <th style="text-align:right;"><i class="fas fa-sort-numeric-up"></i> Qty</th>
                    <th style="text-align:right;"><i class="fas fa-rupee-sign"></i> Net Amount</th>
                    <th style="text-align:right;"><i class="fas fa-percent"></i> Discount</th>
                    <th style="text-align:right;"><i class="fas fa-rupee-sign"></i> Actual Bill</th>
                    <th style="text-align:right;"><i class="fas fa-receipt"></i> CGST Amount</th>
                    <th style="text-align:right;"><i class="fas fa-receipt"></i> SGST Amount</th>
                    <th style="text-align:right;"><i class="fas fa-receipt"></i> GST Amount</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var orderGroups = roomServiceLinesSection
                        .GroupBy(x => x.OrderId > 0 ? $"oid:{x.OrderId}" : $"ono:{x.OrderNo}")
                        .Select(g => new
                        {
                            Key = g.Key,
                            Rows = g.OrderByDescending(x => x.OrderDate).ThenBy(x => x.MenuItem).ToList(),
                            OrderDate = g.Max(x => x.OrderDate),
                            OrderNo = g.First().OrderNo,
                            CGST = g.First().CGSTAmount,
                            SGST = g.First().SGSTAmount,
                            GST = g.First().GSTAmount
                        })
                        .OrderByDescending(g => g.OrderDate)
                        .ThenByDescending(g => g.OrderNo)
                        .ToList();
                }

                @foreach (var og in orderGroups)
                {
                    var rowspan = og.Rows.Count;
                    for (var i = 0; i < og.Rows.Count; i++)
                    {
                        var line = og.Rows[i];
                        var isFirst = i == 0;
                        <tr>
                            @if (isFirst)
                            {
                                <td style="vertical-align: top; padding-top: 18px;" rowspan="@rowspan">@og.OrderDate.ToString("dd MMM yyyy, hh:mm tt")</td>
                                <td style="font-family: monospace; vertical-align: top; padding-top: 18px;" rowspan="@rowspan"><strong>@og.OrderNo</strong></td>
                            }
                            <td>@line.MenuItem</td>
                            <td style="text-align:right;"><strong>â‚¹@line.Price.ToString("N2")</strong></td>
                            <td style="text-align:right;">@line.Qty</td>
                            <td style="text-align:right;">â‚¹@line.NetAmount.ToString("N2")</td>
                            <td style="text-align:right;">â‚¹@line.DiscountAmount.ToString("N2")</td>
                            <td style="text-align:right;"><strong>â‚¹@line.ActualBillAmount.ToString("N2")</strong></td>
                            @if (isFirst)
                            {
                                <td style="text-align:right; vertical-align: top; padding-top: 18px;" rowspan="@rowspan"><strong>â‚¹@og.CGST.ToString("N2")</strong></td>
                                <td style="text-align:right; vertical-align: top; padding-top: 18px;" rowspan="@rowspan"><strong>â‚¹@og.SGST.ToString("N2")</strong></td>
                                <td style="text-align:right; vertical-align: top; padding-top: 18px;" rowspan="@rowspan"><strong>â‚¹@og.GST.ToString("N2")</strong></td>
                            }
                        </tr>
                    }
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="5" style="text-align:right; font-weight:700;">Totals</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@rsNetTotalSection.ToString("N2")</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@rsDiscountTotalSection.ToString("N2")</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@rsActualBillTotalSection.ToString("N2")</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@rsCgstTotalSection.ToString("N2")</td>
                    <td style="text-align:right; font-weight:700;">â‚¹@rsSgstTotalSection.ToString("N2")</td>
                    <td style="text-align:right; font-weight:800;">â‚¹@rsGstTotalSection.ToString("N2")</td>
                </tr>
            </tfoot>
        </table>
    }
    else
    {
        <p style="color: #6b7280; text-align: center; padding: 2rem 0;">
            <i class="fas fa-info-circle" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i><br>
            No room service orders pending settlement for this booking.
        </p>
    }
</div>

<div class="section-card">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-calendar-day"></i>
        </div>
        <h3 class="section-title">Nightly Rate Breakdown</h3>
    </div>
    @if (Model.RoomNights.Any())
    {
        <table class="modern-table">
            <thead>
                <tr>
                    <th><i class="fas fa-calendar"></i> Date</th>
                    <th><i class="fas fa-tag"></i> Actual Rate</th>
                    <th><i class="fas fa-percentage"></i> Discount</th>
                    <th><i class="fas fa-rupee-sign"></i> Charged Rate</th>
                    <th><i class="fas fa-percentage"></i> CGST</th>
                    <th><i class="fas fa-percentage"></i> SGST</th>
                    <th><i class="fas fa-calculator"></i> Total Tax</th>
                    <th><i class="fas fa-check-circle"></i> Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var night in Model.RoomNights)
                {
                    <tr>
                        <td><strong>@night.StayDate.ToString("ddd, dd MMM yyyy")</strong></td>
                        <td>
                            @if (night.ActualBaseRate > 0)
                            {
                                <span>â‚¹@night.ActualBaseRate.ToString("N2")</span>
                            }
                            else
                            {
                                <span style="color:#9ca3af;">-</span>
                            }
                        </td>
                        <td>
                            @if (night.DiscountAmount > 0)
                            {
                                <span style="color:#dc2626; font-weight: 600;">-â‚¹@night.DiscountAmount.ToString("N2")</span>
                            }
                            else
                            {
                                <span style="color:#9ca3af;">-</span>
                            }
                        </td>
                        <td><strong>â‚¹@night.RateAmount.ToString("N2")</strong></td>
                        <td>â‚¹@night.CGSTAmount.ToString("N2")</td>
                        <td>â‚¹@night.SGSTAmount.ToString("N2")</td>
                        <td><strong>â‚¹@night.TaxAmount.ToString("N2")</strong></td>
                        <td>@night.Status</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div style="text-align: center; padding: 2.5rem 0;">
            <i class="fas fa-calendar-times" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
            <p style="color: #6b7280; font-weight: 500; margin-bottom: 0.5rem;">No nightly breakdown available</p>
            <p style="color: #9ca3af; font-size: 0.9rem;">
                Nightly rate details will be generated automatically when:<br/>
                â€¢ The booking is confirmed, or<br/>
                â€¢ A room is assigned to this booking
            </p>
        </div>
    }
</div>

@{
    var auditLogs = ViewBag.AuditLogs as IEnumerable<HotelApp.Web.Models.BookingAuditLog>;
}
<div class="section-card">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-history"></i>
        </div>
        <h3 class="section-title">Activity Timeline</h3>
    </div>
    @if (auditLogs != null && auditLogs.Any())
    {
        <div class="audit-timeline">
            @foreach (var log in auditLogs)
            {
                <div class="audit-item">
                    <div class="audit-dot"></div>
                    <div class="audit-content">
                        <div class="audit-header-row">
                            <div class="audit-action">
                                <i class="@GetActionIcon(log.ActionType)"></i>
                                <span>@log.ActionType</span>
                            </div>
                            <div class="audit-time">
                                <i class="fas fa-clock"></i> @log.PerformedAt.ToLocalTime().ToString("dd MMM yyyy, hh:mm tt")
                            </div>
                        </div>
                        <div class="audit-desc">@log.ActionDescription</div>
                        @if (!string.IsNullOrWhiteSpace(log.OldValue) || !string.IsNullOrWhiteSpace(log.NewValue))
                        {
                            <div class="audit-changes">
                                @if (!string.IsNullOrWhiteSpace(log.OldValue))
                                {
                                    <div class="audit-old">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem; color: #dc2626;">
                                            <i class="fas fa-minus-circle"></i> Previous Value
                                        </div>
                                        <div>@log.OldValue</div>
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(log.NewValue))
                                {
                                    <div class="audit-new">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem; color: #059669;">
                                            <i class="fas fa-plus-circle"></i> New Value
                                        </div>
                                        <div>@log.NewValue</div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <p style="color: #6b7280; text-align: center; padding: 2rem 0;">
            <i class="fas fa-info-circle" style="font-size: 2rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>
            No activity recorded yet. All changes to this booking will appear here.
        </p>
    }
</div>

@functions {
    private string GetActionClass(string actionType)
    {
        return actionType switch
        {
            "Created" => "action-created",
            "DatesChanged" => "action-dates-changed",
            "RoomAssigned" => "action-room-assigned",
            "RoomChanged" => "action-room-changed",
            "PaymentReceived" => "action-payment",
            "StatusChanged" => "action-status",
            "Cancelled" => "action-cancelled",
            _ => "action-other"
        };
    }

    private string GetActionIcon(string actionType)
    {
        return actionType switch
        {
            "Created" => "fas fa-plus-circle",
            "DatesChanged" => "fas fa-calendar-alt",
            "RoomAssigned" => "fas fa-door-open",
            "RoomChanged" => "fas fa-exchange-alt",
            "PaymentReceived" => "fas fa-money-bill-wave",
            "StatusChanged" => "fas fa-flag",
            "Cancelled" => "fas fa-ban",
            _ => "fas fa-info-circle"
        };
    }
}

<!-- Payment Modal -->
<div id="paymentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-rupee-sign"></i> Record Payment</h3>
            <button type="button" class="close-btn" onclick="closePaymentModal()">&times;</button>
        </div>
        <form id="paymentForm">
            @Html.AntiForgeryToken()
            <input type="hidden" id="bookingNumber" name="bookingNumber" value="@Model.BookingNumber" />
            <input type="hidden" id="isAdvancePayment" name="isAdvancePayment" value="false" />
            <input type="hidden" id="grossAmount" name="grossAmount" value="" />
            <input type="hidden" id="billingHeadAllocations" name="billingHeadAllocations" value="" />

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="discountType">Discount Type</label>
                    <select id="discountType" name="discountType" class="form-control">
                        <option value="None">None</option>
                        <option value="Flat">Flat Amount (â‚¹)</option>
                        <option value="Percent">Discount (%)</option>
                    </select>
                </div>

                <div class="form-group" id="discountValueGroup" style="flex: 1; display: none;">
                    <label for="discountValue" id="discountValueLabel">Discount</label>
                    <input type="number" id="discountValue" name="discountValue" step="0.01" min="0" class="form-control" placeholder="Enter discount" />
                </div>
            </div>

            <div class="form-group" style="margin-top: -6px;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:600;">
                    <input type="checkbox" id="applyRoundOff" name="applyRoundOff" checked />
                    Apply Round Off (Nearest â‚¹)
                </label>
                <small class="text-muted" id="paymentTotalsHint"></small>
            </div>

            @if (billingHeadRowsWithDue.Count > 0)
            {
                <div class="form-group">
                    <label>Billing Head Allocation</label>
                    <div class="billing-head-allocations">
                        @foreach (var row in billingHeadRowsWithDue)
                        {
                            var code = (row.Head.Code ?? string.Empty).Trim().ToUpperInvariant();
                            var due = row.Due;
                            var isDisabled = due <= 0m;
                            <div class="billing-head-row" data-head-code="@code" data-due="@due">
                                <label class="billing-head-label">
                                    <input class="billing-head-toggle" type="checkbox" @(isDisabled ? "disabled" : "checked") />
                                    <span class="billing-head-name">@row.Head.Name (@code)</span>
                                    <span class="billing-head-due">Due: â‚¹@due.ToString("N2")</span>
                                </label>
                                <input type="number"
                                       class="form-control billing-head-amount"
                                       data-head-code="@code"
                                       data-due="@due"
                                       min="0"
                                       max="@due"
                                       step="0.01"
                                       value="@due.ToString("0.00")"
                                       @(isDisabled ? "readonly" : string.Empty) />
                                <small class="text-muted billing-head-discount-note" data-head-code="@code" style="display:block; min-width: 140px;"></small>
                            </div>
                        }
                    </div>
                    <small class="text-muted">Select heads and enter amounts; totals auto-calc the payment.</small>
                </div>
            }
            
            <div class="form-group">
                <label for="amount">Amount (â‚¹) *</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01" max="@adjustedBalanceAmount" 
                       class="form-control" required placeholder="Enter payment amount" />
                <small class="text-muted">Balance Amount: â‚¹@adjustedBalanceAmount.ToString("N2")</small>
            </div>

            <div class="form-group">
                <label for="paymentMethod">Payment Method *</label>
                <select id="paymentMethod" name="paymentMethod" class="form-control" required onchange="handlePaymentMethodChange()">
                    <option value="">Select payment method</option>
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="Cheque">Cheque</option>
                    <option value="UPI">UPI</option>
                    <option value="BankTransfer">Bank Transfer</option>
                </select>
            </div>

            <!-- Card-specific fields -->
            <div id="cardFields" style="display: none;">
                <div class="form-group">
                    <label for="cardType">Card Type *</label>
                    <select id="cardType" name="cardType" class="form-control">
                        <option value="">Select card type</option>
                        <option value="VISA">VISA</option>
                        <option value="MASTER">MASTER</option>
                        <option value="AMERICAN_EXPRESS">AMERICAN EXPRESS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cardLastFourDigits">Card Last 4 Digits *</label>
                    <input type="text" id="cardLastFourDigits" name="cardLastFourDigits" class="form-control" 
                           placeholder="1234" maxlength="4" pattern="[0-9]{4}" />
                    <small class="text-muted">Enter last 4 digits of card</small>
                </div>

                <div class="form-group">
                    <label for="cardBankId">Bank Name *</label>
                    <select id="cardBankId" name="cardBankId" class="form-control">
                        <option value="">Select bank</option>
                        @{
                            var banks = ViewBag.Banks as IEnumerable<HotelApp.Web.Models.Bank> ?? Enumerable.Empty<HotelApp.Web.Models.Bank>();
                            foreach (var bank in banks)
                            {
                                <option value="@bank.Id">@bank.BankName</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <!-- Cheque-specific fields -->
            <div id="chequeFields" style="display: none;">
                <div class="form-group">
                    <label for="chequeBankId">Bank Name *</label>
                    <select id="chequeBankId" name="chequeBankId" class="form-control">
                        <option value="">Select bank</option>
                        @foreach (var bank in banks)
                        {
                            <option value="@bank.Id">@bank.BankName</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label for="chequeDate">Cheque Date *</label>
                    <input type="date" id="chequeDate" name="chequeDate" class="form-control" 
                           max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
            </div>

            <div class="form-group">
                <label for="paymentReference">Payment Reference</label>
                <input type="text" id="paymentReference" name="paymentReference" class="form-control" 
                       placeholder="Transaction ID, Cheque No., etc." />
            </div>

            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-control" rows="2" 
                          placeholder="Additional notes (optional)"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> Record Payment
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Guest Modal -->
<div id="addGuestModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Add Additional Guest</h3>
            <button type="button" class="close-btn" onclick="closeAddGuestModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addGuestForm">
            <input type="hidden" name="bookingNumber" value="@Model.BookingNumber" />
            
            <div class="form-group">
                <label for="guestFullName">Full Name *</label>
                <input type="text" id="guestFullName" name="fullName" class="form-control" 
                       placeholder="Enter guest full name" required />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="relationshipToPrimary">Relationship to Primary Guest *</label>
                    <select id="relationshipToPrimary" name="relationshipToPrimary" class="form-control" required>
                        <option value="">Select Relationship</option>
                        <option value="Spouse">Spouse</option>
                        <option value="Child">Child</option>
                        <option value="Parent">Parent</option>
                        <option value="Sibling">Sibling</option>
                        <option value="Friend">Friend</option>
                        <option value="Colleague">Colleague</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="guestType">Guest Type *</label>
                    <select id="guestType" name="guestType" class="form-control" required>
                        <option value="">Select Type</option>
                        <option value="Adult">Adult</option>
                        <option value="Child">Child</option>
                        <option value="Infant">Infant</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="guestEmail">Email</label>
                    <input type="email" id="guestEmail" name="email" class="form-control" 
                           placeholder="guest@example.com" />
                </div>

                <div class="form-group">
                    <label for="guestPhone">Phone</label>
                    <input type="tel" id="guestPhone" name="phone" class="form-control" 
                           placeholder="Enter phone number" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" name="age" class="form-control" 
                           placeholder="Enter age" min="0" max="150" />
                </div>

                <div class="form-group">
                    <label for="dateOfBirth">Date of Birth</label>
                    <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-control" />
                </div>

                <div class="form-group">
                    <label for="addGuestGender">Gender</label>
                    <select id="addGuestGender" name="gender" class="form-control">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="identityType">Identity Type</label>
                    <select id="identityType" name="identityType" class="form-control">
                        <option value="">Select ID Type</option>
                        <option value="Passport">Passport</option>
                        <option value="Aadhar Card">Aadhar Card</option>
                        <option value="Driving License">Driving License</option>
                        <option value="Voter ID">Voter ID</option>
                        <option value="PAN Card">PAN Card</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="identityNumber">Identity Number</label>
                    <input type="text" id="identityNumber" name="identityNumber" class="form-control" 
                           placeholder="Enter ID number" />
                </div>
            </div>

            <div class="form-group">
                <label for="addGuestCountry">Country</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="addGuestCountry" 
                           class="form-control autocomplete-input" 
                           placeholder="Type to search country..." 
                           autocomplete="new-password" />
                    <div id="addGuestCountryResults" class="autocomplete-results"></div>
                </div>
                <input type="hidden" id="addGuestCountryId" name="countryId" />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="addGuestState">State</label>
                    <div style="position: relative;">
                        <input type="text" 
                               id="addGuestState" 
                               class="form-control autocomplete-input" 
                               placeholder="Select country first..." 
                               autocomplete="new-password" 
                               disabled />
                        <div id="addGuestStateResults" class="autocomplete-results"></div>
                    </div>
                    <input type="hidden" id="addGuestStateId" name="stateId" />
                </div>

                <div class="form-group">
                    <label for="addGuestCity">City</label>
                    <div style="position: relative;">
                        <input type="text" 
                               id="addGuestCity" 
                               class="form-control autocomplete-input" 
                               placeholder="Select state first..." 
                               autocomplete="new-password" 
                               disabled />
                        <div id="addGuestCityResults" class="autocomplete-results"></div>
                    </div>
                    <input type="hidden" id="addGuestCityId" name="cityId" />
                </div>
            </div>

            <div class="form-group">
                <label for="addGuestAddress">Address</label>
                <textarea id="addGuestAddress" name="address" class="form-control" rows="2" 
                          placeholder="Enter street address, building name, etc."></textarea>
            </div>

            <div class="form-group">
                <label for="addGuestPincode">Pincode</label>
                <input type="text" id="addGuestPincode" name="pincode" class="form-control" 
                       placeholder="Enter pincode" maxlength="20" />
            </div>

            <div class="form-group">
                <label for="documentUpload">Upload Document (Optional)</label>
                <input type="file" id="documentUpload" name="document" class="form-control" 
                       accept="image/*,.pdf" />
                <small style="color: #6b7280; font-size: 0.875rem;">Accepted: Images, PDF (Max 5MB)</small>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddGuestModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Add Guest
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Guest Modal -->
<div id="editGuestModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Guest</h3>
            <button type="button" class="close-btn" onclick="closeEditGuestModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editGuestForm">
            <input type="hidden" id="editGuestId" name="guestId" />
            
            <div class="form-group">
                <label for="editGuestFullName">Full Name *</label>
                <input type="text" id="editGuestFullName" name="fullName" class="form-control" 
                       placeholder="Enter guest full name" required />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editRelationshipToPrimary">Relationship to Primary Guest *</label>
                    <select id="editRelationshipToPrimary" name="relationshipToPrimary" class="form-control" required>
                        <option value="">Select Relationship</option>
                        <option value="Spouse">Spouse</option>
                        <option value="Child">Child</option>
                        <option value="Parent">Parent</option>
                        <option value="Sibling">Sibling</option>
                        <option value="Friend">Friend</option>
                        <option value="Colleague">Colleague</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editGuestType">Guest Type *</label>
                    <select id="editGuestType" name="guestType" class="form-control" required>
                        <option value="">Select Type</option>
                        <option value="Adult">Adult</option>
                        <option value="Child">Child</option>
                        <option value="Infant">Infant</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editGuestEmail">Email</label>
                    <input type="email" id="editGuestEmail" name="email" class="form-control" 
                           placeholder="guest@example.com" />
                </div>

                <div class="form-group">
                    <label for="editGuestPhone">Phone</label>
                    <input type="tel" id="editGuestPhone" name="phone" class="form-control" 
                           placeholder="Enter phone number" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editAge">Age</label>
                    <input type="number" id="editAge" name="age" class="form-control" 
                           placeholder="Enter age" min="0" max="150" />
                </div>

                <div class="form-group">
                    <label for="editDateOfBirth">Date of Birth</label>
                    <input type="date" id="editDateOfBirth" name="dateOfBirth" class="form-control" />
                </div>

                <div class="form-group">
                    <label for="editGuestGender">Gender</label>
                    <select id="editGuestGender" name="gender" class="form-control">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editIdentityType">Identity Type</label>
                    <select id="editIdentityType" name="identityType" class="form-control">
                        <option value="">Select ID Type</option>
                        <option value="Passport">Passport</option>
                        <option value="Aadhar Card">Aadhar Card</option>
                        <option value="Driving License">Driving License</option>
                        <option value="Voter ID">Voter ID</option>
                        <option value="PAN Card">PAN Card</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editIdentityNumber">Identity Number</label>
                    <input type="text" id="editIdentityNumber" name="identityNumber" class="form-control" 
                           placeholder="Enter ID number" />
                </div>
            </div>

            <div class="form-group">
                <label for="editGuestCountry">Country</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="editGuestCountry" 
                           class="form-control autocomplete-input" 
                           placeholder="Type to search country..." 
                           autocomplete="new-password" />
                    <div id="editGuestCountryResults" class="autocomplete-results"></div>
                </div>
                <input type="hidden" id="editGuestCountryId" name="countryId" />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editGuestState">State</label>
                    <div style="position: relative;">
                        <input type="text" 
                               id="editGuestState" 
                               class="form-control autocomplete-input" 
                               placeholder="Select country first..." 
                               autocomplete="new-password" 
                               disabled />
                        <div id="editGuestStateResults" class="autocomplete-results"></div>
                    </div>
                    <input type="hidden" id="editGuestStateId" name="stateId" />
                </div>

                <div class="form-group">
                    <label for="editGuestCity">City</label>
                    <div style="position: relative;">
                        <input type="text" 
                               id="editGuestCity" 
                               class="form-control autocomplete-input" 
                               placeholder="Select state first..." 
                               autocomplete="new-password" 
                               disabled />
                        <div id="editGuestCityResults" class="autocomplete-results"></div>
                    </div>
                    <input type="hidden" id="editGuestCityId" name="cityId" />
                </div>
            </div>

            <div class="form-group">
                <label for="editGuestAddress">Address</label>
                <textarea id="editGuestAddress" name="address" class="form-control" rows="2" 
                          placeholder="Enter street address, building name, etc."></textarea>
            </div>

            <div class="form-group">
                <label for="editGuestPincode">Pincode</label>
                <input type="text" id="editGuestPincode" name="pincode" class="form-control" 
                       placeholder="Enter pincode" maxlength="20" />
            </div>

            <div class="form-group">
                <label for="editDocumentUpload">Upload Document (Optional)</label>
                <input type="file" id="editDocumentUpload" name="document" class="form-control" 
                       accept="image/*,.pdf" />
                <small style="color: #6b7280; font-size: 0.875rem;">Accepted: Images, PDF (Max 5MB)</small>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditGuestModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Guest
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Guest Details Modal -->
<div id="viewGuestModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i> Guest Details
            </h3>
            <button type="button" class="close-btn" onclick="closeViewGuestModal()" style="color: white; border-color: rgba(255,255,255,0.3);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="guest-details-view">
            <!-- Personal Information -->
            <div class="detail-section">
                <div class="section-title-view">
                    <i class="fas fa-user"></i> Personal Information
                </div>
                <div class="detail-grid-view">
                    <div class="detail-item-view full-width-view" id="viewPhotoSection" style="display:none;">
                        <div class="detail-label-view"><i class="fas fa-camera"></i> Photo</div>
                        <div class="detail-value-view">
                            <img id="viewGuestPhotoImg" alt="Guest Photo" style="max-width: 100%; max-height: 320px; border-radius: 10px; object-fit: contain; display:block;" />
                        </div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-signature"></i> Full Name</div>
                        <div class="detail-value-view" id="viewFullName">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-tag"></i> Guest Type</div>
                        <div class="detail-value-view" id="viewGuestType">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-users"></i> Relationship</div>
                        <div class="detail-value-view" id="viewRelationship">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-birthday-cake"></i> Age</div>
                        <div class="detail-value-view" id="viewAge">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-calendar-day"></i> Date of Birth</div>
                        <div class="detail-value-view" id="viewDOB">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-venus-mars"></i> Gender</div>
                        <div class="detail-value-view" id="viewGender">-</div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="detail-section">
                <div class="section-title-view">
                    <i class="fas fa-address-book"></i> Contact Information
                </div>
                <div class="detail-grid-view">
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-envelope"></i> Email</div>
                        <div class="detail-value-view" id="viewEmail">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-phone"></i> Phone</div>
                        <div class="detail-value-view" id="viewPhone">-</div>
                    </div>
                </div>
            </div>

            <!-- Identity Information -->
            <div class="detail-section">
                <div class="section-title-view">
                    <i class="fas fa-id-card"></i> Identity Information
                </div>
                <div class="detail-grid-view">
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-id-badge"></i> Identity Type</div>
                        <div class="detail-value-view" id="viewIdentityType">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-hashtag"></i> Identity Number</div>
                        <div class="detail-value-view" id="viewIdentityNumber">-</div>
                    </div>
                </div>
            </div>

            <!-- Document Section -->
            <div class="detail-section" id="viewDocumentSection" style="display: none;">
                <div class="section-title-view">
                    <i class="fas fa-file-alt"></i> Attached Document
                </div>
                <div class="document-preview-container">
                    <div class="document-preview" id="viewDocumentPreview">
                        <i class="fas fa-file-image" style="font-size: 3rem; color: #9ca3af;"></i>
                        <p style="margin-top: 0.5rem; color: #6b7280;">Document Preview</p>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" id="viewDocumentBtn" style="margin-top: 1rem;">
                        <i class="fas fa-external-link-alt"></i> View Full Document
                    </button>
                </div>
            </div>

            <!-- Location Information -->
            <div class="detail-section">
                <div class="section-title-view">
                    <i class="fas fa-map-marker-alt"></i> Location Information
                </div>
                <div class="detail-grid-view">
                    <div class="detail-item-view full-width-view">
                        <div class="detail-label-view"><i class="fas fa-home"></i> Address</div>
                        <div class="detail-value-view" id="viewAddress">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-city"></i> City</div>
                        <div class="detail-value-view" id="viewCity">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-map"></i> State</div>
                        <div class="detail-value-view" id="viewState">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-globe"></i> Country</div>
                        <div class="detail-value-view" id="viewCountry">-</div>
                    </div>
                    <div class="detail-item-view">
                        <div class="detail-label-view"><i class="fas fa-mail-bulk"></i> Pincode</div>
                        <div class="detail-value-view" id="viewPincode">-</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="background: #f9fafb; padding: 1.25rem;">
            <button type="button" class="btn btn-secondary" onclick="closeViewGuestModal()">
                <i class="fas fa-times-circle"></i> Close
            </button>
        </div>
    </div>
</div>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease-out;
        overflow: hidden;
    }

    @@keyframes slideIn {
        from {
            transform: translateY(-30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-header h3 i {
        font-size: 1rem;
    }

    .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .close-btn i {
        font-size: 1.125rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1.25rem 1.5rem;
        background: #f9fafb;
        border-radius: 0 0 12px 12px;
        border-top: 1px solid #e5e7eb;
        position: sticky;
        bottom: 0;
    }

    #paymentForm, #addGuestForm, #editGuestForm {
        padding: 1.5rem;
        max-height: calc(90vh - 140px);
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .billing-head-allocations {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.85rem;
    }

    .billing-head-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        justify-content: space-between;
    }

    .billing-head-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        flex: 1;
    }

    .billing-head-name {
        font-weight: 700;
        color: #111827;
    }

    .billing-head-due {
        color: #6b7280;
        font-weight: 600;
    }

    .billing-head-amount {
        max-width: 180px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
        font-size: 0.9rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    @@media (max-width: 640px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .text-muted {
        display: block;
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.3rem;
    }

    .btn {
        padding: 0.65rem 1.25rem;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #d1d5db;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        margin-bottom: 1rem;
    }

    .badge {
        padding: 0.35rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    /* Override SweetAlert2 z-index to appear above payment modal */
    .swal2-container {
        z-index: 99999 !important;
    }

    /* Autocomplete Styles */
    .autocomplete-input {
        width: 100%;
    }

    .autocomplete-input:disabled {
        background-color: #f3f4f6;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 250px;
        overflow-y: auto;
        background: white;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: none;
        margin-top: 0;
    }

    .autocomplete-results.show {
        display: block;
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
        background-color: #edf2f7;
        color: #667eea;
        font-weight: 500;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-no-results {
        padding: 10px 15px;
        color: #6b7280;
        font-style: italic;
        text-align: center;
    }
</style>

@section Scripts {
<script>
    let isProgrammaticAmountUpdate = false;

    function toPaise(val) {
        const n = Number(val);
        if (!Number.isFinite(n)) return 0;
        return Math.round((n + Number.EPSILON) * 100);
    }

    function fromPaise(paise) {
        const n = Number(paise);
        if (!Number.isFinite(n)) return 0;
        return n / 100;
    }

    function round2(val) {
        const n = Number(val);
        if (!Number.isFinite(n)) return 0;
        return Math.round((n + Number.EPSILON) * 100) / 100;
    }

    function collectBillingHeadAllocations() {
        const rows = Array.from(document.querySelectorAll('.billing-head-row'));
        const allocations = [];
        let total = 0;

        rows.forEach(row => {
            const toggle = row.querySelector('.billing-head-toggle');
            const amountInput = row.querySelector('.billing-head-amount');
            if (!toggle || !amountInput || !toggle.checked) return;

            const amount = parseFloat(amountInput.value || '0') || 0;
            if (amount <= 0) return;

            allocations.push({
                billingHeadCode: amountInput.dataset.headCode || null,
                amount: round2(amount)
            });
            total += amount;
        });

        return { allocations, total: round2(total) };
    }

    function isDiscountableHead(code) {
        const normalized = (code || '').trim().toUpperCase();
        return normalized === 'S' || normalized === 'O';
    }

    function getDiscountableSelection() {
        const data = collectBillingHeadAllocations();
        const discountable = data.allocations.filter(a => isDiscountableHead(a.billingHeadCode));
        return {
            data,
            discountable,
            isSingleDiscountableSelected: discountable.length === 1 && data.allocations.length === 1
        };
    }

    function syncBillingHeadGrossFromUI() {
        const { allocations, total } = collectBillingHeadAllocations();
        const amountEl = document.getElementById('amount');
        setGrossAmount(total);
        if (amountEl) {
            isProgrammaticAmountUpdate = true;
            amountEl.value = total.toFixed(2);
            isProgrammaticAmountUpdate = false;
        }

        const hiddenAlloc = document.getElementById('billingHeadAllocations');
        if (hiddenAlloc) {
            hiddenAlloc.value = JSON.stringify(allocations);
        }

        updatePaymentHint();
        return { allocations, total };
    }

    function updateAmountMaxConstraint() {
        const amountEl = document.getElementById('amount');
        if (!amountEl) return;

        const applyRoundOff = document.getElementById('applyRoundOff')?.checked;

        const baseMaxStr = amountEl.getAttribute('data-base-max') || amountEl.getAttribute('max') || '0';
        const baseMaxPaise = toPaise(baseMaxStr);

        // If round-off is applied, user may need to pay up to the next rupee.
        // Example: balance 5939.50 => rounded payable 5940.00.
        const maxPaise = applyRoundOff
            ? (Math.ceil(baseMaxPaise / 100) * 100)
            : baseMaxPaise;

        amountEl.setAttribute('max', fromPaise(maxPaise).toFixed(2));
    }

    function getGrossAmount() {
        const grossEl = document.getElementById('grossAmount');
        const amountEl = document.getElementById('amount');
        const gross = grossEl?.value ? parseFloat(grossEl.value) : NaN;
        if (Number.isFinite(gross)) return gross;
        const amt = parseFloat(amountEl?.value || '0');
        return Number.isFinite(amt) ? amt : 0;
    }

    function setGrossAmount(value) {
        const grossEl = document.getElementById('grossAmount');
        if (grossEl) grossEl.value = round2(value).toFixed(2);
    }

    function applyNetToAmountField() {
        const amountEl = document.getElementById('amount');
        if (!amountEl) return;

        // When head-wise inputs drive gross amount, keep the field as display-only.
        if (amountEl.hasAttribute('readonly')) return;

        const discountType = document.getElementById('discountType')?.value;
        const applyRoundOff = document.getElementById('applyRoundOff')?.checked;
        const shouldAutoFillNet = (discountType && discountType !== 'None') || !!applyRoundOff;
        if (!shouldAutoFillNet) return;

        const totals = computePaymentTotals();
        isProgrammaticAmountUpdate = true;
        amountEl.value = totals.netPayable.toFixed(2);
        isProgrammaticAmountUpdate = false;
    }

    function computePaymentTotals() {
        const discountTypeEl = document.getElementById('discountType');
        const discountValueEl = document.getElementById('discountValue');
        const discountType = discountTypeEl ? discountTypeEl.value : 'None';
        const discountValue = discountValueEl ? (parseFloat(discountValueEl.value || '0') || 0) : 0;
        const applyRoundOff = document.getElementById('applyRoundOff').checked;

        const selection = getDiscountableSelection();
        const hasHeadRows = document.querySelectorAll('.billing-head-row').length > 0;
        const allocationData = hasHeadRows ? selection.data : { allocations: [], total: getGrossAmount() };
        const grossAmount = hasHeadRows ? allocationData.total : getGrossAmount();

        const grossPaise = toPaise(grossAmount);
        const discountablePaiseBase = selection.isSingleDiscountableSelected
            ? toPaise(selection.discountable[0].amount)
            : 0;

        let discountAmount = 0;
        let discountPercent = null;
        let discountPaise = 0;

        if (discountablePaiseBase > 0 && discountType !== 'None') {
            if (discountType === 'Flat') {
                discountPaise = Math.min(discountablePaiseBase, Math.max(0, toPaise(discountValue)));
            } else if (discountType === 'Percent') {
                const pct = Math.max(0, Math.min(100, discountValue));
                discountPercent = round2(pct);
                discountPaise = Math.max(0, Math.round(discountablePaiseBase * (pct / 100)));
            }
        } else {
            discountPaise = 0;
            discountPercent = null;
        }

        let netPaise = grossPaise - discountPaise;
        if (netPaise < 0) {
            netPaise = 0;
            discountPaise = grossPaise;
        }

        let roundOffPaise = 0;
        if (applyRoundOff) {
            // Round to nearest rupee (100 paise)
            const roundedPaise = Math.round(netPaise / 100) * 100;
            roundOffPaise = roundedPaise - netPaise;
            netPaise = roundedPaise;
        }

        discountAmount = fromPaise(discountPaise);
        const roundOffAmount = fromPaise(roundOffPaise);
        const net = fromPaise(netPaise);

        return {
            grossAmount: fromPaise(grossPaise),
            discountAmount: round2(discountAmount),
            discountPercent,
            roundOffAmount: round2(roundOffAmount),
            netPayable: round2(net),
            isRoundOffApplied: applyRoundOff
        };
    }

    function updateDiscountUI() {
        const discountTypeEl = document.getElementById('discountType');
        const group = document.getElementById('discountValueGroup');
        const label = document.getElementById('discountValueLabel');
        const input = document.getElementById('discountValue');
        const selection = getDiscountableSelection();
        const hasDiscountable = selection.isSingleDiscountableSelected || document.querySelectorAll('.billing-head-row').length === 0;

        if (!hasDiscountable) {
            if (discountTypeEl) {
                discountTypeEl.value = 'None';
                discountTypeEl.setAttribute('disabled', 'disabled');
            }
            if (input) input.value = '';
        } else if (discountTypeEl) {
            discountTypeEl.removeAttribute('disabled');
        }

        const currentType = discountTypeEl ? discountTypeEl.value : 'None';

        if (currentType === 'None') {
            group.style.display = 'none';
            if (input) {
                input.value = '';
                input.removeAttribute('max');
            }
        } else {
            group.style.display = 'block';
            if (currentType === 'Flat') {
                label.textContent = 'Discount Amount (â‚¹)';
                input.setAttribute('max', '999999999');
            } else {
                label.textContent = 'Discount (%)';
                input.setAttribute('max', '100');
            }
        }

        // Do NOT overwrite grossAmount here.
        // The Amount field may already be auto-filled to NET (e.g., 0.00 for discount-only settlement),
        // and overwriting gross with that would zero out discounts and keep Due unchanged.
        updatePaymentHint();
        updateAmountMaxConstraint();
        applyNetToAmountField();
    }

    function updatePaymentHint() {
        const hint = document.getElementById('paymentTotalsHint');
        if (!hint) return;
        const t = computePaymentTotals();

        const parts = [];
        if (t.discountAmount > 0) parts.push(`Discount: â‚¹${t.discountAmount.toFixed(2)}`);
        if (t.isRoundOffApplied && t.roundOffAmount !== 0) {
            const sign = t.roundOffAmount > 0 ? '+' : '-';
            parts.push(`Round Off: ${sign}â‚¹${Math.abs(t.roundOffAmount).toFixed(2)}`);
        }
        parts.push(`Net Payable: â‚¹${t.netPayable.toFixed(2)}`);
        hint.textContent = parts.join(' | ');

        // Keep HTML validation constraints in sync with computed totals.
        updateAmountMaxConstraint();
        updateHeadwiseDiscountNotes(t);
    }

    function updateHeadwiseDiscountNotes(totals) {
        const notes = document.querySelectorAll('.billing-head-discount-note');
        notes.forEach(n => n.textContent = '');

        if (!totals || totals.discountAmount <= 0) return;

        const selection = getDiscountableSelection();
        if (!selection.isSingleDiscountableSelected || selection.discountable.length === 0) return;

        const target = selection.discountable[0];
        const code = (target.billingHeadCode || '').trim().toUpperCase();
        const noteEl = document.querySelector(`.billing-head-discount-note[data-head-code="${code}"]`);
        if (!noteEl) return;

        const discountedNet = Math.max(0, round2(target.amount - totals.discountAmount));
        noteEl.textContent = `Discount: â‚¹${totals.discountAmount.toFixed(2)} | Net: â‚¹${discountedNet.toFixed(2)}`;
    }

    function applyDefaultAdvanceAllocation(minAdvanceAmount) {
        const rows = Array.from(document.querySelectorAll('.billing-head-row'));
        if (rows.length === 0) return;

        const targetRow = rows.find(r => (r.dataset.headCode || '').trim().toUpperCase() === 'S') || rows[0];
        const targetAmount = round2(parseFloat(minAdvanceAmount || '0') || 0);

        rows.forEach(row => {
            const toggle = row.querySelector('.billing-head-toggle');
            const input = row.querySelector('.billing-head-amount');
            if (!toggle || !input) return;

            if (row === targetRow) {
                const due = parseFloat(input.dataset.due || '0') || 0;
                const val = round2(Math.min(targetAmount, due > 0 ? due : targetAmount));
                input.value = val.toFixed(2);
                if (!toggle.disabled) toggle.checked = val > 0;
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
            } else {
                input.value = '0.00';
                if (!toggle.disabled) toggle.checked = false;
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('disabled', 'disabled');
            }
        });

        syncBillingHeadGrossFromUI();
    }

    async function showPaymentModal(isAdvance = false) {
        const balanceAmount = @adjustedBalanceAmount;
        const modal = document.getElementById('paymentModal');
        const amountField = document.getElementById('amount');
        const isAdvanceField = document.getElementById('isAdvancePayment');
        const hasBillingHeads = document.querySelectorAll('.billing-head-row').length > 0;

        if (!modal || !amountField || !isAdvanceField) return;

        modal.style.display = 'flex';

        if (isAdvance) {
            try {
                const response = await fetch('/HotelSettings/GetSettings');
                const result = await response.json();

                if (result.success && result.minimumBookingAmountRequired) {
                    const totalAmount = @Model.TotalAmount;
                    const minPercentage = result.minimumBookingAmount;
                    const minAdvanceAmount = (totalAmount * minPercentage / 100).toFixed(2);

                    amountField.value = minAdvanceAmount;
                    setGrossAmount(parseFloat(minAdvanceAmount) || 0);
                    amountField.setAttribute('min', minAdvanceAmount);
                    amountField.setAttribute('data-min-advance', minAdvanceAmount);
                    if (hasBillingHeads) {
                        applyDefaultAdvanceAllocation(minAdvanceAmount);
                    }
                } else {
                    amountField.value = balanceAmount.toFixed(2);
                    setGrossAmount(balanceAmount);
                }
            } catch (error) {
                console.error('Error fetching hotel settings:', error);
                amountField.value = balanceAmount.toFixed(2);
                setGrossAmount(balanceAmount);
            }

            isAdvanceField.value = 'true';
        } else {
            amountField.value = balanceAmount.toFixed(2);
            setGrossAmount(balanceAmount);
            amountField.removeAttribute('min');
            amountField.removeAttribute('data-min-advance');
            isAdvanceField.value = 'false';
        }

        amountField.setAttribute('data-base-max', balanceAmount.toFixed(2));
        amountField.setAttribute('max', balanceAmount.toFixed(2));

        const discountType = document.getElementById('discountType');
        const discountValue = document.getElementById('discountValue');
        const applyRoundOff = document.getElementById('applyRoundOff');
        if (discountType) discountType.value = 'None';
        if (discountValue) discountValue.value = '';
        if (applyRoundOff) applyRoundOff.checked = true;

        if (hasBillingHeads) {
            amountField.setAttribute('readonly', 'readonly');
            syncBillingHeadGrossFromUI();
        } else {
            amountField.removeAttribute('readonly');
            setGrossAmount(parseFloat(amountField.value || '0') || 0);
            const allocHidden = document.getElementById('billingHeadAllocations');
            if (allocHidden) allocHidden.value = '';
        }

        updateDiscountUI();
        updateAmountMaxConstraint();
        amountField.focus();
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
        document.getElementById('paymentForm').reset();
        document.getElementById('cardFields').style.display = 'none';
        document.getElementById('chequeFields').style.display = 'none';
        const allocHidden = document.getElementById('billingHeadAllocations');
        if (allocHidden) allocHidden.value = '';
    }

    function handlePaymentMethodChange() {
        const paymentMethod = document.getElementById('paymentMethod').value;
        const cardFields = document.getElementById('cardFields');
        const chequeFields = document.getElementById('chequeFields');
        
        // Hide all conditional fields
        cardFields.style.display = 'none';
        chequeFields.style.display = 'none';
        
        // Clear required attributes
        document.getElementById('cardType').removeAttribute('required');
        document.getElementById('cardLastFourDigits').removeAttribute('required');
        document.getElementById('cardBankId').removeAttribute('required');
        document.getElementById('chequeBankId').removeAttribute('required');
        document.getElementById('chequeDate').removeAttribute('required');
        
        // Show relevant fields and set required attributes
        if (paymentMethod === 'Card') {
            cardFields.style.display = 'block';
            document.getElementById('cardType').setAttribute('required', 'required');
            document.getElementById('cardLastFourDigits').setAttribute('required', 'required');
            document.getElementById('cardBankId').setAttribute('required', 'required');
        } else if (paymentMethod === 'Cheque') {
            chequeFields.style.display = 'block';
            document.getElementById('chequeBankId').setAttribute('required', 'required');
            document.getElementById('chequeDate').setAttribute('required', 'required');
        }
    }

    $(document).ready(function() {
        // Test if SweetAlert2 is loaded
        console.log('SweetAlert2 loaded:', typeof Swal !== 'undefined');
        
        // Discount and round-off UI behaviors
        const discountTypeEl = document.getElementById('discountType');
        const discountValueEl = document.getElementById('discountValue');
        const amountEl = document.getElementById('amount');
        const roundOffEl = document.getElementById('applyRoundOff');
        if (discountTypeEl) discountTypeEl.addEventListener('change', updateDiscountUI);
        if (discountValueEl) discountValueEl.addEventListener('input', () => {
            updatePaymentHint();
            applyNetToAmountField();
        });

        if (amountEl) {
            amountEl.addEventListener('input', () => {
                if (isProgrammaticAmountUpdate) return;
                // Treat typed value as GROSS input.
                const v = parseFloat(amountEl.value || '0') || 0;
                setGrossAmount(v);
                updatePaymentHint();
            });
            amountEl.addEventListener('blur', () => {
                applyNetToAmountField();
                updatePaymentHint();
            });
        }

        if (roundOffEl) roundOffEl.addEventListener('change', () => {
            updatePaymentHint();
            applyNetToAmountField();
        });

        const billingHeadRows = Array.from(document.querySelectorAll('.billing-head-row'));

        const refreshHeadRow = (row) => {
            const toggle = row.querySelector('.billing-head-toggle');
            const amountInput = row.querySelector('.billing-head-amount');
            if (!toggle || !amountInput) return;

            if (toggle.checked) {
                amountInput.removeAttribute('readonly');
                amountInput.removeAttribute('disabled');
                const due = parseFloat(amountInput.dataset.due || '0') || 0;
                const val = parseFloat(amountInput.value || '0') || 0;
                if (val <= 0 && due > 0) {
                    amountInput.value = due.toFixed(2);
                }
            } else {
                amountInput.value = '0.00';
                amountInput.setAttribute('readonly', 'readonly');
                amountInput.setAttribute('disabled', 'disabled');
            }
        };

        billingHeadRows.forEach(row => {
            const toggle = row.querySelector('.billing-head-toggle');
            const amountInput = row.querySelector('.billing-head-amount');

            if (toggle) {
                toggle.addEventListener('change', () => {
                    refreshHeadRow(row);
                    syncBillingHeadGrossFromUI();
                    updateDiscountUI();
                });
            }

            if (amountInput) {
                amountInput.addEventListener('input', () => {
                    const due = parseFloat(amountInput.dataset.due || '0') || 0;
                    let val = parseFloat(amountInput.value || '0') || 0;
                    if (due > 0 && val > due) {
                        val = due;
                    }
                    val = round2(val);
                    amountInput.value = val.toFixed(2);

                    if (toggle && val > 0 && !toggle.checked && !toggle.disabled) {
                        toggle.checked = true;
                        refreshHeadRow(row);
                    }

                    syncBillingHeadGrossFromUI();
                    updateDiscountUI();
                });

                amountInput.addEventListener('blur', () => {
                    const min = parseFloat(amountInput.getAttribute('min') || '0') || 0;
                    const max = parseFloat(amountInput.getAttribute('max') || '0') || 0;
                    let val = parseFloat(amountInput.value || '0') || 0;
                    if (max > 0 && val > max) val = max;
                    if (val < min) val = min;
                    amountInput.value = round2(val).toFixed(2);
                    syncBillingHeadGrossFromUI();
                    updateDiscountUI();
                });
            }

            refreshHeadRow(row);
        });

        if (billingHeadRows.length > 0) {
            syncBillingHeadGrossFromUI();
            updateDiscountUI();
        }

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const paymentMethod = formData.get('paymentMethod');
            const hasBillingHeads = document.querySelectorAll('.billing-head-row').length > 0;
            const allocationResult = collectBillingHeadAllocations();
            if (hasBillingHeads && allocationResult.allocations.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Select Billing Heads',
                    text: 'Please select at least one billing head with an amount.',
                    confirmButtonColor: '#667eea'
                });
                return;
            }

            if (hasBillingHeads) {
                const overPaid = Array.from(document.querySelectorAll('.billing-head-row')).find(row => {
                    const toggle = row.querySelector('.billing-head-toggle');
                    const input = row.querySelector('.billing-head-amount');
                    if (!toggle || !input || !toggle.checked) return false;
                    const due = parseFloat(input.dataset.due || '0') || 0;
                    const val = parseFloat(input.value || '0') || 0;
                    return due > 0 && (val - due) > 0.05;
                });

                if (overPaid) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Amount exceeds due',
                        text: 'Entered head-wise amount exceeds the due for that head.',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
            }
            // UI Amount field may show NET; always use hidden grossAmount for calculations.
            const grossAmount = round2(hasBillingHeads ? allocationResult.total : getGrossAmount());
            setGrossAmount(grossAmount);
            const isAdvance = formData.get('isAdvancePayment') === 'true';
            
            // Validate minimum advance amount if this is an advance payment
            if (isAdvance) {
                const amountField = document.getElementById('amount');
                const minAdvance = parseFloat(amountField.getAttribute('data-min-advance'));
                
                if (minAdvance && grossAmount < minAdvance) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Minimum Amount Required',
                        text: `Minimum advance payment required is â‚¹${minAdvance.toFixed(2)}`,
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
            }
            
            const data = {
                bookingNumber: formData.get('bookingNumber'),
                amount: grossAmount,
                paymentMethod: paymentMethod,
                paymentReference: formData.get('paymentReference'),
                notes: formData.get('notes'),
                isAdvancePayment: isAdvance
            };

            if (grossAmount <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Amount required',
                    text: 'Please enter a payment amount.',
                    confirmButtonColor: '#667eea'
                });
                return;
            }

            if (hasBillingHeads) {
                data.billingHeadAllocations = JSON.stringify(allocationResult.allocations);
            }

            // Compute discount + round-off totals and send to server
            const totals = computePaymentTotals();
            data.discountAmount = totals.discountAmount;
            if (totals.discountPercent !== null) {
                data.discountPercent = totals.discountPercent;
            }
            data.roundOffAmount = totals.roundOffAmount;
            data.isRoundOffApplied = totals.isRoundOffApplied;
            data.netAmount = totals.netPayable;

            // Add card-specific fields
            if (paymentMethod === 'Card') {
                data.cardType = formData.get('cardType');
                data.cardLastFourDigits = formData.get('cardLastFourDigits');
                data.bankId = formData.get('cardBankId');
                
                // Validate card last 4 digits
                if (!/^\d{4}$/.test(data.cardLastFourDigits)) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Card Number',
                        text: 'Please enter exactly 4 digits for card number',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
            }

            // Add cheque-specific fields
            if (paymentMethod === 'Cheque') {
                data.bankId = formData.get('chequeBankId');
                data.chequeDate = formData.get('chequeDate');
            }

            // Show confirmation dialog before recording payment
            const result = await Swal.fire({
                title: 'Confirm Payment',
                  html: `Are you sure you want to record this payment?<br><br>
                       <strong>Gross Amount:</strong> â‚¹${round2(grossAmount).toFixed(2)}<br>
                      <strong>Discount:</strong> â‚¹${totals.discountAmount.toFixed(2)}${totals.discountPercent !== null ? ` (${totals.discountPercent.toFixed(2)}%)` : ''}<br>
                      <strong>Round Off:</strong> â‚¹${totals.roundOffAmount.toFixed(2)}<br>
                      <strong>Net Payable:</strong> â‚¹${totals.netPayable.toFixed(2)}<br>
                      <strong>Method:</strong> ${paymentMethod}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, Record Payment',
                cancelButtonText: 'Cancel'
            });

            // If user clicks "Cancel", stop here
            if (!result.isConfirmed) {
                return;
            }

            // Get anti-forgery token from THIS form (page has multiple forms)
            const token = formData.get('__RequestVerificationToken');
            if (!token) {
                Swal.fire({
                    icon: 'error',
                    title: 'Payment Error',
                    text: 'Security token missing. Please refresh the page and try again.',
                    confirmButtonColor: '#667eea'
                });
                return;
            }

            // Include token in form body for ValidateAntiForgeryToken
            data.__RequestVerificationToken = token;

            try {
                const response = await fetch('@Url.Action("AddPayment", "Booking")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams(data)
                });

                const contentType = response.headers.get('content-type') || '';
                if (!response.ok)
                {
                    const errText = await response.text();
                    throw new Error(`HTTP ${response.status} ${response.statusText}: ${errText}`);
                }

                if (!contentType.includes('application/json'))
                {
                    const errText = await response.text();
                    throw new Error(`Unexpected response type: ${contentType}. ${errText}`);
                }

                const apiResult = await response.json();

                if (apiResult.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: apiResult.message,
                        confirmButtonColor: '#667eea',
                        timer: 2000,
                        timerProgressBar: true
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: apiResult.message,
                        confirmButtonColor: '#667eea'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Payment Error',
                    text: (error && error.message) ? error.message : 'An error occurred while recording payment. Please try again.',
                    confirmButtonColor: '#667eea'
                });
                console.error('Payment error:', error);
            }
        });

        // Close modal when clicking outside
        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentModal();
            }
        });

        // Validate card digits input
        document.getElementById('cardLastFourDigits').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
        });

        // Handle Add Guest Form Submission
        const addGuestForm = document.getElementById('addGuestForm');
        if (addGuestForm) {
            addGuestForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                
                // Convert FormData to object (excluding file for now)
                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (key !== 'document') {
                        // Convert empty strings to null, and parse numeric values
                        if (value === '') {
                            data[key] = null;
                        } else if (key === 'age' && value) {
                            data[key] = parseInt(value);
                        } else {
                            data[key] = value;
                        }
                    }
                }

                console.log('Form data to send:', data);

                // Handle file upload if present
                const fileInput = document.getElementById('documentUpload');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.size > 5 * 1024 * 1024) {
                        Swal.fire({
                            icon: 'error',
                            title: 'File Too Large',
                            text: 'Document size should not exceed 5MB.',
                            confirmButtonColor: '#667eea'
                        });
                        return;
                    }
                    
                    // Upload file first
                    try {
                        const uploadFormData = new FormData();
                        uploadFormData.append('file', file);
                        
                        const uploadResponse = await fetch('@Url.Action("UploadGuestDocument", "Booking")', {
                            method: 'POST',
                            body: uploadFormData
                        });
                        
                        const uploadResult = await uploadResponse.json();
                        
                        if (uploadResult.success) {
                            data.documentPath = uploadResult.path;
                            console.log('Upload succeeded. documentPath set to:', data.documentPath);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Upload Failed',
                                text: uploadResult.message || 'Failed to upload document.',
                                confirmButtonColor: '#667eea'
                            });
                            return;
                        }
                    } catch (uploadError) {
                        console.error('File upload error:', uploadError);
                        Swal.fire({
                            icon: 'error',
                            title: 'Upload Error',
                            text: 'Failed to upload document. Please try again.',
                            confirmButtonColor: '#667eea'
                        });
                        return;
                    }
                }

                console.log('Add guest payload (final):', data);

                try {
                    const response = await fetch('@Url.Action("AddGuest", "Booking")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: result.message,
                            confirmButtonColor: '#667eea',
                            timer: 2000,
                            timerProgressBar: true
                        }).then(() => {
                            location.reload();
                        });
                        window.closeAddGuestModal();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message,
                            confirmButtonColor: '#667eea'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while adding guest. Please try again.',
                        confirmButtonColor: '#667eea'
                    });
                    console.error('Add guest error:', error);
                }
            });
        }

        // Close modal when clicking outside
        const addGuestModal = document.getElementById('addGuestModal');
        if (addGuestModal) {
            addGuestModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    window.closeAddGuestModal();
                }
            });
        }

        // Show booking created confirmation
        @if (TempData["BookingCreated"] != null && TempData["BookingCreated"]?.ToString() == "true")
        {
            var bookingNum = TempData["BookingNumber"]?.ToString() ?? "";
            var bookingAmt = TempData["BookingAmount"]?.ToString() ?? "0.00";
            var showPaymentModal = TempData["ShowAdvancePaymentModal"]?.ToString() == "true";
            <text>
            Swal.fire({
                icon: 'success',
                title: 'Booking Created Successfully!',
                html: '<p>Booking <strong>@bookingNum</strong> has been confirmed.</p><p>Total Amount: <strong>â‚¹@bookingAmt</strong></p>',
                confirmButtonColor: '#667eea',
                confirmButtonText: 'Great!',
                timer: 5000,
                timerProgressBar: true
            }).then(() => {
                @if (showPaymentModal)
                {
                    <text>
                    // Open payment modal automatically for advance payment
                    showPaymentModal(true);
                    </text>
                }
            });
            </text>
        }
    });

    // Add Guest Modal Functions (Global scope for onclick)
    window.showAddGuestModal = function() {
        const modal = document.getElementById('addGuestModal');
        const form = document.getElementById('addGuestForm');
        if (modal) {
            modal.style.display = 'flex';
        }
        if (form) {
            form.reset();
        }
    };

    window.closeAddGuestModal = function() {
        const modal = document.getElementById('addGuestModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    // View Guest Modal Functions
    window.showViewGuestModal = function(bookingGuestId, masterGuestId, fullName, email, phone, guestType, relationship, age, dob, gender, identityType, identityNumber, country, state, city, address, pincode, documentPath) {
        const modal = document.getElementById('viewGuestModal');
        if (modal) {
            // Photo
            const photoSection = document.getElementById('viewPhotoSection');
            const photoImg = document.getElementById('viewGuestPhotoImg');
            if (photoSection && photoImg && masterGuestId) {
                photoSection.style.display = 'none';
                photoImg.removeAttribute('src');

                photoImg.onload = function() {
                    photoSection.style.display = 'block';
                };
                photoImg.onerror = function() {
                    photoSection.style.display = 'none';
                };

                // Cache-bust to show newly captured photo immediately
                photoImg.src = '@Url.Action("Photo", "Guest")' + '?id=' + encodeURIComponent(masterGuestId) + '&v=' + Date.now();
            } else if (photoSection && photoImg) {
                photoSection.style.display = 'none';
                photoImg.removeAttribute('src');
            }

            // Personal Information
            document.getElementById('viewFullName').textContent = fullName || '-';
            document.getElementById('viewGuestType').textContent = guestType || '-';
            document.getElementById('viewRelationship').textContent = relationship || '-';
            document.getElementById('viewAge').textContent = age ? age + ' years' : '-';
            
            // Format date of birth
            if (dob) {
                const dateObj = new Date(dob);
                const formattedDate = dateObj.toLocaleDateString('en-IN', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                document.getElementById('viewDOB').textContent = formattedDate;
            } else {
                document.getElementById('viewDOB').textContent = '-';
            }
            
            document.getElementById('viewGender').textContent = gender || '-';
            
            // Contact Information
            document.getElementById('viewEmail').textContent = email || '-';
            document.getElementById('viewPhone').textContent = phone || '-';
            
            // Identity Information
            document.getElementById('viewIdentityType').textContent = identityType || '-';
            document.getElementById('viewIdentityNumber').textContent = identityNumber || '-';
            
            // Location Information
            document.getElementById('viewAddress').textContent = address || '-';
            document.getElementById('viewCity').textContent = city || '-';
            document.getElementById('viewState').textContent = state || '-';
            document.getElementById('viewCountry').textContent = country || '-';
            document.getElementById('viewPincode').textContent = pincode || '-';

            // Document Preview
            const docSection = document.getElementById('viewDocumentSection');
            const docPreview = document.getElementById('viewDocumentPreview');
            const docBtn = document.getElementById('viewDocumentBtn');

            if (docSection && docPreview && docBtn && documentPath) {
                docSection.style.display = 'block';
                docBtn.onclick = function() {
                    window.open(documentPath, '_blank');
                };

                const lower = (documentPath || '').toLowerCase();
                const isPdf = lower.endsWith('.pdf');
                const isImage = lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.png') || lower.endsWith('.gif') || lower.endsWith('.webp');

                if (isImage) {
                    docPreview.innerHTML = `<img src="${documentPath}" alt="Guest Document" style="max-width: 100%; max-height: 320px; border-radius: 10px; object-fit: contain;" />`;
                } else if (isPdf) {
                    docPreview.innerHTML = `
                        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.5rem;padding:1rem;">
                            <i class=\"fas fa-file-pdf\" style=\"font-size: 3rem; color: #dc2626;\"></i>
                            <div style="color:#374151;font-weight:600;">PDF Document</div>
                            <div style="color:#6b7280;font-size:0.9rem;">Click â€œView Full Documentâ€ to open</div>
                        </div>`;
                } else {
                    docPreview.innerHTML = `
                        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.5rem;padding:1rem;">
                            <i class=\"fas fa-file-alt\" style=\"font-size: 3rem; color: #6b7280;\"></i>
                            <div style="color:#374151;font-weight:600;">Document attached</div>
                            <div style="color:#6b7280;font-size:0.9rem;">Click â€œView Full Documentâ€ to open</div>
                        </div>`;
                }
            } else if (docSection && docPreview && docBtn) {
                docSection.style.display = 'none';
                docPreview.innerHTML = '';
                docBtn.onclick = null;
            }
            
            modal.style.display = 'flex';
        }
    };

    window.closeViewGuestModal = function() {
        const modal = document.getElementById('viewGuestModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    // Edit Guest Modal Functions
    window.showEditGuestModal = function(guestId, fullName, email, phone, guestType, relationship, age, dob, gender, identityType, identityNumber, countryId, countryName, stateId, stateName, cityId, cityName, address, pincode) {
        const modal = document.getElementById('editGuestModal');
        if (modal) {
            // Load countries for edit modal
            loadEditGuestCountries();
            
            document.getElementById('editGuestId').value = guestId;
            document.getElementById('editGuestFullName').value = fullName || '';
            document.getElementById('editGuestEmail').value = email || '';
            document.getElementById('editGuestPhone').value = phone || '';
            document.getElementById('editGuestType').value = guestType || '';
            document.getElementById('editRelationshipToPrimary').value = relationship || '';
            document.getElementById('editAge').value = age || '';
            document.getElementById('editDateOfBirth').value = dob || '';
            document.getElementById('editGuestGender').value = gender || '';
            document.getElementById('editIdentityType').value = identityType || '';
            document.getElementById('editIdentityNumber').value = identityNumber || '';
            
            // Populate location fields
            document.getElementById('editGuestAddress').value = address || '';
            document.getElementById('editGuestPincode').value = pincode || '';
            
            // If location data exists, populate the autocomplete fields
            if (countryId && countryName) {
                document.getElementById('editGuestCountry').value = countryName;
                document.getElementById('editGuestCountryId').value = countryId;
                
                // Load and populate states
                if (stateId && stateName) {
                    $.get('@Url.Action("GetStates", "Booking")', { countryId: countryId }, function(response) {
                        if (response.success && response.states) {
                            editGuestStates = response.states;
                            $('#editGuestState').prop('disabled', false).attr('placeholder', 'Type to search state...');
                            $('#editGuestState').val(stateName);
                            $('#editGuestStateId').val(stateId);
                            
                            // Load and populate cities
                            if (cityId && cityName) {
                                $.get('@Url.Action("GetCities", "Booking")', { stateId: stateId }, function(cityResponse) {
                                    if (cityResponse.success && cityResponse.cities) {
                                        editGuestCities = cityResponse.cities;
                                        $('#editGuestCity').prop('disabled', false).attr('placeholder', 'Type to search city...');
                                        $('#editGuestCity').val(cityName);
                                        $('#editGuestCityId').val(cityId);
                                    }
                                });
                            }
                        }
                    });
                }
            } else {
                // Clear location fields
                $('#editGuestCountry').val('');
                $('#editGuestCountryId').val('');
                $('#editGuestState').val('').prop('disabled', true).attr('placeholder', 'Select country first...');
                $('#editGuestStateId').val('');
                $('#editGuestCity').val('').prop('disabled', true).attr('placeholder', 'Select state first...');
                $('#editGuestCityId').val('');
            }
            
            modal.style.display = 'flex';
        }
    };

    window.closeEditGuestModal = function() {
        const modal = document.getElementById('editGuestModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    // Delete Guest Function
    window.deleteGuest = async function(guestId, guestName) {
        const result = await Swal.fire({
            title: 'Remove Guest?',
            text: `Are you sure you want to remove ${guestName} from this booking?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, remove',
            cancelButtonText: 'Cancel'
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch('@Url.Action("DeleteGuest", "Booking")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ guestId: guestId })
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Removed!',
                        text: data.message,
                        confirmButtonColor: '#667eea',
                        timer: 2000,
                        timerProgressBar: true
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#667eea'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while removing the guest.',
                    confirmButtonColor: '#667eea'
                });
                console.error('Delete guest error:', error);
            }
        }
    };

    // Auto-calculate age from date of birth (Add Guest)
    const dobInput = document.getElementById('dateOfBirth');
    const ageInput = document.getElementById('age');
    if (dobInput && ageInput) {
        dobInput.addEventListener('change', function() {
            if (this.value) {
                const dob = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                ageInput.value = age >= 0 ? age : '';
            }
        });
    }

    // Auto-calculate age from date of birth (Edit Guest)
    const editDobInput = document.getElementById('editDateOfBirth');
    const editAgeInput = document.getElementById('editAge');
    if (editDobInput && editAgeInput) {
        editDobInput.addEventListener('change', function() {
            if (this.value) {
                const dob = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                editAgeInput.value = age >= 0 ? age : '';
            }
        });
    }

    // Handle Edit Guest Form Submission
    const editGuestForm = document.getElementById('editGuestForm');
    if (editGuestForm) {
        editGuestForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            
            // Convert FormData to object (excluding file for now)
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (key !== 'document') {
                    if (value === '') {
                        data[key] = null;
                    } else if (key === 'age' && value) {
                        data[key] = parseInt(value);
                    } else if (key === 'guestId') {
                        data[key] = parseInt(value);
                    } else {
                        data[key] = value;
                    }
                }
            }

            // Handle file upload if present
            const fileInput = document.getElementById('editDocumentUpload');
            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'Document size should not exceed 5MB.',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
                
                // Upload file first
                try {
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', file);
                    
                    const uploadResponse = await fetch('@Url.Action("UploadGuestDocument", "Booking")', {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.success) {
                        data.documentPath = uploadResult.path;
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Upload Failed',
                            text: uploadResult.message || 'Failed to upload document.',
                            confirmButtonColor: '#667eea'
                        });
                        return;
                    }
                } catch (uploadError) {
                    console.error('File upload error:', uploadError);
                    Swal.fire({
                        icon: 'error',
                        title: 'Upload Error',
                        text: 'Failed to upload document. Please try again.',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
            }

            console.log('Edit guest data to send:', data);

            try {
                const response = await fetch('@Url.Action("UpdateGuest", "Booking")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#667eea',
                        timer: 2000,
                        timerProgressBar: true
                    }).then(() => {
                        location.reload();
                    });
                    window.closeEditGuestModal();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#667eea'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while updating guest. Please try again.',
                    confirmButtonColor: '#667eea'
                });
                console.error('Edit guest error:', error);
            }
        });
    }

    // Close modals on clicking outside
    const editGuestModal = document.getElementById('editGuestModal');
    if (editGuestModal) {
        editGuestModal.addEventListener('click', function(e) {
            if (e.target === editGuestModal) {
                window.closeEditGuestModal();
            }
        });
    }

    // ===== Location Autocomplete for Add Guest Modal =====
    let addGuestCountries = [];
    let addGuestStates = [];
    let addGuestCities = [];

    // Load countries when page loads
    $.get('@Url.Action("GetCountries", "Booking")', function(response) {
        if (response.success && response.countries) {
            addGuestCountries = response.countries;
        }
    });

    // Setup autocomplete for Add Guest Country
    setupGuestAutocomplete('addGuestCountry', 'addGuestCountryResults', 'addGuestCountryId', 
        () => addGuestCountries, 
        function(item) {
            $('#addGuestState').val('').prop('disabled', false).attr('placeholder', 'Type to search state...');
            $('#addGuestStateId').val('');
            $('#addGuestCity').val('').prop('disabled', true).attr('placeholder', 'Select state first...');
            $('#addGuestCityId').val('');
            addGuestStates = [];
            addGuestCities = [];
            
            // Load states for selected country
            $.get('@Url.Action("GetStates", "Booking")', { countryId: item.id }, function(response) {
                if (response.success && response.states) {
                    addGuestStates = response.states;
                }
            });
        }
    );

    // Setup autocomplete for Add Guest State
    setupGuestAutocomplete('addGuestState', 'addGuestStateResults', 'addGuestStateId', 
        () => addGuestStates,
        function(item) {
            $('#addGuestCity').val('').prop('disabled', false).attr('placeholder', 'Type to search city...');
            $('#addGuestCityId').val('');
            addGuestCities = [];
            
            // Load cities for selected state
            $.get('@Url.Action("GetCities", "Booking")', { stateId: item.id }, function(response) {
                if (response.success && response.cities) {
                    addGuestCities = response.cities;
                }
            });
        }
    );

    // Setup autocomplete for Add Guest City
    setupGuestAutocomplete('addGuestCity', 'addGuestCityResults', 'addGuestCityId', 
        () => addGuestCities,
        null
    );

    // ===== Location Autocomplete for Edit Guest Modal =====
    let editGuestCountries = [];
    let editGuestStates = [];
    let editGuestCities = [];

    // Load countries for edit modal (will be loaded when edit modal opens)
    function loadEditGuestCountries() {
        $.get('@Url.Action("GetCountries", "Booking")', function(response) {
            if (response.success && response.countries) {
                editGuestCountries = response.countries;
            }
        });
    }

    // Setup autocomplete for Edit Guest Country
    setupGuestAutocomplete('editGuestCountry', 'editGuestCountryResults', 'editGuestCountryId', 
        () => editGuestCountries, 
        function(item) {
            $('#editGuestState').val('').prop('disabled', false).attr('placeholder', 'Type to search state...');
            $('#editGuestStateId').val('');
            $('#editGuestCity').val('').prop('disabled', true).attr('placeholder', 'Select state first...');
            $('#editGuestCityId').val('');
            editGuestStates = [];
            editGuestCities = [];
            
            // Load states for selected country
            $.get('@Url.Action("GetStates", "Booking")', { countryId: item.id }, function(response) {
                if (response.success && response.states) {
                    editGuestStates = response.states;
                }
            });
        }
    );

    // Setup autocomplete for Edit Guest State
    setupGuestAutocomplete('editGuestState', 'editGuestStateResults', 'editGuestStateId', 
        () => editGuestStates,
        function(item) {
            $('#editGuestCity').val('').prop('disabled', false).attr('placeholder', 'Type to search city...');
            $('#editGuestCityId').val('');
            editGuestCities = [];
            
            // Load cities for selected state
            $.get('@Url.Action("GetCities", "Booking")', { stateId: item.id }, function(response) {
                if (response.success && response.cities) {
                    editGuestCities = response.cities;
                }
            });
        }
    );

    // Setup autocomplete for Edit Guest City
    setupGuestAutocomplete('editGuestCity', 'editGuestCityResults', 'editGuestCityId', 
        () => editGuestCities,
        null
    );

    // Generic autocomplete setup function for guest modals
    function setupGuestAutocomplete(inputId, resultsId, hiddenId, dataSourceFn, onSelectCallback) {
        const $input = $('#' + inputId);
        const $results = $('#' + resultsId);
        const $hidden = $('#' + hiddenId);
        let currentFocus = -1;

        $input.on('input', function() {
            const query = $(this).val().toLowerCase().trim();
            $results.empty().removeClass('show');
            currentFocus = -1;

            if (query.length === 0) {
                $hidden.val('');
                return;
            }

            const data = dataSourceFn();
            if (!data || data.length === 0) {
                return;
            }

            const filtered = data.filter(item => 
                item && item.name && item.name.toLowerCase().includes(query)
            );

            if (filtered.length > 0) {
                filtered.forEach((item, index) => {
                    const $div = $('<div class="autocomplete-item"></div>')
                        .text(item.name)
                        .data('item', item)
                        .data('index', index)
                        .on('click', function() {
                            selectGuestItem($(this), $input, $results, $hidden, onSelectCallback);
                        });
                    $results.append($div);
                });
                $results.addClass('show');
            } else {
                $results.html('<div class="autocomplete-no-results">No results found</div>').addClass('show');
            }
        });

        $input.on('keydown', function(e) {
            const $items = $results.find('.autocomplete-item');
            if ($items.length === 0) return;

            if (e.keyCode === 40) { // Down arrow
                e.preventDefault();
                currentFocus++;
                addGuestActiveItem($items, currentFocus);
            } else if (e.keyCode === 38) { // Up arrow
                e.preventDefault();
                currentFocus--;
                addGuestActiveItem($items, currentFocus);
            } else if (e.keyCode === 13) { // Enter
                e.preventDefault();
                if (currentFocus > -1 && $items.length > 0) {
                    selectGuestItem($items.eq(currentFocus), $input, $results, $hidden, onSelectCallback);
                }
            } else if (e.keyCode === 27) { // Escape
                $results.removeClass('show');
            }
        });

        $input.on('blur', function() {
            setTimeout(() => {
                $results.removeClass('show');
                currentFocus = -1;
            }, 200);
        });

        function addGuestActiveItem($items, focusIndex) {
            if (!$items.length) return;
            $items.removeClass('active');
            if (focusIndex >= $items.length) currentFocus = 0;
            if (focusIndex < 0) currentFocus = $items.length - 1;
            $items.eq(currentFocus).addClass('active');
            $items.eq(currentFocus)[0].scrollIntoView({ block: 'nearest' });
        }
    }

    function selectGuestItem($item, $input, $results, $hidden, onSelectCallback) {
        const item = $item.data('item');
        if (!item) return;
        
        $input.val(item.name);
        $hidden.val(item.id);
        $results.removeClass('show');
        
        if (onSelectCallback) {
            onSelectCallback(item);
        }
    }
</script>

@await Html.PartialAsync("_OtherChargesModal")
}
