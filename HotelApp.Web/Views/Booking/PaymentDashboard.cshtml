@{
    ViewData["Title"] = "Payment Dashboard";
    var pdRoleName     = ViewBag.SelectedRoleName as string ?? "";
    var pdBranchName   = ViewBag.CurrentBranchName as string ?? "your branch";
    var pdIsAdmin      = pdRoleName.Equals("Administrator", StringComparison.OrdinalIgnoreCase);
}

@section Styles {
    <link rel="stylesheet" href="~/css/room-dashboard.css" asp-append-version="true" />
    <style>
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            padding: 16px;
            border-radius: 14px;
        }

        .summary-card h3 {
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 1.9rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 180px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 700;
            color: #1f2937;
        }

        .filter-group .form-control {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-group .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.12);
        }

        .btn-filter-apply,
        .btn-filter-clear {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            border: none;
            white-space: nowrap;
        }

        .btn-filter-apply {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
        }

        .btn-filter-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 42, 108, 0.25);
        }

        .btn-filter-clear {
            background: #fff;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .btn-filter-clear:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #374151;
        }

        .pd-loading {
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: #1f2937;
        }

        .pd-loading .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--secondary);
            animation: pdPulse 0.9s infinite ease-in-out;
        }

        @@keyframes pdPulse {
            0% { opacity: 0.2; transform: scale(0.85); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.2; transform: scale(0.85); }
        }
    </style>
}

<div class="page-header">
    <h2><i class="fas fa-chart-line"></i> Payment Dashboard</h2>
</div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content: space-between;">
        <div>
            <div style="font-weight:900; color:#0f172a;">Payment Dashboard</div>
            <div class="subtext" style="margin-top:4px;">Today: @DateTime.Now.ToString("dd MMM yyyy")</div>
            @if (pdIsAdmin)
            {
                <div style="margin-top:6px;display:inline-flex;align-items:center;gap:6px;font-size:0.78rem;font-weight:600;padding:3px 10px;border-radius:20px;background:linear-gradient(135deg,#1e3a8a,#3b82f6);color:#fff;">
                    <i class="fas fa-shield-alt"></i> Administrator – showing all payments for @pdBranchName
                </div>
            }
            else
            {
                <div style="margin-top:6px;display:inline-flex;align-items:center;gap:6px;font-size:0.78rem;font-weight:600;padding:3px 10px;border-radius:20px;background:linear-gradient(135deg,#059669,#10b981);color:#fff;">
                    <i class="fas fa-user"></i> @pdRoleName – showing your payments for @pdBranchName
                </div>
            }
            <div class="pd-loading" id="pdLoading" style="margin-top:6px;"><span class="dot"></span> Loading…</div>
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
            <div class="filter-group">
                <label for="fromDate">From Date</label>
                <input id="fromDate" type="date" class="form-control" value="@ViewBag.FromDate" />
            </div>

            <div class="filter-group">
                <label for="toDate">To Date</label>
                <input id="toDate" type="date" class="form-control" value="@ViewBag.ToDate" />
            </div>

            <div style="display:flex; gap:10px; align-items:flex-end;">
                <button class="btn-filter-apply" type="button" id="btnApply">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <button class="btn-filter-clear" type="button" id="btnReset">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <div class="alert alert-danger" id="pdError" style="display:none; margin-top: 12px;"></div>
</div>

<div class="status-cards booking-status-cards" style="margin-bottom: 26px;">
    <div class="status-card occupied">
        <h3>Total Collection</h3>
        <div class="value" id="statTotalCollection">₹0</div>
    </div>

    <div class="status-card maintenance">
        <h3>Total GST</h3>
        <div class="value" id="statTotalGst">₹0</div>
    </div>

    <div class="status-card available">
        <h3>Total Payments</h3>
        <div class="value" id="statTotalPayments">0</div>
    </div>

    <div class="status-card cleaning">
        <h3>Total Due Amount</h3>
        <div class="value" id="statDueAmount">₹0</div>
    </div>
</div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
        <div>
            <div style="font-weight:700; color:#1f2937;">Payment Method Summary</div>
            <div class="subtext" style="margin-top:4px;">Aggregated by payment method for the selected date range.</div>
        </div>
    </div>
</div>

<div class="summary-cards" id="paymentMethodsCards"></div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
        <div>
            <div style="font-weight:700; color:#1f2937;">Billing Head Summary</div>
            <div class="subtext" style="margin-top:4px;">Billing head-wise payment totals for the selected date range.</div>
        </div>
    </div>
</div>

<div class="summary-cards" id="billingHeadsCards"></div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
        <div>
            <div style="font-weight:700; color:#1f2937;">Payment History</div>
            <div class="subtext" style="margin-top:4px;"><span id="paymentCountText">0 records</span></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-filter-apply" type="button" title="Export CSV" id="btnExportCsv"><i class="fas fa-file-export"></i> CSV</button>
            <button class="btn-filter-apply" type="button" title="Export Excel" id="btnExportExcel"><i class="fas fa-file-export"></i> Excel</button>
            <button class="btn-filter-apply" type="button" title="Export PDF" id="btnExportPdf"><i class="fas fa-file-export"></i> PDF</button>
        </div>
    </div>
</div>

<div class="table-container" style="overflow: visible;">
    <table class="data-table" id="paymentsTable">
        <thead>
            <tr>
                <th>Paid On</th>
                <th>Receipt No</th>
                <th>Booking No</th>
                <th>Method</th>
                <th>Billing Head</th>
                <th class="text-end">Amount</th>
                <th class="text-end">GST</th>
                <th>Created By</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let lastPayments = [];

        const summaryVariants = ['available', 'occupied', 'maintenance', 'cleaning'];

        const formatCurrency = (v) => {
            const n = Number(v || 0);
            return n.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
        };

        const formatDateTime = (v) => {
            if (!v) return '-';
            const d = new Date(v);
            if (Number.isNaN(d.getTime())) return '-';
            return d.toLocaleString('en-IN', {
                year: 'numeric', month: 'short', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        };

        const getExportRows = () => {
            const items = lastPayments || [];
            return items.map(p => {
                const createdBy = (p.createdBy || p.createdByName || p.userName || '').toString().trim();
                return {
                    paidOn: formatDateTime(p.paidOn),
                    receiptNo: p.receiptNo || '',
                    bookingNo: p.bookingNo || '',
                    paymentMethod: (p.paymentMethod || '').toString(),
                    billingHead: (p.billingHead || '').toString(),
                    receiptAmount: Number(p.receiptAmount || 0),
                    gstAmount: Number(p.gstAmount || 0),
                    createdBy: createdBy || ''
                };
            });
        };

        const downloadBlob = (blob, filename) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        };

        const exportCsv = () => {
            const rows = getExportRows();
            const header = ['Paid On', 'Receipt No', 'Booking No', 'Method', 'Billing Head', 'Amount', 'GST', 'Created By'];
            const escape = (v) => {
                const s = String(v ?? '');
                if (/[\n\r,\"]/g.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };

            const lines = [header.map(escape).join(',')];
            rows.forEach(r => {
                lines.push([
                    r.paidOn,
                    r.receiptNo,
                    r.bookingNo,
                    r.paymentMethod,
                    r.billingHead,
                    r.receiptAmount.toFixed(2),
                    r.gstAmount.toFixed(2),
                    r.createdBy
                ].map(escape).join(','));
            });

            const csv = '\uFEFF' + lines.join('\n');
            downloadBlob(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), `PaymentHistory_${document.getElementById('fromDate').value}_${document.getElementById('toDate').value}.csv`);
        };

        const exportExcel = () => {
            // Simple Excel-compatible export by using an HTML table and .xls extension.
            const rows = getExportRows();
            const escHtml = (s) => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            let html = '<table border="1">';
            html += '<tr><th>Paid On</th><th>Receipt No</th><th>Booking No</th><th>Method</th><th>Billing Head</th><th>Amount</th><th>GST</th><th>Created By</th></tr>';
            rows.forEach(r => {
                html += `<tr><td>${escHtml(r.paidOn)}</td><td>${escHtml(r.receiptNo)}</td><td>${escHtml(r.bookingNo)}</td><td>${escHtml(r.paymentMethod)}</td><td>${escHtml(r.billingHead)}</td><td>${r.receiptAmount.toFixed(2)}</td><td>${r.gstAmount.toFixed(2)}</td><td>${escHtml(r.createdBy)}</td></tr>`;
            });
            html += '</table>';
            const content = `<!doctype html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
            downloadBlob(new Blob([content], { type: 'application/vnd.ms-excel;charset=utf-8;' }), `PaymentHistory_${document.getElementById('fromDate').value}_${document.getElementById('toDate').value}.xls`);
        };

        const exportPdf = async () => {
            const rows = getExportRows();
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('PDF export library failed to load. Please refresh and try again.');
                return;
            }

            // autoTable may attach to jsPDF.API OR to doc.autoTable depending on build.
            const jsPDF = window.jspdf.jsPDF;

            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            doc.setFontSize(14);
            doc.text(`Payment History (${from} to ${to})`, 40, 40);

            const autoTableFn = doc.autoTable || (jsPDF.API && jsPDF.API.autoTable);
            if (!autoTableFn) {
                alert('PDF table plugin failed to load. Please refresh and try again.');
                return;
            }

            (doc.autoTable || autoTableFn).call(doc, {
                startY: 60,
                head: [['Paid On', 'Receipt No', 'Booking No', 'Method', 'Billing Head', 'Amount', 'GST', 'Created By']],
                body: rows.map(r => [
                    r.paidOn,
                    r.receiptNo,
                    r.bookingNo,
                    r.paymentMethod,
                    r.billingHead,
                    r.receiptAmount.toFixed(2),
                    r.gstAmount.toFixed(2),
                    r.createdBy
                ]),
                styles: { fontSize: 10 },
                headStyles: { fillColor: [26, 42, 108] }
            });

            doc.save(`PaymentHistory_${from}_${to}.pdf`);
        };

        const setLoading = (isLoading) => {
            const el = document.getElementById('pdLoading');
            if (el) el.style.display = isLoading ? 'flex' : 'none';
            document.getElementById('btnApply').disabled = isLoading;
            document.getElementById('btnReset').disabled = isLoading;
        };

        const showError = (message) => {
            const el = document.getElementById('pdError');
            if (!el) return;
            if (!message) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = message;
        };

        const renderPaymentMethods = (methods) => {
            const container = document.getElementById('paymentMethodsCards');
            if (!container) return;
            container.innerHTML = '';

            const items = methods || [];
            if (items.length === 0) {
                container.innerHTML = '<div class="table-container" style="padding:14px; color:#6b7280; text-align:center;">No data</div>';
                return;
            }

            items.forEach((m, idx) => {
                const card = document.createElement('div');
                const variant = summaryVariants[idx % summaryVariants.length];
                const name = (m.paymentMethod || 'Unknown').toString();
                const tx = Number(m.transactionCount || 0);
                card.className = `status-card ${variant} summary-card`;
                card.innerHTML = `
                    <h3>${name}</h3>
                    <div class="value">${formatCurrency(m.totalAmount)}</div>
                    <div class="change">Transactions: ${tx}</div>
                `;
                container.appendChild(card);
            });
        };

        const renderBillingHeads = (heads) => {
            const container = document.getElementById('billingHeadsCards');
            if (!container) return;
            container.innerHTML = '';

            const items = heads || [];
            if (items.length === 0) {
                container.innerHTML = '<div class="table-container" style="padding:14px; color:#6b7280; text-align:center;">No data</div>';
                return;
            }

            items.forEach((h, idx) => {
                const card = document.createElement('div');
                const variant = summaryVariants[idx % summaryVariants.length];
                const name = (h.billingHead || '').toString().trim() || '-';
                const tx = Number(h.transactionCount || 0);
                card.className = `status-card ${variant} summary-card`;
                card.innerHTML = `
                    <h3>${name}</h3>
                    <div class="value">${formatCurrency(h.totalAmount)}</div>
                    <div class="change">Transactions: ${tx} • GST: ${formatCurrency(h.totalGst)}</div>
                `;
                container.appendChild(card);
            });
        };

        const renderPayments = (payments) => {
            const tbody = document.querySelector('#paymentsTable tbody');
            const countText = document.getElementById('paymentCountText');
            tbody.innerHTML = '';
            const items = payments || [];
            lastPayments = items;
            if (countText) countText.textContent = `${items.length} records`;

            items.forEach(p => {
                const createdBy = (p.createdBy || p.createdByName || p.userName || '').toString().trim();
                const head = (p.billingHead || '').toString().trim();
                const method = (p.paymentMethod || '').toString().trim();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDateTime(p.paidOn)}</td>
                    <td><strong>${p.receiptNo || '-'}</strong></td>
                    <td>${p.bookingNo || '-'}</td>
                    <td>${method || '-'}</td>
                    <td>${head || '-'}</td>
                    <td class="text-end">${formatCurrency(p.receiptAmount)}</td>
                    <td class="text-end">${formatCurrency(p.gstAmount)}</td>
                    <td>${createdBy || '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            if (!items || items.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" style="text-align:center; color:#6b7280;">No payments found for the selected range</td>';
                tbody.appendChild(tr);
            }
        };

        const loadDashboard = async () => {
            showError('');
            setLoading(true);
            try {
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                const url = '@Url.Action("GetPaymentDashboardData", "Booking")' + `?fromDate=${encodeURIComponent(fromDate)}&toDate=${encodeURIComponent(toDate)}`;

                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || `Request failed (${res.status})`);

                document.getElementById('statTotalCollection').textContent = formatCurrency(data.summary?.totalCollection);
                document.getElementById('statTotalGst').textContent = formatCurrency(data.summary?.totalGst);
                document.getElementById('statDueAmount').textContent = formatCurrency(data.summary?.totalDueAmount);
                document.getElementById('statTotalPayments').textContent = Number(data.summary?.totalPaymentCount || 0).toLocaleString('en-IN');

                renderPaymentMethods(data.paymentMethods);
                renderBillingHeads(data.billingHeads);
                renderPayments(data.payments);
            } catch (e) {
                showError(e.message || 'Failed to load dashboard');
            } finally {
                setLoading(false);
            }
        };

        document.getElementById('btnApply').addEventListener('click', () => loadDashboard());
        document.getElementById('btnReset').addEventListener('click', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const v = `${yyyy}-${mm}-${dd}`;
            document.getElementById('fromDate').value = v;
            document.getElementById('toDate').value = v;
            loadDashboard();
        });

        document.getElementById('btnExportCsv').addEventListener('click', () => exportCsv());
        document.getElementById('btnExportExcel').addEventListener('click', () => exportExcel());
        document.getElementById('btnExportPdf').addEventListener('click', () => exportPdf());

        loadDashboard();
    </script>
}

