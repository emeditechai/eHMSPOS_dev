@model HotelApp.Web.ViewModels.BookingCreateViewModel
@using HotelApp.Web.Models
@{
    ViewData["Title"] = "Create Booking";
    var roomTypes = ViewBag.RoomTypes as IEnumerable<RoomType> ?? Enumerable.Empty<RoomType>();
    var customerTypes = ViewBag.CustomerTypes as IEnumerable<string> ?? Enumerable.Empty<string>();
    var sources = ViewBag.Sources as IEnumerable<string> ?? Enumerable.Empty<string>();
    var channels = ViewBag.Channels as IEnumerable<string> ?? Enumerable.Empty<string>();
    var paymentMethods = ViewBag.PaymentMethods as IReadOnlyDictionary<string, string> ?? new Dictionary<string, string>();
}

<style>
.booking-dashboard {
    padding: 20px;
    background: #f5f7fa;
    min-height: calc(100vh - 80px);
}

.booking-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.booking-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s;
}

.booking-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.card-header i {
    font-size: 24px;
    color: #4a5568;
}

.card-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
}

.form-field {
    margin-bottom: 18px;
}

.form-field label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #4a5568;
    font-size: 14px;
}

.form-field input,
.form-field select,
.form-field textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-row-inline {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.quote-summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 25px;
    margin-top: 20px;
}

.quote-summary-card h4 {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
}

.quote-line {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.quote-line:last-child {
    border-bottom: none;
    font-size: 20px;
    font-weight: 700;
    margin-top: 10px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.btn-primary-booking {
    flex: 1;
    background: #667eea;
    color: white;
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary-booking:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary-booking {
    flex: 1;
    background: white;
    color: #4a5568;
    padding: 14px 24px;
    border: 2px solid #cbd5e0;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-secondary-booking:hover {
    border-color: #a0aec0;
    background: #f7fafc;
}

.guest-lookup-indicator {
    display: inline-block;
    margin-left: 8px;
    padding: 3px 8px;
    background: #48bb78;
    color: white;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
}

.page-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 25px;
}

.page-title h2 {
    margin: 0;
    font-size: 28px;
    color: #2d3748;
    font-weight: 700;
}
</style>

<div class="booking-dashboard">
    <div class="page-title">
        <h2><i class="fas fa-calendar-plus"></i> New Booking</h2>
        <a asp-action="List" class="btn-secondary-booking" style="flex: none; max-width: 200px;">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
    <form asp-action="Create" method="post" id="bookingForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger" style="background: #fed7d7; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>

        <div class="booking-cards-grid">
            <!-- Guest Details Card - First -->
            <div class="booking-card">
                <div class="card-header">
                    <i class="fas fa-user-circle"></i>
                    <h3>Guest Details</h3>
                    <span id="guestFoundBadge" class="guest-lookup-indicator" style="display:none;">Guest Found</span>
                </div>
                
                <div class="form-field">
                    <label asp-for="PrimaryGuestPhone">Mobile Number <span style="color: #e53e3e;">*</span></label>
                    <input asp-for="PrimaryGuestPhone" id="guestPhone" placeholder="Enter mobile number" />
                    <span asp-validation-for="PrimaryGuestPhone" class="text-danger"></span>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="PrimaryGuestFirstName">First Name <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="PrimaryGuestFirstName" id="guestFirstName" placeholder="First name" />
                        <span asp-validation-for="PrimaryGuestFirstName" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="PrimaryGuestLastName">Last Name <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="PrimaryGuestLastName" id="guestLastName" placeholder="Last name" />
                        <span asp-validation-for="PrimaryGuestLastName" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-field">
                    <label asp-for="PrimaryGuestEmail">Email Address <span style="color: #e53e3e;">*</span></label>
                    <input asp-for="PrimaryGuestEmail" type="email" id="guestEmail" placeholder="guest@example.com" />
                    <span asp-validation-for="PrimaryGuestEmail" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="LoyaltyId">Loyalty ID</label>
                    <input asp-for="LoyaltyId" id="guestLoyalty" placeholder="Optional loyalty number" />
                    <span asp-validation-for="LoyaltyId" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="SpecialRequests">Special Requests</label>
                    <textarea asp-for="SpecialRequests" rows="2" placeholder="Any special requirements..."></textarea>
                    <span asp-validation-for="SpecialRequests" class="text-danger"></span>
                </div>
            </div>

            <!-- Stay Details Card -->
            <div class="booking-card">
                <div class="card-header">
                    <i class="fas fa-bed"></i>
                    <h3>Stay Details</h3>
                </div>
                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="CheckInDate">Check-In <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="CheckInDate" type="date" />
                        <span asp-validation-for="CheckInDate" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="CheckOutDate">Check-Out <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="CheckOutDate" type="date" />
                        <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-field">
                    <label asp-for="RoomTypeId">Room Type <span style="color: #e53e3e;">*</span></label>
                    <select asp-for="RoomTypeId">
                        <option value="">-- Select Room Type --</option>
                        @foreach (var room in roomTypes)
                        {
                            <option value="@room.Id">@room.TypeName</option>
                        }
                    </select>
                    <span asp-validation-for="RoomTypeId" class="text-danger"></span>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="Adults">Adults <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="Adults" type="number" min="1" max="10" />
                        <span asp-validation-for="Adults" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="Children">Children</label>
                        <input asp-for="Children" type="number" min="0" max="10" />
                        <span asp-validation-for="Children" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="CustomerType">Customer Type <span style="color: #e53e3e;">*</span></label>
                        <select asp-for="CustomerType">
                            @foreach (var ct in customerTypes)
                            {
                                <option value="@ct">@ct</option>
                            }
                        </select>
                        <span asp-validation-for="CustomerType" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="Source">Source <span style="color: #e53e3e;">*</span></label>
                        <select asp-for="Source">
                            @foreach (var source in sources)
                            {
                                <option value="@source">@source</option>
                            }
                        </select>
                        <span asp-validation-for="Source" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-field">
                    <label asp-for="Channel">Channel <span style="color: #e53e3e;">*</span></label>
                    <select asp-for="Channel">
                        @foreach (var channel in channels)
                        {
                            <option value="@channel">@channel</option>
                        }
                    </select>
                    <span asp-validation-for="Channel" class="text-danger"></span>
                </div>
            </div>

            <!-- Payment & Quote Card -->
            <div class="booking-card">
                <div class="card-header">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment & Summary</h3>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="DepositAmount">Deposit Amount</label>
                        <input asp-for="DepositAmount" type="number" min="0" step="0.01" placeholder="0.00" />
                        <span asp-validation-for="DepositAmount" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="PaymentMethod">Payment Method <span style="color: #e53e3e;">*</span></label>
                        <select asp-for="PaymentMethod">
                            @foreach (var method in paymentMethods)
                            {
                                <option value="@method.Key">@method.Value</option>
                            }
                        </select>
                        <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                    </div>
                </div>

                <div class="quote-summary-card">
                    <h4><i class="fas fa-receipt"></i> Quote Summary</h4>
                    @if (Model.QuotedGrandTotal.HasValue)
                    {
                        <div class="quote-line">
                            <span>Room Total:</span>
                            <span>₹@Model.QuotedBaseAmount?.ToString("N2")</span>
                        </div>
                        <div class="quote-line">
                            <span>Taxes:</span>
                            <span>₹@Model.QuotedTaxAmount?.ToString("N2")</span>
                        </div>
                        <div class="quote-line">
                            <span>Grand Total:</span>
                            <span>₹@Model.QuotedGrandTotal?.ToString("N2")</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(Model.AssignedRoomNumber))
                        {
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                                <strong>Assigned Room:</strong> @Model.AssignedRoomNumber
                            </div>
                        }
                    }
                    else
                    {
                        <p style="margin: 0; opacity: 0.9;">Fill in the details and click <strong>Create Booking</strong> to generate quote.</p>
                    }
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button type="submit" class="btn-primary-booking">
                <i class="fas fa-save"></i> Create Booking
            </button>
            <a asp-action="List" class="btn-secondary-booking">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            let typingTimer;
            const doneTypingInterval = 800; // 800ms after user stops typing

            $('#guestPhone').on('input', function() {
                clearTimeout(typingTimer);
                const phone = $(this).val().trim();
                
                if (phone.length >= 10) {
                    typingTimer = setTimeout(function() {
                        lookupGuest(phone);
                    }, doneTypingInterval);
                } else {
                    $('#guestFoundBadge').hide();
                }
            });

            function lookupGuest(phone) {
                $.ajax({
                    url: '@Url.Action("LookupGuest", "Booking")',
                    type: 'GET',
                    data: { phone: phone },
                    success: function(response) {
                        if (response.found) {
                            $('#guestFirstName').val(response.firstName);
                            $('#guestLastName').val(response.lastName);
                            $('#guestEmail').val(response.email);
                            $('#guestLoyalty').val(response.loyaltyId || '');
                            $('#guestFoundBadge').fadeIn();
                            
                            // Optional: Show a friendly toast notification
                            console.log('Guest data loaded from previous records');
                        } else {
                            $('#guestFoundBadge').hide();
                        }
                    },
                    error: function() {
                        console.log('Error looking up guest');
                    }
                });
            }
        });
    </script>
}
