@model HotelApp.Web.ViewModels.BookingCreateViewModel
@using HotelApp.Web.Models
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Create Booking";
    var roomTypes = ViewBag.RoomTypes as IEnumerable<RoomType> ?? Enumerable.Empty<RoomType>();
    var customerTypes = ViewBag.CustomerTypes as IEnumerable<string> ?? Enumerable.Empty<string>();
    var sources = ViewBag.Sources as IEnumerable<string> ?? Enumerable.Empty<string>();
    var channels = ViewBag.Channels as IEnumerable<string> ?? Enumerable.Empty<string>();
}

<style>
.booking-dashboard {
    padding: 20px;
    background: #f5f7fa;
    min-height: calc(100vh - 80px);
}

.booking-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.booking-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s;
}

.booking-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.card-header i {
    font-size: 24px;
    color: #4a5568;
}

.card-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
}

.form-field {
    margin-bottom: 18px;
    position: relative;
}

.form-field label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #4a5568;
    font-size: 14px;
}

.form-field input,
.form-field select,
.form-field textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-row-inline {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.quote-summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 25px;
    margin-top: 20px;
}

.quote-summary-card h4 {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
}

.quote-line {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.quote-line:last-child {
    border-bottom: none;
    font-size: 20px;
    font-weight: 700;
    margin-top: 10px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.btn-primary-booking {
    flex: 1;
    background: #667eea;
    color: white;
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary-booking:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary-booking {
    flex: 1;
    background: white;
    color: #4a5568;
    padding: 14px 24px;
    border: 2px solid #cbd5e0;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-secondary-booking:hover {
    border-color: #a0aec0;
    background: #f7fafc;
}

.autocomplete-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s;
}

.autocomplete-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.autocomplete-input:disabled {
    background-color: #f7fafc;
    cursor: not-allowed;
    opacity: 0.6;
}

.autocomplete-results {
    position: absolute;
    width: 100%;
    max-height: 250px;
    overflow-y: auto;
    background: white;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    margin-top: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: none;
}

.autocomplete-results.active {
    display: block;
}

.autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
}

.autocomplete-item:hover,
.autocomplete-item.selected {
    background: #edf2f7;
    color: #667eea;
    font-weight: 500;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-no-results {
    padding: 10px 12px;
    color: #718096;
    font-style: italic;
    text-align: center;
}

.guest-lookup-indicator {
    display: inline-block;
    margin-left: 8px;
    padding: 3px 8px;
    background: #48bb78;
    color: white;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
}

.page-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 25px;
}

.page-title h2 {
    margin: 0;
    font-size: 28px;
    color: #2d3748;
    font-weight: 700;
}
</style>

<div class="booking-dashboard">
    <div class="page-title">
        <h2><i class="fas fa-calendar-plus"></i> New Booking</h2>
        <a asp-action="List" class="btn-secondary-booking" style="flex: none; max-width: 200px;">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
    <form asp-action="Create" method="post" id="bookingForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger" style="background: #fed7d7; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>

        <div class="booking-cards-grid">
            <!-- Guest Details Card - First -->
            <div class="booking-card">
                <div class="card-header">
                    <i class="fas fa-user-circle"></i>
                    <h3>Guest Details</h3>
                    <span id="guestFoundBadge" class="guest-lookup-indicator" style="display:none;">
                        <i class="fas fa-check-circle"></i> Returning Guest
                    </span>
                </div>
                
                <div class="form-field">
                    <label asp-for="PrimaryGuestPhone">Mobile Number <span style="color: #e53e3e;">*</span></label>
                    <input asp-for="PrimaryGuestPhone" id="guestPhone" placeholder="Enter mobile number" />
                    <span asp-validation-for="PrimaryGuestPhone" class="text-danger"></span>
                    <div id="phoneLoader" style="display:none; margin-top: 5px; color: #667eea; font-size: 13px;">
                        <i class="fas fa-spinner fa-spin"></i> Looking up guest...
                    </div>
                </div>

                <div id="lastBookingInfo" style="display:none; background: #e6f3ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                    <div style="font-size: 13px; color: #2d3748;">
                        <strong><i class="fas fa-info-circle"></i> Last Booking:</strong><br>
                        <span id="lastBookingDetails" style="margin-left: 20px;"></span>
                    </div>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="PrimaryGuestFirstName">First Name <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="PrimaryGuestFirstName" id="guestFirstName" placeholder="First name" />
                        <span asp-validation-for="PrimaryGuestFirstName" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="PrimaryGuestLastName">Last Name <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="PrimaryGuestLastName" id="guestLastName" placeholder="Last name" />
                        <span asp-validation-for="PrimaryGuestLastName" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label>Gender</label>
                        <select class="form-control" name="Gender" id="guestGender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-field">
                    <label asp-for="PrimaryGuestEmail">Email Address <span style="color: #e53e3e;">*</span></label>
                    <input asp-for="PrimaryGuestEmail" type="email" id="guestEmail" placeholder="guest@example.com" />
                    <span asp-validation-for="PrimaryGuestEmail" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="LoyaltyId">Loyalty ID</label>
                    <input asp-for="LoyaltyId" id="guestLoyalty" placeholder="Optional loyalty number" />
                    <span asp-validation-for="LoyaltyId" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="SpecialRequests">Special Requests</label>
                    <textarea asp-for="SpecialRequests" rows="2" placeholder="Any special requirements..."></textarea>
                    <span asp-validation-for="SpecialRequests" class="text-danger"></span>
                </div>
            </div>

            <!-- Stay Details Card -->
            <div class="booking-card">
                <div class="card-header">
                    <i class="fas fa-bed"></i>
                    <h3>Stay Details</h3>
                </div>
                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="CheckInDate">Check-In <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="CheckInDate" type="date" />
                        <span asp-validation-for="CheckInDate" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="CheckOutDate">Check-Out <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="CheckOutDate" type="date" />
                        <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="RoomTypeId">Room Type <span style="color: #e53e3e;">*</span></label>
                        <select asp-for="RoomTypeId">
                            <option value="">-- Select Room Type --</option>
                            @foreach (var room in roomTypes)
                            {
                                <option value="@room.Id">@room.TypeName</option>
                            }
                        </select>
                        <span asp-validation-for="RoomTypeId" class="text-danger"></span>
                        <div id="roomTypeRate" style="margin-top: 8px; min-height: 24px;">
                            <span style="color: #9ca3af; font-size: 13px;">Select room type, customer type, and source to see rate</span>
                        </div>
                    </div>
                    <div class="form-field">
                        <label asp-for="RequiredRooms">Required Rooms <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="RequiredRooms" type="number" min="1" max="50" />
                        <span asp-validation-for="RequiredRooms" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="Adults">Adults <span style="color: #e53e3e;">*</span></label>
                        <input asp-for="Adults" type="number" min="1" max="10" />
                        <span asp-validation-for="Adults" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="Children">Children</label>
                        <input asp-for="Children" type="number" min="0" max="10" />
                        <span asp-validation-for="Children" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-row-inline">
                    <div class="form-field">
                        <label asp-for="CustomerType">Customer Type <span style="color: #e53e3e;">*</span></label>
                        <select asp-for="CustomerType">
                            @foreach (var ct in customerTypes)
                            {
                                <option value="@ct">@ct</option>
                            }
                        </select>
                        <span asp-validation-for="CustomerType" class="text-danger"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="Source">Source <span style="color: #e53e3e;">*</span></label>
                        <select asp-for="Source">
                            @foreach (var source in sources)
                            {
                                <option value="@source">@source</option>
                            }
                        </select>
                        <span asp-validation-for="Source" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-field">
                    <label asp-for="Channel">Channel <span style="color: #e53e3e;">*</span></label>
                    <select asp-for="Channel">
                        @foreach (var channel in channels)
                        {
                            <option value="@channel">@channel</option>
                        }
                    </select>
                    <span asp-validation-for="Channel" class="text-danger"></span>
                </div>
            </div>

            <!-- Other Info Card -->
            <div class="booking-card">
                <div class="card-header">
                    <i class="fas fa-address-card"></i>
                    <h3>Other Info</h3>
                </div>

                <div class="form-field">
                    <label asp-for="CountryId">Country <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="countryAutocomplete" class="form-control autocomplete-input" placeholder="Start typing country name..." autocomplete="off" />
                    <input type="hidden" asp-for="CountryId" id="countryDropdown" />
                    <div id="countryResults" class="autocomplete-results"></div>
                    <span asp-validation-for="CountryId" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="StateId">State <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="stateAutocomplete" class="form-control autocomplete-input" placeholder="Select country first..." autocomplete="off" disabled />
                    <input type="hidden" asp-for="StateId" id="stateDropdown" />
                    <div id="stateResults" class="autocomplete-results"></div>
                    <span asp-validation-for="StateId" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="CityId">City <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="cityAutocomplete" class="form-control autocomplete-input" placeholder="Select state first..." autocomplete="off" disabled />
                    <input type="hidden" asp-for="CityId" id="cityDropdown" />
                    <div id="cityResults" class="autocomplete-results"></div>
                    <span asp-validation-for="CityId" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="AddressLine">Address <span style="color: #e53e3e;">*</span></label>
                    <input asp-for="AddressLine" type="text" placeholder="Enter full address" />
                    <span asp-validation-for="AddressLine" class="text-danger"></span>
                </div>

                <div class="form-field">
                    <label asp-for="Pincode">Pincode <span style="color: #e53e3e;">*</span></label>
                    <input asp-for="Pincode" type="text" placeholder="Enter pincode" maxlength="20" />
                    <span asp-validation-for="Pincode" class="text-danger"></span>
                </div>

                <div class="form-field" style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
                    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                        <input asp-for="CollectAdvancePayment" type="checkbox" style="width: auto; margin-right: 10px; transform: scale(1.3);" />
                        <span style="font-weight: 600; color: #2d3748;">Collect Advance Payment Now</span>
                    </label>
                    <small style="display: block; margin-top: 5px; margin-left: 30px; color: #718096;">
                        Check this to open payment modal after booking creation
                    </small>
                </div>

                <div class="quote-summary-card">
                    <h4><i class="fas fa-receipt"></i> Quote Summary</h4>
                    @if (Model.QuotedGrandTotal.HasValue)
                    {
                        <div class="quote-line">
                            <span>Room Total:</span>
                            <span>₹@Model.QuotedBaseAmount?.ToString("N2")</span>
                        </div>
                        <div class="quote-line">
                            <span>Taxes:</span>
                            <span>₹@Model.QuotedTaxAmount?.ToString("N2")</span>
                        </div>
                        <div class="quote-line">
                            <span>Grand Total:</span>
                            <span>₹@Model.QuotedGrandTotal?.ToString("N2")</span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(Model.AssignedRoomNumber))
                        {
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                                <strong>Assigned Room:</strong> @Model.AssignedRoomNumber
                            </div>
                        }
                    }
                    else
                    {
                        <p style="margin: 0; opacity: 0.9;">Fill in the details and click <strong>Create Booking</strong> to generate quote.</p>
                    }
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button type="submit" class="btn-primary-booking">
                <i class="fas fa-save"></i> Create Booking
            </button>
            <a asp-action="List" class="btn-secondary-booking">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            let typingTimer;
            const doneTypingInterval = 800; // 800ms after user stops typing

            // Function to fetch and display room type rate
            function updateRoomTypeRate() {
                const roomTypeId = $('#RoomTypeId').val();
                const customerType = $('#CustomerType').val();
                const source = $('#Source').val();
                const checkInDate = $('#CheckInDate').val();
                const checkOutDate = $('#CheckOutDate').val();
                
                if (!roomTypeId || !customerType || !source) {
                    $('#roomTypeRate').html('<span style="color: #9ca3af; font-size: 13px;">Select room type, customer type, and source to see rate</span>');
                    return;
                }
                
                if (!checkInDate || !checkOutDate) {
                    $('#roomTypeRate').html('<span style="color: #f59e0b; font-size: 13px;"><i class="fas fa-calendar-alt"></i> Select check-in and check-out dates</span>');
                    return;
                }
                
                $('#roomTypeRate').html('<i class="fas fa-spinner fa-spin" style="color: #667eea;"></i> Loading rate...');
                
                $.ajax({
                    url: '@Url.Action("GetRoomTypeRate", "Booking")',
                    type: 'GET',
                    data: { 
                        roomTypeId: roomTypeId,
                        customerType: customerType,
                        source: source,
                        checkInDate: checkInDate,
                        checkOutDate: checkOutDate
                    },
                    success: function(response) {
                        if (response.success) {
                            if (response.hasRate) {
                                $('#roomTypeRate').html('<span style="display: inline-block; background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;"><i class="fas fa-tag"></i> Rate: ' + response.formattedRate + '/night</span>');
                            } else {
                                $('#roomTypeRate').html('<span style="display: inline-block; background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 13px;"><i class="fas fa-exclamation-triangle"></i> ' + response.message + '</span>');
                            }
                        } else {
                            $('#roomTypeRate').html('<span style="color: #ef4444; font-size: 13px;">Error loading rate</span>');
                        }
                    },
                    error: function() {
                        $('#roomTypeRate').html('<span style="color: #ef4444; font-size: 13px;">Error loading rate</span>');
                    }
                });
            }
            
            // Bind change events to update rate
            $('#RoomTypeId, #CustomerType, #Source, #CheckInDate, #CheckOutDate').on('change', function() {
                updateRoomTypeRate();
            });
            
            // Load initial rate if values are pre-selected
            if ($('#RoomTypeId').val() && $('#CustomerType').val() && $('#Source').val() && $('#CheckInDate').val() && $('#CheckOutDate').val()) {
                updateRoomTypeRate();
            }

            $('#guestPhone').on('input', function() {
                clearTimeout(typingTimer);
                const phone = $(this).val().trim();
                
                // Hide previous results
                $('#guestFoundBadge').hide();
                $('#lastBookingInfo').hide();
                $('#phoneLoader').hide();
                
                if (phone.length >= 10) {
                    $('#phoneLoader').show();
                    typingTimer = setTimeout(function() {
                        lookupGuest(phone);
                    }, doneTypingInterval);
                } else {
                    // Clear fields if phone is incomplete
                    if (phone.length === 0) {
                        clearGuestFields();
                    }
                }
            });

            function lookupGuest(phone) {
                $.ajax({
                    url: '@Url.Action("LookupGuestByPhone", "Booking")',
                    type: 'GET',
                    data: { phone: phone },
                    success: function(response) {
                        $('#phoneLoader').hide();
                        
                        if (response.success && response.found) {
                            // Auto-fill guest details
                            $('#guestFirstName').val(response.guest.firstName);
                            $('#guestLastName').val(response.guest.lastName);
                            $('#guestEmail').val(response.guest.email);
                            $('#guestGender').val(response.guest.gender || '');
                            $('#guestLoyalty').val(response.guest.loyaltyId || '');
                            
                            // Auto-fill address details with autocomplete
                            if (response.guest.countryId) {
                                // Find and set country
                                const country = countriesData.find(c => c.id == response.guest.countryId);
                                if (country) {
                                    $('#countryAutocomplete').val(country.name);
                                    $('#countryDropdown').val(country.id);
                                    selectedCountryId = country.id;
                                    $('#stateAutocomplete').prop('disabled', false).attr('placeholder', 'Start typing state name...');
                                    
                                    // Load and set state
                                    $.ajax({
                                        url: '@Url.Action("GetStates", "Booking")',
                                        type: 'GET',
                                        data: { countryId: country.id },
                                        success: function(stateResponse) {
                                            if (stateResponse.success && stateResponse.states) {
                                                statesData = stateResponse.states;
                                                
                                                if (response.guest.stateId) {
                                                    const state = statesData.find(s => s.id == response.guest.stateId);
                                                    if (state) {
                                                        $('#stateAutocomplete').val(state.name);
                                                        $('#stateDropdown').val(state.id);
                                                        selectedStateId = state.id;
                                                        $('#cityAutocomplete').prop('disabled', false).attr('placeholder', 'Start typing city name...');
                                                        
                                                        // Load and set city
                                                        $.ajax({
                                                            url: '@Url.Action("GetCities", "Booking")',
                                                            type: 'GET',
                                                            data: { stateId: state.id },
                                                            success: function(cityResponse) {
                                                                if (cityResponse.success && cityResponse.cities) {
                                                                    citiesData = cityResponse.cities;
                                                                    
                                                                    if (response.guest.cityId) {
                                                                        const city = citiesData.find(c => c.id == response.guest.cityId);
                                                                        if (city) {
                                                                            $('#cityAutocomplete').val(city.name);
                                                                            $('#cityDropdown').val(city.id);
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        });
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                            }
                            
                            $('#AddressLine').val(response.guest.address || '');
                            $('#Pincode').val(response.guest.pincode || '');
                            
                            // Show returning guest badge
                            $('#guestFoundBadge').fadeIn();
                            
                            // Show last booking info if available
                            if (response.lastBooking) {
                                const lastBookingHtml = `
                                    Booking <strong>${response.lastBooking.bookingNumber}</strong><br>
                                    <span style="margin-left: 20px;">Check-in: ${response.lastBooking.checkInDate} | Check-out: ${response.lastBooking.checkOutDate}</span><br>
                                    <span style="margin-left: 20px; color: #718096; font-size: 12px;">Booked on: ${response.lastBooking.createdDate}</span>
                                `;
                                $('#lastBookingDetails').html(lastBookingHtml);
                                $('#lastBookingInfo').fadeIn();
                            }
                            
                            // Show SweetAlert notification
                            Swal.fire({
                                icon: 'success',
                                title: 'Welcome Back!',
                                text: 'Guest details loaded from previous records',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true
                            });
                        } else {
                            // New guest - clear fields
                            clearGuestFields(true);
                        }
                    },
                    error: function() {
                        $('#phoneLoader').hide();
                        console.log('Error looking up guest');
                    }
                });
            }

            function clearGuestFields(keepPhone = false) {
                if (!keepPhone) {
                    $('#guestPhone').val('');
                }
                $('#guestFirstName').val('');
                $('#guestLastName').val('');
                $('#guestEmail').val('');
                $('#guestGender').val('');
                $('#guestLoyalty').val('');
                $('#guestFoundBadge').hide();
                $('#lastBookingInfo').hide();
            }

            // Initialize autocomplete data
            let countriesData = @Html.Raw(Json.Serialize(ViewBag.Countries ?? Enumerable.Empty<object>()));
            let statesData = [];
            let citiesData = [];
            let selectedCountryId = null;
            let selectedStateId = null;

            // Autocomplete for Country
            setupAutocomplete('countryAutocomplete', 'countryResults', 'countryDropdown', countriesData, function(item) {
                selectedCountryId = item.id;
                $('#countryDropdown').val(item.id).trigger('change');
                $('#stateAutocomplete').prop('disabled', false).attr('placeholder', 'Start typing state name...');
                $('#cityAutocomplete').val('').prop('disabled', true).attr('placeholder', 'Select state first...');
                $('#stateDropdown').val('');
                $('#cityDropdown').val('');
                statesData = [];
                citiesData = [];
                
                // Load states for selected country
                $.ajax({
                    url: '@Url.Action("GetStates", "Booking")',
                    type: 'GET',
                    data: { countryId: item.id },
                    success: function(response) {
                        if (response.success && response.states) {
                            statesData = response.states;
                        }
                    }
                });
            });

            // Autocomplete for State
            setupAutocomplete('stateAutocomplete', 'stateResults', 'stateDropdown', statesData, function(item) {
                selectedStateId = item.id;
                $('#stateDropdown').val(item.id).trigger('change');
                $('#cityAutocomplete').prop('disabled', false).attr('placeholder', 'Start typing city name...');
                $('#cityDropdown').val('');
                citiesData = [];
                
                // Load cities for selected state
                $.ajax({
                    url: '@Url.Action("GetCities", "Booking")',
                    type: 'GET',
                    data: { stateId: item.id },
                    success: function(response) {
                        if (response.success && response.cities) {
                            citiesData = response.cities;
                        }
                    }
                });
            });

            // Autocomplete for City
            setupAutocomplete('cityAutocomplete', 'cityResults', 'cityDropdown', citiesData, function(item) {
                $('#cityDropdown').val(item.id).trigger('change');
            });

            // Generic autocomplete setup function
            function setupAutocomplete(inputId, resultsId, hiddenId, dataSource, onSelectCallback) {
                const $input = $('#' + inputId);
                const $results = $('#' + resultsId);
                const $hidden = $('#' + hiddenId);
                let currentFocus = -1;

                $input.on('input', function() {
                    const query = $(this).val().toLowerCase().trim();
                    $results.empty().removeClass('active');
                    currentFocus = -1;

                    if (query.length === 0) {
                        $hidden.val('');
                        return;
                    }

                    // Get the correct data source
                    let data = dataSource;
                    if (inputId === 'stateAutocomplete') data = statesData;
                    if (inputId === 'cityAutocomplete') data = citiesData;

                    const filtered = data.filter(item => 
                        item.name.toLowerCase().includes(query)
                    );

                    if (filtered.length > 0) {
                        filtered.forEach((item, index) => {
                            const $div = $('<div class="autocomplete-item"></div>')
                                .text(item.name)
                                .data('item', item)
                                .data('index', index)
                                .on('click', function() {
                                    selectItem($(this));
                                });
                            $results.append($div);
                        });
                        $results.addClass('active');
                    } else if (query.length > 0) {
                        $results.html('<div class="autocomplete-no-results">No results found</div>').addClass('active');
                    }
                });

                $input.on('keydown', function(e) {
                    const $items = $results.find('.autocomplete-item');
                    if (e.keyCode === 40) { // Down arrow
                        e.preventDefault();
                        currentFocus++;
                        addActive($items);
                    } else if (e.keyCode === 38) { // Up arrow
                        e.preventDefault();
                        currentFocus--;
                        addActive($items);
                    } else if (e.keyCode === 13) { // Enter
                        e.preventDefault();
                        if (currentFocus > -1 && $items.length > 0) {
                            $items.eq(currentFocus).click();
                        }
                    } else if (e.keyCode === 27) { // Escape
                        $results.removeClass('active');
                    }
                });

                function addActive($items) {
                    if (!$items.length) return;
                    removeActive($items);
                    if (currentFocus >= $items.length) currentFocus = 0;
                    if (currentFocus < 0) currentFocus = $items.length - 1;
                    $items.eq(currentFocus).addClass('selected');
                }

                function removeActive($items) {
                    $items.removeClass('selected');
                }

                function selectItem($item) {
                    const item = $item.data('item');
                    $input.val(item.name);
                    $hidden.val(item.id);
                    $results.removeClass('active');
                    if (onSelectCallback) {
                        onSelectCallback(item);
                    }
                }

                // Close results when clicking outside
                $(document).on('click', function(e) {
                    if (!$(e.target).closest('#' + inputId + ', #' + resultsId).length) {
                        $results.removeClass('active');
                    }
                });
            }
        });
    </script>
}
