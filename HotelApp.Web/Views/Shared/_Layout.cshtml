<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - eLUX Stay</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%234A148C'/><path d='M25 35h50v5H25zm0 10h50v20H25z' fill='%23fff'/><circle cx='35' cy='52' r='2' fill='%234A148C'/><circle cx='65' cy='52' r='2' fill='%234A148C'/><rect x='45' y='55' width='10' height='8' fill='%234A148C'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%234A148C'/><path d='M25 35h50v5H25zm0 10h50v20H25z' fill='%23fff'/><circle cx='35' cy='52' r='2' fill='%234A148C'/><circle cx='65' cy='52' r='2' fill='%234A148C'/><rect x='45' y='55' width='10' height='8' fill='%234A148C'/></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/master-pages.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @RenderSection("Styles", required: false)
</head>
<body>
    @{
        var controller = (string?)ViewContext.RouteData.Values["Controller"] ?? string.Empty;
        var action = (string?)ViewContext.RouteData.Values["Action"] ?? string.Empty;
        var isLoginPage = controller.Equals("Account", StringComparison.OrdinalIgnoreCase) && action.Equals("Login", StringComparison.OrdinalIgnoreCase);
        var displayName = User.FindFirst("displayName")?.Value ?? User.Identity?.Name ?? "Guest";
    }

    @if (!isLoginPage)
    {
        <nav class="top-navbar">
            <div class="navbar-container">
                <a asp-controller="Dashboard" asp-action="Index" class="navbar-brand">
                    <i class="fas fa-hotel"></i>
                    <span>eLUX Stay</span>
                </a>
                <button type="button" class="navbar-toggle" id="navbarToggle" aria-label="Toggle navigation" aria-expanded="false">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="navbar-menu">
                    @await Component.InvokeAsync("NavBarMenu")
                </div>
                <div class="navbar-user">
                    <button id="fullscreenToggle" class="fullscreen-toggle" title="Toggle Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <div class="notifications-wrapper">
                        <button id="notificationsBell" class="fullscreen-toggle notifications-bell" title="Notifications" type="button">
                            <i class="fas fa-bell"></i>
                            <span id="notificationsBadge" class="notifications-badge" style="display:none">0</span>
                        </button>
                        <div id="notificationsDropdown" class="notifications-dropdown" style="display:none">
                            <div class="notifications-header">
                                <span>Notifications</span>
                                <button id="notificationsClear" class="notifications-clear" type="button">Clear</button>
                            </div>
                            <div id="notificationsList" class="notifications-list"></div>
                        </div>
                    </div>
                    <span class="navbar-pill">
                        <i class="fas fa-building"></i> @ViewBag.CurrentBranchName
                    </span>
                    @await Component.InvokeAsync("UserProfileMenu")
                </div>
            </div>
        </nav>
    }

    <div class="@(isLoginPage ? string.Empty : "main-content-wrapper")">
        @RenderBody()
    </div>

    @if (!isLoginPage)
    {
        <footer class="app-footer">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-left">
                        <i class="fas fa-hotel"></i>
                        <span class="footer-brand">eLUX Stay</span>
                    </div>
                    <div class="footer-center">
                        <span class="footer-copyright">
                            © @DateTime.Now.Year - Sponsored & Marketed by Emeditech Plus
                        </span>
                    </div>
                    <div class="footer-right">
                        <a href="#" class="footer-link">Privacy Policy</a>
                        <span class="footer-separator">|</span>
                        <a href="#" class="footer-link">Terms of Service</a>
                        <span class="footer-version">Version 2.1.5</span>
                    </div>
                </div>
            </div>
        </footer>
    }

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    @if (!isLoginPage)
    {
        <script src="~/js/notifications.js" asp-append-version="true"></script>
    }
    
    <script>
        // Enhanced dropdown navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile navbar toggle
            const navbarToggle = document.getElementById('navbarToggle');
            const navbarMenu = document.querySelector('.navbar-menu');

            function closeNavbarMenu() {
                if (!navbarMenu || !navbarToggle) return;
                navbarMenu.classList.remove('open');
                navbarToggle.setAttribute('aria-expanded', 'false');
            }

            if (navbarToggle && navbarMenu) {
                navbarToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const isOpen = navbarMenu.classList.contains('open');
                    navbarMenu.classList.toggle('open', !isOpen);
                    navbarToggle.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
                });

                document.addEventListener('click', function(e) {
                    if (!navbarMenu.classList.contains('open')) return;
                    if (e.target.closest('.navbar-menu')) return;
                    if (e.target.closest('#navbarToggle')) return;
                    closeNavbarMenu();
                });

                window.addEventListener('resize', function() {
                    if (window.innerWidth > 992) {
                        closeNavbarMenu();
                    }
                });
            }

            const dropdownMenuItems = document.querySelectorAll('.menu-item.has-dropdown');
            let isTouchDevice = false;
            
            // Detect if this is a touch device
            window.addEventListener('touchstart', function onFirstTouch() {
                isTouchDevice = true;
                window.removeEventListener('touchstart', onFirstTouch);
            }, {passive: true});
            
            dropdownMenuItems.forEach(function(item) {
                // For touch devices or when hover doesn't work well
                item.addEventListener('click', function(e) {
                    const clickedDropdownMenu = e.target.closest('.dropdown-menu');
                    const clickedLink = e.target.closest('a');
                    
                    // If clicking a link inside dropdown, allow navigation
                    if (clickedDropdownMenu && clickedLink) {
                        return; // Let the link work normally
                    }
                    
                    // If clicking the parent menu item itself
                    if (!clickedDropdownMenu) {
                        const isCurrentlyOpen = item.classList.contains('open');
                        
                        // Close all dropdowns
                        dropdownMenuItems.forEach(function(otherItem) {
                            otherItem.classList.remove('open');
                        });
                        
                        // Toggle this one
                        if (!isCurrentlyOpen) {
                            item.classList.add('open');
                        }
                        
                        // Only prevent default if we're toggling, not if hovering
                        if (isTouchDevice || window.innerWidth < 768) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.menu-item.has-dropdown')) {
                    dropdownMenuItems.forEach(function(item) {
                        item.classList.remove('open');
                    });
                }
            });
            
            // On desktop, ensure hover works properly
            if (window.innerWidth >= 768) {
                dropdownMenuItems.forEach(function(item) {
                    item.addEventListener('mouseenter', function() {
                        if (!isTouchDevice) {
                            dropdownMenuItems.forEach(function(otherItem) {
                                otherItem.classList.remove('open');
                            });
                        }
                    });
                });
            }
        });

        // Fullscreen Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fullscreenToggle = document.getElementById('fullscreenToggle');
            
            if (fullscreenToggle) {
                fullscreenToggle.addEventListener('click', function() {
                    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                        // Enter fullscreen
                        const elem = document.documentElement;
                        if (elem.requestFullscreen) {
                            elem.requestFullscreen();
                        } else if (elem.webkitRequestFullscreen) { /* Safari */
                            elem.webkitRequestFullscreen();
                        } else if (elem.mozRequestFullScreen) { /* Firefox */
                            elem.mozRequestFullScreen();
                        } else if (elem.msRequestFullscreen) { /* IE/Edge */
                            elem.msRequestFullscreen();
                        }
                    } else {
                        // Exit fullscreen
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) { /* Safari */
                            document.webkitExitFullscreen();
                        } else if (document.mozCancelFullScreen) { /* Firefox */
                            document.mozCancelFullScreen();
                        } else if (document.msExitFullscreen) { /* IE/Edge */
                            document.msExitFullscreen();
                        }
                    }
                });

                // Update icon when fullscreen state changes
                document.addEventListener('fullscreenchange', updateFullscreenIcon);
                document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
                document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
                document.addEventListener('MSFullscreenChange', updateFullscreenIcon);

                function updateFullscreenIcon() {
                    const icon = fullscreenToggle.querySelector('i');
                    if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                        icon.classList.remove('fa-expand');
                        icon.classList.add('fa-compress');
                        fullscreenToggle.title = 'Exit Fullscreen (ESC)';
                    } else {
                        icon.classList.remove('fa-compress');
                        icon.classList.add('fa-expand');
                        fullscreenToggle.title = 'Enter Fullscreen';
                    }
                }
                
                // Handle ESC key to exit fullscreen
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' || e.key === 'Esc' || e.keyCode === 27) {
                        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                            if (document.exitFullscreen) {
                                document.exitFullscreen();
                            } else if (document.webkitExitFullscreen) {
                                document.webkitExitFullscreen();
                            } else if (document.mozCancelFullScreen) {
                                document.mozCancelFullScreen();
                            } else if (document.msExitFullscreen) {
                                document.msExitFullscreen();
                            }
                        }
                    }
                });
            }
        });
    </script>

    <script>
        // Profile menu dropdown
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('profileMenuBtn');
            const dd = document.getElementById('profileMenuDropdown');
            if (!btn || !dd) return;

            function close() {
                dd.style.display = 'none';
                btn.setAttribute('aria-expanded', 'false');
            }

            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const open = dd.style.display !== 'none';
                dd.style.display = open ? 'none' : 'block';
                btn.setAttribute('aria-expanded', open ? 'false' : 'true');
            });

            document.addEventListener('click', function(e) {
                if (dd.style.display === 'none') return;
                if (e.target.closest('#profileMenu')) return;
                close();
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') close();
            });
        });
    </script>
    
    @if (!isLoginPage)
    {
        <!-- ================================================================
             SESSION IDLE TIMEOUT
             After 10 minutes of no user activity, a SweetAlert is shown and
             the user is redirected to /Account/TimeoutLogout (GET) which
             clears the auth cookie and session before forwarding to Login.
             ================================================================ -->
        <script>
            (function () {
                const IDLE_MINUTES = 10;
                const IDLE_MS = IDLE_MINUTES * 60 * 1000;
                const WARNING_MS = 30 * 1000; // show alert 30 s before hard redirect
                const LOGOUT_URL = '/Account/TimeoutLogout';

                let idleTimer = null;
                let warnTimer = null;
                let swalInstance = null;
                let countdownInterval = null;

                function resetTimers() {
                    // If the warning dialog is already showing, dismiss it and restart.
                    if (swalInstance) {
                        swalInstance.close();
                        swalInstance = null;
                    }
                    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
                    clearTimeout(idleTimer);
                    clearTimeout(warnTimer);

                    // Fire warning at (IDLE_MS - WARNING_MS)
                    warnTimer = setTimeout(showWarning, IDLE_MS - WARNING_MS);
                    // Hard redirect at IDLE_MS (in case user ignores the dialog)
                    idleTimer = setTimeout(doLogout, IDLE_MS);
                }

                function showWarning() {
                    let secondsLeft = Math.ceil(WARNING_MS / 1000);

                    swalInstance = Swal.fire({
                        icon: 'warning',
                        title: 'Session About to Expire',
                        html: `You have been idle. You will be logged out in <b id="swal-countdown">${secondsLeft}</b> second(s).<br>Click <b>Stay Logged In</b> to continue.`,
                        confirmButtonText: 'Stay Logged In',
                        confirmButtonColor: '#1a2a6c',
                        showCancelButton: true,
                        cancelButtonText: 'Logout Now',
                        cancelButtonColor: '#e74c3c',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        timerProgressBar: true,
                        timer: WARNING_MS,
                        didOpen: function () {
                            countdownInterval = setInterval(function () {
                                secondsLeft--;
                                const el = document.getElementById('swal-countdown');
                                if (el) el.textContent = secondsLeft;
                                if (secondsLeft <= 0) { clearInterval(countdownInterval); countdownInterval = null; }
                            }, 1000);
                        },
                        willClose: function () {
                            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
                        }
                    }).then(function (result) {
                        swalInstance = null;
                        if (result.isConfirmed) {
                            // User wants to stay — reset timers
                            resetTimers();
                        } else {
                            // Cancelled or timer expired
                            doLogout();
                        }
                    });
                }

                function doLogout() {
                    clearTimeout(idleTimer);
                    clearTimeout(warnTimer);
                    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
                    // Redirect to the server-side TimeoutLogout action
                    window.location.href = LOGOUT_URL;
                }

                // Track any user activity
                const activityEvents = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
                activityEvents.forEach(function (evt) {
                    document.addEventListener(evt, resetTimers, { passive: true });
                });

                // Start timers on page load
                resetTimers();
            })();
        </script>
    }

    @RenderSection("Scripts", required: false)
</body>
</html>
