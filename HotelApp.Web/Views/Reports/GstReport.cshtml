@model HotelApp.Web.ViewModels.GstReportViewModel
@{
    ViewData["Title"] = "GST Report";
}

@section Styles {
    <link rel="stylesheet" href="~/css/room-dashboard.css" asp-append-version="true" />
}

<div class="page-header">
    <h2><i class="fas fa-file-invoice"></i> GST Report</h2>
</div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:flex-end; justify-content: space-between;">
        <div>
            <div style="font-weight:900; color:#0f172a;">@(string.IsNullOrWhiteSpace(Model.HotelName) ? "Hotel" : Model.HotelName)</div>
            @if (!string.IsNullOrWhiteSpace(Model.HotelAddress))
            {
                <div class="subtext" style="margin-top:4px;">@Model.HotelAddress</div>
            }
            <div class="subtext" style="margin-top:4px;">GSTIN: @(string.IsNullOrWhiteSpace(Model.GSTCode) ? "-" : Model.GSTCode)</div>
        </div>

        <form method="get" action="@Url.Action("GstReport", "Reports")" style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
            <div>
                <label for="fromDate" style="display:block; font-weight:700; color:#1f2937; margin-bottom:6px;">From Date</label>
                <input id="fromDate" name="fromDate" type="date" class="form-control" value="@Model.FromDate.ToString("yyyy-MM-dd")" />
            </div>

            <div>
                <label for="toDate" style="display:block; font-weight:700; color:#1f2937; margin-bottom:6px;">To Date</label>
                <input id="toDate" name="toDate" type="date" class="form-control" value="@Model.ToDate.ToString("yyyy-MM-dd")" />
            </div>

            <div>
                <label for="gstBillingHeadFilter" style="display:block; font-weight:700; color:#1f2937; margin-bottom:6px;">Billing Head</label>
                <div id="gstBillingHeadFilter" style="position: relative; min-width: 260px;">
                    <input id="gstBillingHeadFilterInput" type="text" class="form-control" placeholder="All" readonly style="cursor: pointer;" />
                    <div id="gstBillingHeadFilterPanel" style="display:none; position:absolute; z-index: 50; top: calc(100% + 6px); left: 0; width: 100%; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px;">
                        <input id="gstBillingHeadFilterSearch" type="text" class="form-control" placeholder="search" style="margin-bottom: 10px;" />
                        <div style="display:flex; align-items:center; gap:10px; padding: 6px 2px;">
                            <input id="gstBillingHeadFilterAll" type="checkbox" checked />
                            <label for="gstBillingHeadFilterAll" style="margin:0; cursor:pointer;">All</label>
                        </div>
                        <div id="gstBillingHeadFilterOptions" style="max-height: 220px; overflow:auto; padding-right: 4px;"></div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; align-items:flex-end;">
                <button class="btn-filter-apply" type="submit">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <a class="btn-filter-clear" href="@Url.Action("GstReport", "Reports")">
                    <i class="fas fa-undo"></i> Reset
                </a>
            </div>
        </form>
    </div>
</div>

<div class="status-cards booking-status-cards" style="margin-bottom: 26px;">
    <div class="status-card available">
        <h3>Total Bookings</h3>
        <div class="value">@Model.Summary.TotalBookings</div>
    </div>

    <div class="status-card occupied">
        <h3>Taxable Value</h3>
        <div class="value">₹@Model.Summary.TotalTaxableValue.ToString("N0")</div>
    </div>

    <div class="status-card maintenance">
        <h3>Total GST</h3>
        <div class="value">₹@Model.Summary.TotalGST.ToString("N0")</div>
    </div>

    <div class="status-card cleaning">
        <h3>Paid Amount</h3>
        <div class="value">₹@Model.Summary.TotalPaidAmount.ToString("N0")</div>
    </div>
</div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
        <div>
            <div style="font-weight:700; color:#1f2937;">GST Register</div>
            <div class="subtext" style="margin-top:4px;">@Model.Rows.Count records • CGST: ₹@Model.Summary.TotalCGST.ToString("N0") • SGST: ₹@Model.Summary.TotalSGST.ToString("N0")</div>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn-filter-apply" type="button" title="Export CSV" onclick="exportGstToCsv()">
                <i class="fas fa-file-export"></i> CSV
            </button>
            <button class="btn-filter-apply" type="button" title="Export Excel" onclick="exportGstToExcel()">
                <i class="fas fa-file-export"></i> Excel
            </button>
            <button class="btn-filter-apply" type="button" title="Export PDF" onclick="exportGstToPdf()">
                <i class="fas fa-file-export"></i> PDF
            </button>
        </div>
    </div>
</div>

<div class="table-container" style="overflow: visible;">
    <table class="data-table" id="gstReportTable">
        <thead>
            <tr>
                <th>Payment Date</th>
                <th>Booking No</th>
                <th>Guest</th>
                <th>Room Type</th>
                <th>Billing Head</th>
                <th class="text-end">Taxable Value</th>
                <th class="text-end">CGST</th>
                <th class="text-end">SGST</th>
                <th class="text-end">GST</th>
                <th class="text-end">Paid Amount</th>
                <th>Booking Status</th>
                <th>Payment Status</th>
                <th>Created By</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var row in Model.Rows)
        {
            <tr>
                <td>@row.PaidOn.ToString("dd MMM yyyy")</td>
                <td>@(string.IsNullOrWhiteSpace(row.BookingNumber) ? "-" : row.BookingNumber)</td>
                <td>@(string.IsNullOrWhiteSpace(row.GuestName) ? "-" : row.GuestName)</td>
                <td>@(string.IsNullOrWhiteSpace(row.RoomType) ? "-" : row.RoomType)</td>
                <td>@(string.IsNullOrWhiteSpace(row.BillingHead) ? "-" : row.BillingHead)</td>
                <td class="text-end">₹@row.TaxableValue.ToString("N2")</td>
                <td class="text-end">₹@row.CGSTAmount.ToString("N2")</td>
                <td class="text-end">₹@row.SGSTAmount.ToString("N2")</td>
                <td class="text-end">₹@row.GSTAmount.ToString("N2")</td>
                <td class="text-end">₹@row.PaidAmount.ToString("N2")</td>
                <td>@(string.IsNullOrWhiteSpace(row.Status) ? "-" : row.Status)</td>
                <td>@(string.IsNullOrWhiteSpace(row.PaymentStatus) ? "-" : row.PaymentStatus)</td>
                <td>@(string.IsNullOrWhiteSpace(row.CreatedBy) ? "-" : row.CreatedBy)</td>
            </tr>
        }
        </tbody>
    </table>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const getGstExportRows = () => {
            const table = document.getElementById('gstReportTable');
            const bodyRows = Array.from(table.querySelectorAll('tbody tr'))
                .filter(tr => tr.style.display !== 'none');
            return bodyRows.map(tr => {
                const tds = Array.from(tr.querySelectorAll('td'));
                return {
                    paymentDate: (tds[0]?.innerText || '').trim(),
                    bookingNo: (tds[1]?.innerText || '').trim(),
                    guest: (tds[2]?.innerText || '').trim(),
                    roomType: (tds[3]?.innerText || '').trim(),
                    billingHead: (tds[4]?.innerText || '').trim(),
                    taxableValue: (tds[5]?.innerText || '').trim(),
                    cgst: (tds[6]?.innerText || '').trim(),
                    sgst: (tds[7]?.innerText || '').trim(),
                    gst: (tds[8]?.innerText || '').trim(),
                    paidAmount: (tds[9]?.innerText || '').trim(),
                    bookingStatus: (tds[10]?.innerText || '').trim(),
                    paymentStatus: (tds[11]?.innerText || '').trim(),
                    createdBy: (tds[12]?.innerText || '').trim(),
                };
            });
        };

        const normalizeGstBillingHeadText = (s) => {
            const v = String(s ?? '').trim();
            return (v === '-' ? '' : v);
        };

        const getSelectedGstBillingHeads = () => {
            const allCheckbox = document.getElementById('gstBillingHeadFilterAll');
            if (allCheckbox?.checked) return new Set();

            const container = document.getElementById('gstBillingHeadFilterOptions');
            if (!container) return new Set();

            const selected = new Set();
            Array.from(container.querySelectorAll('input[type="checkbox"][data-billinghead]')).forEach(cb => {
                if (cb.checked) selected.add(cb.getAttribute('data-billinghead'));
            });
            return selected;
        };

        const setGstBillingHeadFilterInputText = () => {
            const input = document.getElementById('gstBillingHeadFilterInput');
            if (!input) return;

            const selected = getSelectedGstBillingHeads();
            if (selected.size === 0) {
                input.value = 'All';
                return;
            }
            if (selected.size === 1) {
                input.value = Array.from(selected)[0];
                return;
            }
            input.value = `${selected.size} selected`;
        };

        const populateGstBillingHeadFilterOptions = () => {
            const optionsContainer = document.getElementById('gstBillingHeadFilterOptions');
            const allCheckbox = document.getElementById('gstBillingHeadFilterAll');
            if (!optionsContainer || !allCheckbox) return;

            const table = document.getElementById('gstReportTable');
            if (!table) return;

            const heads = new Set();
            Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
                const tds = tr.querySelectorAll('td');
                const head = normalizeGstBillingHeadText(tds[4]?.innerText || '');
                if (head) heads.add(head);
            });

            const previouslySelected = getSelectedGstBillingHeads();
            const preserveSpecific = previouslySelected.size > 0;
            if (!preserveSpecific) {
                allCheckbox.checked = true;
            }

            const options = Array.from(heads).sort((a, b) => a.localeCompare(b));
            optionsContainer.innerHTML = options.map((h, idx) => {
                const safeId = `gst_bh_opt_${idx}`;
                const checked = preserveSpecific && previouslySelected.has(h);
                const escaped = String(h).replace(/"/g, '&quot;');
                return `
                    <div class="bh-opt" data-label="${escaped}" style="display:flex; align-items:center; gap:10px; padding: 6px 2px;">
                        <input id="${safeId}" type="checkbox" data-billinghead="${escaped}" ${checked ? 'checked' : ''} />
                        <label for="${safeId}" style="margin:0; cursor:pointer;">${escaped}</label>
                    </div>
                `;
            }).join('');

            if (optionsContainer.querySelector('input[type="checkbox"][data-billinghead]:checked')) {
                allCheckbox.checked = false;
            }

            setGstBillingHeadFilterInputText();
        };

        const applyGstBillingHeadFilter = () => {
            const selectedValues = getSelectedGstBillingHeads();

            const table = document.getElementById('gstReportTable');
            if (!table) return;

            Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
                const tds = tr.querySelectorAll('td');
                const head = normalizeGstBillingHeadText(tds[4]?.innerText || '');
                tr.style.display = (selectedValues.size === 0 || selectedValues.has(head)) ? '' : 'none';
            });

            setGstBillingHeadFilterInputText();
        };

        const setGstBillingHeadPanelOpen = (open) => {
            const panel = document.getElementById('gstBillingHeadFilterPanel');
            if (!panel) return;
            panel.style.display = open ? 'block' : 'none';
            if (open) {
                const search = document.getElementById('gstBillingHeadFilterSearch');
                search?.focus();
            }
        };

        const filterGstBillingHeadOptionsBySearch = () => {
            const search = document.getElementById('gstBillingHeadFilterSearch');
            const optionsContainer = document.getElementById('gstBillingHeadFilterOptions');
            if (!search || !optionsContainer) return;

            const q = (search.value || '').trim().toLowerCase();
            Array.from(optionsContainer.querySelectorAll('.bh-opt')).forEach(el => {
                const label = (el.getAttribute('data-label') || '').toLowerCase();
                el.style.display = (!q || label.includes(q)) ? '' : 'none';
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            populateGstBillingHeadFilterOptions();
            applyGstBillingHeadFilter();

            const root = document.getElementById('gstBillingHeadFilter');
            const input = document.getElementById('gstBillingHeadFilterInput');
            const panel = document.getElementById('gstBillingHeadFilterPanel');
            const allCheckbox = document.getElementById('gstBillingHeadFilterAll');
            const optionsContainer = document.getElementById('gstBillingHeadFilterOptions');
            const search = document.getElementById('gstBillingHeadFilterSearch');

            input?.addEventListener('click', () => {
                const isOpen = panel?.style.display === 'block';
                setGstBillingHeadPanelOpen(!isOpen);
            });

            document.addEventListener('click', (e) => {
                if (!root || !panel) return;
                if (panel.style.display !== 'block') return;
                if (root.contains(e.target)) return;
                setGstBillingHeadPanelOpen(false);
            });

            allCheckbox?.addEventListener('change', () => {
                if (!optionsContainer || !allCheckbox) return;
                if (allCheckbox.checked) {
                    Array.from(optionsContainer.querySelectorAll('input[type="checkbox"][data-billinghead]')).forEach(cb => {
                        cb.checked = false;
                    });
                }
                applyGstBillingHeadFilter();
            });

            optionsContainer?.addEventListener('change', (e) => {
                const target = e.target;
                if (!(target instanceof HTMLInputElement)) return;
                if (target.type !== 'checkbox') return;
                if (allCheckbox) allCheckbox.checked = false;
                applyGstBillingHeadFilter();
            });

            search?.addEventListener('input', filterGstBillingHeadOptionsBySearch);
        });

        const downloadBlob = (blob, filename) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        };

        const exportGstToCsv = () => {
            const rows = getGstExportRows();
            const header = [
                'Payment Date','Booking No','Guest','Room Type','Billing Head','Taxable Value','CGST','SGST','GST','Paid Amount','Booking Status','Payment Status','Created By'
            ];

            const escape = (v) => {
                const s = String(v ?? '');
                if (/[\n\r,\"]/g.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };

            const lines = [header.map(escape).join(',')];
            rows.forEach(r => {
                lines.push([
                    r.paymentDate, r.bookingNo, r.guest, r.roomType, r.billingHead, r.taxableValue, r.cgst, r.sgst, r.gst,
                    r.paidAmount, r.bookingStatus, r.paymentStatus, r.createdBy
                ].map(escape).join(','));
            });

            const from = document.getElementById('fromDate')?.value || '';
            const to = document.getElementById('toDate')?.value || '';
            const csv = '\uFEFF' + lines.join('\n');
            downloadBlob(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), `GSTReport_${from}_${to}.csv`);
        };

        const exportGstToExcel = () => {
            const rows = getGstExportRows();
            const escHtml = (s) => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            let html = '<table border="1">';
            html += '<tr>' + [
                'Payment Date','Booking No','Guest','Room Type','Billing Head','Taxable Value','CGST','SGST','GST','Paid Amount','Booking Status','Payment Status','Created By'
            ].map(h => `<th>${escHtml(h)}</th>`).join('') + '</tr>';

            rows.forEach(r => {
                html += '<tr>' + [
                    r.paymentDate, r.bookingNo, r.guest, r.roomType, r.billingHead, r.taxableValue, r.cgst, r.sgst, r.gst,
                    r.paidAmount, r.bookingStatus, r.paymentStatus, r.createdBy
                ].map(v => `<td>${escHtml(v)}</td>`).join('') + '</tr>';
            });

            html += '</table>';
            const content = `<!doctype html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
            const from = document.getElementById('fromDate')?.value || '';
            const to = document.getElementById('toDate')?.value || '';
            downloadBlob(new Blob([content], { type: 'application/vnd.ms-excel;charset=utf-8;' }), `GSTReport_${from}_${to}.xls`);
        };

        const exportGstToPdf = () => {
            const rows = getGstExportRows();
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('PDF export library failed to load. Please refresh and try again.');
                return;
            }

            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            const from = document.getElementById('fromDate')?.value || '';
            const to = document.getElementById('toDate')?.value || '';

            doc.setFontSize(14);
            doc.text(`GST Report (${from} to ${to})`, 40, 40);

            const autoTableFn = doc.autoTable || (jsPDF.API && jsPDF.API.autoTable);
            if (!autoTableFn) {
                alert('PDF table plugin failed to load. Please refresh and try again.');
                return;
            }

            (doc.autoTable || autoTableFn).call(doc, {
                startY: 60,
                head: [[
                    'Payment Date','Booking No','Guest','Room Type','Billing Head','Taxable Value','CGST','SGST','GST','Paid Amount','Booking Status','Payment Status','Created By'
                ]],
                body: rows.map(r => [
                    r.paymentDate, r.bookingNo, r.guest, r.roomType, r.billingHead, r.taxableValue, r.cgst, r.sgst, r.gst,
                    r.paidAmount, r.bookingStatus, r.paymentStatus, r.createdBy
                ]),
                styles: { fontSize: 8 },
                headStyles: { fillColor: [15, 23, 42] }
            });

            doc.save(`GSTReport_${from}_${to}.pdf`);
        };
    </script>
}
