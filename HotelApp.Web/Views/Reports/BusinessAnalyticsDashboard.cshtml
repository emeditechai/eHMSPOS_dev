@model HotelApp.Web.ViewModels.BusinessAnalyticsDashboardViewModel
@{
    ViewData["Title"] = "Business Analytics Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/room-dashboard.css" asp-append-version="true" />
}

<div class="page-header">
    <h2><i class="fas fa-chart-line"></i> Business Analytics Dashboard</h2>
</div>

<div class="filters-container" style="margin-bottom: 18px;">
    <form method="get" action="@Url.Action("BusinessAnalyticsDashboard", "Reports")" style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content: space-between;">
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
            <div>
                <label for="fromDate" style="display:block; font-weight:700; color:#1f2937; margin-bottom:6px;">From Date</label>
                <input id="fromDate" name="fromDate" type="date" class="form-control" value="@Model.FromDate.ToString("yyyy-MM-dd")" />
            </div>

            <div>
                <label for="toDate" style="display:block; font-weight:700; color:#1f2937; margin-bottom:6px;">To Date</label>
                <input id="toDate" name="toDate" type="date" class="form-control" value="@Model.ToDate.ToString("yyyy-MM-dd")" />
            </div>
        </div>

        <div style="display:flex; gap:10px; align-items:flex-end;">
            <button class="btn-filter-apply" type="submit">
                <i class="fas fa-filter"></i> Apply
            </button>
            <a class="btn-filter-clear" href="@Url.Action("BusinessAnalyticsDashboard", "Reports")">
                <i class="fas fa-undo"></i> Reset
            </a>
        </div>
    </form>
</div>

<div class="status-cards booking-status-cards" style="margin-bottom: 26px;">
    <div class="status-card available">
        <h3>Total Bookings</h3>
        <div class="value">@Model.Summary.TotalBookings</div>
    </div>

    <div class="status-card occupied">
        <h3>Room Revenue</h3>
        <div class="value">₹@Model.Summary.TotalRoomRevenue.ToString("N0")</div>
    </div>

    <div class="status-card maintenance">
        <h3>ADR</h3>
        <div class="value">₹@Model.Summary.Adr.ToString("N2")</div>
    </div>

    <div class="status-card cleaning">
        <h3>RevPAR</h3>
        <div class="value">₹@Model.Summary.RevPar.ToString("N2")</div>
    </div>

    <div class="status-card occupied">
        <h3>Total Collected</h3>
        <div class="value">₹@Model.Summary.TotalCollected.ToString("N0")</div>
    </div>

    <div class="status-card maintenance">
        <h3>Occupancy</h3>
        <div class="value">@Model.Summary.OccupancyPercent.ToString("N2")%</div>
    </div>

    <div class="status-card cleaning">
        <h3>Outstanding Balance</h3>
        <div class="value">₹@Model.Summary.TotalBalance.ToString("N0")</div>
    </div>
</div>

<div class="filters-container" style="margin-bottom: 18px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
        <div>
            <div style="font-weight:700; color:#1f2937;">Daily Trend</div>
            <div class="subtext" style="margin-top:4px;">
                @Model.Summary.TotalDays days • Rooms: @Model.Summary.TotalRooms • Sold nights: @Model.Summary.SoldRoomNights / @Model.Summary.AvailableRoomNights • Room Rev: ₹@Model.Summary.TotalRoomRevenue.ToString("N0") • ADR: ₹@Model.Summary.Adr.ToString("N2") • RevPAR: ₹@Model.Summary.RevPar.ToString("N2") • GST: ₹@Model.Summary.TotalGST.ToString("N0")
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-filter-apply" type="button" title="Export CSV" onclick="exportDashboardToCsv()"><i class="fas fa-file-export"></i> CSV</button>
            <button class="btn-filter-apply" type="button" title="Export Excel" onclick="exportDashboardToExcel()"><i class="fas fa-file-export"></i> Excel</button>
            <button class="btn-filter-apply" type="button" title="Export PDF" onclick="exportDashboardToPdf()"><i class="fas fa-file-export"></i> PDF</button>
        </div>
    </div>
</div>

<div class="table-container" style="overflow: visible; margin-bottom: 22px;">
    <table class="data-table" id="businessDashboardDailyTable">
        <thead>
            <tr>
                <th>Date</th>
                <th class="text-end">Bookings</th>
                <th class="text-end">Sold Nights</th>
                <th class="text-end">Occupancy %</th>
                <th class="text-end">Room Revenue</th>
                <th class="text-end">ADR</th>
                <th class="text-end">RevPAR</th>
                <th class="text-end">Receipts</th>
                <th class="text-end">Collected</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var row in Model.Daily)
        {
            <tr>
                <td>@row.ReportDate.ToString("dd MMM yyyy")</td>
                <td class="text-end">@row.TotalBookings</td>
                <td class="text-end">@row.SoldRoomNights</td>
                <td class="text-end">@row.OccupancyPercent.ToString("N2")%</td>
                <td class="text-end">₹@row.RoomRevenue.ToString("N2")</td>
                <td class="text-end">₹@row.Adr.ToString("N2")</td>
                <td class="text-end">₹@row.RevPar.ToString("N2")</td>
                <td class="text-end">@row.ReceiptCount</td>
                <td class="text-end">₹@row.CollectedAmount.ToString("N2")</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<div class="filters-container" style="margin-bottom: 12px;">
    <div style="display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: space-between;">
        <div>
            <div style="font-weight:700; color:#1f2937;">Payment Method Summary</div>
            <div class="subtext" style="margin-top:4px;">@Model.PaymentMethods.Count rows</div>
        </div>
    </div>
</div>

<div class="table-container" style="overflow: visible;">
    <table class="data-table" id="businessDashboardMethodTable">
        <thead>
            <tr>
                <th>Payment Method</th>
                <th class="text-end">Receipts</th>
                <th class="text-end">Collected</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var row in Model.PaymentMethods)
        {
            <tr>
                <td>@(string.IsNullOrWhiteSpace(row.PaymentMethod) ? "Unknown" : row.PaymentMethod)</td>
                <td class="text-end">@row.ReceiptCount</td>
                <td class="text-end">₹@row.CollectedAmount.ToString("N2")</td>
            </tr>
        }
        </tbody>
    </table>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const downloadBlob = (blob, filename) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        };

        const getDailyRows = () => {
            const table = document.getElementById('businessDashboardDailyTable');
            const bodyRows = Array.from(table.querySelectorAll('tbody tr'))
                .filter(tr => tr.style.display !== 'none');
            return bodyRows.map(tr => {
                const tds = Array.from(tr.querySelectorAll('td'));
                return {
                    date: (tds[0]?.innerText || '').trim(),
                    bookings: (tds[1]?.innerText || '').trim(),
                    soldNights: (tds[2]?.innerText || '').trim(),
                    occupancy: (tds[3]?.innerText || '').trim(),
                    roomRevenue: (tds[4]?.innerText || '').trim(),
                    adr: (tds[5]?.innerText || '').trim(),
                    revpar: (tds[6]?.innerText || '').trim(),
                    receipts: (tds[7]?.innerText || '').trim(),
                    collected: (tds[8]?.innerText || '').trim(),
                };
            });
        };

        const getMethodRows = () => {
            const table = document.getElementById('businessDashboardMethodTable');
            const bodyRows = Array.from(table.querySelectorAll('tbody tr'))
                .filter(tr => tr.style.display !== 'none');
            return bodyRows.map(tr => {
                const tds = Array.from(tr.querySelectorAll('td'));
                return {
                    method: (tds[0]?.innerText || '').trim(),
                    receipts: (tds[1]?.innerText || '').trim(),
                    collected: (tds[2]?.innerText || '').trim(),
                };
            });
        };

        const exportDashboardToCsv = () => {
            const daily = getDailyRows();
            const methods = getMethodRows();

            const escape = (v) => {
                const s = String(v ?? '');
                if (/[^\S\r\n]*[\n\r,\"]/g.test(s) || /[\n\r,\"]/g.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };

            const lines = [];
            lines.push('Daily Trend');
            lines.push(['Date','Bookings','Sold Nights','Occupancy %','Room Revenue','ADR','RevPAR','Receipts','Collected'].map(escape).join(','));
            daily.forEach(r => {
                lines.push([r.date, r.bookings, r.soldNights, r.occupancy, r.roomRevenue, r.adr, r.revpar, r.receipts, r.collected].map(escape).join(','));
            });

            lines.push('');
            lines.push('Payment Method Summary');
            lines.push(['Payment Method','Receipts','Collected'].map(escape).join(','));
            methods.forEach(r => {
                lines.push([r.method, r.receipts, r.collected].map(escape).join(','));
            });

            const from = document.getElementById('fromDate')?.value || '';
            const to = document.getElementById('toDate')?.value || '';
            const csv = '\uFEFF' + lines.join('\n');
            downloadBlob(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), `BusinessAnalytics_${from}_${to}.csv`);
        };

        const exportDashboardToExcel = () => {
            const daily = getDailyRows();
            const methods = getMethodRows();
            const escHtml = (s) => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            let html = '<table border="1">';
            html += '<tr><th colspan="9">Daily Trend</th></tr>';
            html += '<tr>' + ['Date','Bookings','Sold Nights','Occupancy %','Room Revenue','ADR','RevPAR','Receipts','Collected'].map(h => `<th>${escHtml(h)}</th>`).join('') + '</tr>';
            daily.forEach(r => {
                html += '<tr>' + [r.date, r.bookings, r.soldNights, r.occupancy, r.roomRevenue, r.adr, r.revpar, r.receipts, r.collected].map(v => `<td>${escHtml(v)}</td>`).join('') + '</tr>';
            });

            html += '<tr><td colspan="9">&nbsp;</td></tr>';
            html += '<tr><th colspan="3">Payment Method Summary</th></tr>';
            html += '<tr>' + ['Payment Method','Receipts','Collected'].map(h => `<th>${escHtml(h)}</th>`).join('') + '</tr>';
            methods.forEach(r => {
                html += '<tr>' + [r.method, r.receipts, r.collected].map(v => `<td>${escHtml(v)}</td>`).join('') + '</tr>';
            });

            html += '</table>';

            const content = `<!doctype html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
            const from = document.getElementById('fromDate')?.value || '';
            const to = document.getElementById('toDate')?.value || '';
            downloadBlob(new Blob([content], { type: 'application/vnd.ms-excel;charset=utf-8;' }), `BusinessAnalytics_${from}_${to}.xls`);
        };

        const exportDashboardToPdf = () => {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('PDF export library failed to load. Please refresh and try again.');
                return;
            }

            const from = document.getElementById('fromDate')?.value || '';
            const to = document.getElementById('toDate')?.value || '';
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Business Analytics (${from} to ${to})`, 40, 40);

            const daily = getDailyRows();
            const autoTableFn = doc.autoTable || (jsPDF.API && jsPDF.API.autoTable);
            if (!autoTableFn) {
                alert('PDF table plugin failed to load. Please refresh and try again.');
                return;
            }

            (doc.autoTable || autoTableFn).call(doc, {
                startY: 60,
                head: [[ 'Date','Bookings','Sold Nights','Occupancy %','Room Revenue','ADR','RevPAR','Receipts','Collected' ]],
                body: daily.map(r => [r.date, r.bookings, r.soldNights, r.occupancy, r.roomRevenue, r.adr, r.revpar, r.receipts, r.collected]),
                styles: { fontSize: 8 },
                headStyles: { fillColor: [15, 23, 42] }
            });

            const afterY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? (doc.lastAutoTable.finalY + 20) : 320;
            const methods = getMethodRows();

            (doc.autoTable || autoTableFn).call(doc, {
                startY: afterY,
                head: [[ 'Payment Method','Receipts','Collected' ]],
                body: methods.map(r => [r.method, r.receipts, r.collected]),
                styles: { fontSize: 8 },
                headStyles: { fillColor: [15, 23, 42] }
            });

            doc.save(`BusinessAnalytics_${from}_${to}.pdf`);
        };
    </script>
}
